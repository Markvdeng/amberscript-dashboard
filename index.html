<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amberscript Marketing Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            as: {
              primary: '#1A7B6B',
              hover: '#155F54',
              accent: '#F5A623',
              bg: '#F5F5F5',
              border: '#E0E0E0',
              text: '#1A1A1A',
              secondary: '#666666',
              muted: '#999999',
              success: '#2E7D32',
              purple: '#7B1FA2',
            }
          },
          fontFamily: {
            sans: ['"DM Sans"', 'system-ui', 'sans-serif'],
          },
          borderRadius: { card: '8px' },
        }
      }
    }
  </script>
  <style>
    body { background: #F5F5F5; color: #1A1A1A; }
    .card { background: #fff; border: 1px solid #E0E0E0; border-radius: 8px; padding: 24px; }
    .kpi-card { transition: transform 0.15s ease, border-color 0.15s ease; }
    .kpi-card:hover { transform: translateY(-2px); border-color: #1A7B6B; }
    .chart-container { position: relative; min-height: 280px; }
    .funnel-bar { transition: width 0.6s ease; }
    .section-title { font-size: 1.25rem; font-weight: 500; color: #1A1A1A; border-bottom: 2px solid #1A7B6B; padding-bottom: 8px; margin-bottom: 24px; }
    .sub-title { font-size: 1rem; font-weight: 500; color: #666666; margin-bottom: 16px; }
    .hidden { display: none !important; }
    .toggle-btn { padding: 4px 12px; font-size: 0.8125rem; font-weight: 500; border: 1px solid #E0E0E0; cursor: pointer; color: #666; background: #fff; }
    .toggle-btn:first-child { border-radius: 6px 0 0 6px; }
    .toggle-btn:last-child { border-radius: 0 6px 6px 0; }
    .toggle-btn.active { background: #1A7B6B; color: #fff; border-color: #1A7B6B; }
    th { color: #999999; font-weight: 500; font-size: 0.8125rem; }
    td { font-size: 0.8125rem; }
    select { font-size: 0.875rem; }
  </style>
</head>
<body class="font-sans">

  <!-- Header -->
  <header class="bg-as-primary text-white">
    <div class="max-w-7xl mx-auto px-4 py-5 sm:px-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
      <div>
        <h1 class="text-xl font-medium tracking-tight">Amberscript Marketing Dashboard</h1>
        <p class="text-white/60 text-xs mt-1" id="lastUpdated">Loading...</p>
      </div>
      <div class="flex items-center gap-3">
        <select id="buFilter" class="bg-white/10 border border-white/20 text-white rounded-card px-3 py-1.5 text-sm">
          <option value="all">All Business Units</option>
          <option value="Transcription">Transcription (BUT)</option>
          <option value="Media">Media (BUM)</option>
          <option value="Innovations">Innovations (BUNS)</option>
        </select>
        <select id="dateRange" class="bg-white/10 border border-white/20 text-white rounded-card px-3 py-1.5 text-sm">
          <option value="this-week">This week</option>
          <option value="last-week">Last week</option>
          <option value="last-2-weeks">Last 2 weeks</option>
          <option value="last-4-weeks" selected>Last 4 weeks</option>
          <option value="this-month">This month</option>
          <option value="last-month">Last month</option>
          <option value="last-2-months">Last 2 months</option>
          <option value="last-4-months">Last 4 months</option>
          <option value="all">All time</option>
        </select>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8 space-y-10">

    <!-- ============================================ -->
    <!-- TRANSCRIPTION & MEDIA                        -->
    <!-- ============================================ -->
    <div>
      <h2 class="section-title">Transcription & Media</h2>

      <!-- ---- Inbound (HubSpot) ---- -->
      <div class="mb-10">
        <h3 class="sub-title">Inbound</h3>

        <!-- Inbound Summary -->
        <section class="card mb-6">
          <div class="flex items-center justify-between mb-4">
            <h4 class="text-sm font-medium text-as-secondary">Summary</h4>
            <div class="flex" id="inboundSummaryToggle">
              <button class="toggle-btn active" data-view="monthly" onclick="toggleInboundSummary('monthly')">Monthly</button>
              <button class="toggle-btn" data-view="weekly" onclick="toggleInboundSummary('weekly')">Weekly</button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="text-left border-b border-as-border"><tr id="inboundSummaryHead"></tr></thead>
              <tbody id="inboundSummaryBody"></tbody>
            </table>
          </div>
        </section>

        <!-- Filters -->
        <div class="flex flex-wrap items-center gap-3 mb-5" id="inboundFilters">
          <select id="inbProductFilter" class="border border-as-border rounded-card px-3 py-1.5 text-sm bg-white text-as-text" onchange="onInboundFilterChange()">
            <option value="all">All Products</option>
          </select>
          <select id="inbStyleFilter" class="border border-as-border rounded-card px-3 py-1.5 text-sm bg-white text-as-text hidden" onchange="onInboundFilterChange()">
            <option value="all">All Styles</option>
          </select>
          <select id="inbOptionsFilter" class="border border-as-border rounded-card px-3 py-1.5 text-sm bg-white text-as-text hidden" onchange="onInboundFilterChange()">
            <option value="all">All Options</option>
          </select>
          <select id="inbCountryFilter" class="border border-as-border rounded-card px-3 py-1.5 text-sm bg-white text-as-text" onchange="onInboundFilterChange()">
            <option value="all">All Countries</option>
            <option value="DACH">DACH (DE+AT+CH)</option>
          </select>
        </div>

        <!-- KPIs -->
        <div id="inboundKPIs" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 mb-6"></div>

        <!-- Funnel -->
        <div class="card mb-6">
          <h4 class="text-sm font-medium text-as-secondary mb-3">Sales Funnel</h4>
          <div id="funnelChart" class="space-y-3"></div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card">
            <h4 class="text-sm font-medium text-as-secondary mb-3">Weekly Funnel Trend</h4>
            <div class="chart-container"><canvas id="funnelTrendChart"></canvas></div>
          </div>
          <div class="card">
            <h4 class="text-sm font-medium text-as-secondary mb-3">MQLs by Channel</h4>
            <div class="chart-container"><canvas id="channelChart"></canvas></div>
          </div>
        </div>

        <!-- Breakdown Tables -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
          <div class="card">
            <h4 class="text-sm font-medium text-as-secondary mb-3">By Product</h4>
            <div class="overflow-x-auto">
              <table id="productTable" class="w-full">
                <thead class="text-left border-b border-as-border">
                  <tr>
                    <th class="pb-2">Product</th>
                    <th class="pb-2 text-right">MQLs</th>
                    <th class="pb-2 text-right">SQLs</th>
                    <th class="pb-2 text-right">Won</th>
                    <th class="pb-2 text-right">Revenue</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div class="card">
            <h4 class="text-sm font-medium text-as-secondary mb-3">By Deal Owner</h4>
            <div class="overflow-x-auto">
              <table id="ownerTable" class="w-full">
                <thead class="text-left border-b border-as-border">
                  <tr>
                    <th class="pb-2">Owner</th>
                    <th class="pb-2 text-right">MQLs</th>
                    <th class="pb-2 text-right">SQLs</th>
                    <th class="pb-2 text-right">Won</th>
                    <th class="pb-2 text-right">Revenue</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div class="card">
            <h4 class="text-sm font-medium text-as-secondary mb-3">By Country</h4>
            <div class="overflow-x-auto">
              <table id="geoTable" class="w-full">
                <thead class="text-left border-b border-as-border">
                  <tr>
                    <th class="pb-2">Country</th>
                    <th class="pb-2 text-right">MQLs</th>
                    <th class="pb-2 text-right">SQLs</th>
                    <th class="pb-2 text-right">Won</th>
                    <th class="pb-2 text-right">Revenue</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ---- Self-Serve (Stripe) ---- -->
      <div id="selfServeSection">
        <h3 class="sub-title">Self-Serve</h3>

        <!-- Self-Serve Summary -->
        <section class="card mb-6">
          <div class="flex items-center justify-between mb-4">
            <h4 class="text-sm font-medium text-as-secondary">Summary</h4>
            <div class="flex" id="selfServeSummaryToggle">
              <button class="toggle-btn active" data-view="monthly" onclick="toggleSelfServeSummary('monthly')">Monthly</button>
              <button class="toggle-btn" data-view="weekly" onclick="toggleSelfServeSummary('weekly')">Weekly</button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="text-left border-b border-as-border"><tr id="selfServeSummaryHead"></tr></thead>
              <tbody id="selfServeSummaryBody"></tbody>
            </table>
          </div>
        </section>

        <!-- Filters -->
        <div class="flex flex-wrap items-center gap-3 mb-5" id="selfServeFilters">
          <select id="filterProduct" class="border border-as-border rounded-card px-3 py-1.5 text-sm bg-white text-as-text" onchange="onFilterChange()">
            <option value="all">All</option>
            <option value="mm">Machine-Made</option>
            <option value="hm">Human-Made</option>
            <option value="inv">Invoice</option>
          </select>
          <select id="filterPlanType" class="border border-as-border rounded-card px-3 py-1.5 text-sm bg-white text-as-text" onchange="onFilterChange()">
            <option value="all">All Types</option>
            <option value="prepaid">Prepaid</option>
            <option value="sub">Subscription</option>
          </select>
          <select id="filterSubtype" class="border border-as-border rounded-card px-3 py-1.5 text-sm bg-white text-as-text hidden" onchange="onFilterChange()">
          </select>
        </div>

        <!-- KPIs -->
        <div id="selfServeKPIs" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6"></div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card">
            <h4 class="text-sm font-medium text-as-secondary mb-3">Revenue Trend</h4>
            <div class="chart-container"><canvas id="selfServeRevenueChart"></canvas></div>
          </div>
          <div class="card">
            <h4 class="text-sm font-medium text-as-secondary mb-3">Revenue by Channel</h4>
            <div class="chart-container"><canvas id="selfServeChannelChart"></canvas></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- GOOGLE ADS                                   -->
    <!-- ============================================ -->
    <div>
      <h2 class="section-title">Google Ads</h2>

      <div id="adsKPIs" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6"></div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card">
          <h4 class="text-sm font-medium text-as-secondary mb-3">Ad Spend: Machine-Made vs Human-Made</h4>
          <div class="chart-container"><canvas id="mmVsHmChart"></canvas></div>
        </div>
        <div class="card">
          <h4 class="text-sm font-medium text-as-secondary mb-3">Ad Spend by Product</h4>
          <div class="chart-container"><canvas id="adProductChart"></canvas></div>
        </div>
      </div>
    </div>

  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 py-8 text-center text-as-muted text-xs">
    Auto-updated daily via GitHub Actions. Data from Google Ads, HubSpot, Stripe, GA4.
  </footer>

<script>
let DATA = null;
let charts = {};
let inboundSummaryView = 'monthly';
let selfServeSummaryView = 'monthly';

const CHANNEL_COLORS = {
  'Direct': '#1A7B6B', 'Paid Search': '#005a50', 'Organic Search': '#2E7D32',
  'Referral': '#F5A623', 'Email': '#E69100', 'Subscription': '#7B1FA2',
  'Unknown': '#999999', 'Organic Video': '#0061FF', 'Affiliates': '#155F54',
  'Organic Social': '#E65100', 'Cross-network': '#5C6BC0', 'Unassigned': '#E0E0E0',
};

const fmt = {
  currency: (n) => new Intl.NumberFormat('en-EU', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n),
  number: (n) => new Intl.NumberFormat('en-US').format(n),
  pct: (n) => n.toFixed(1) + '%',
  shortDate: (d) => {
    const date = new Date(d + 'T00:00:00');
    return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
  },
  monthLabel: (m) => {
    const [y, mo] = m.split('-');
    return new Date(parseInt(y), parseInt(mo) - 1).toLocaleDateString('en-GB', { month: 'short', year: '2-digit' });
  },
};

// ===== DATA LOADING =====
async function loadData() {
  try {
    const res = await fetch('data.json');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    DATA = await res.json();
    render();
  } catch (err) {
    document.getElementById('lastUpdated').textContent = 'Error loading data: ' + err.message;
  }
}

// ===== DATE FILTERING =====
function getFilteredWeeks() {
  const mode = document.getElementById('dateRange').value;
  const allWeeks = DATA.weekly.ads.map(r => r.week).filter(Boolean);
  if (!allWeeks.length || mode === 'all') return allWeeks;

  const today = new Date();
  const dayOfWeek = today.getUTCDay() || 7;
  const thisMonday = new Date(today);
  thisMonday.setUTCDate(today.getUTCDate() - dayOfWeek + 1);
  const thisMondayStr = thisMonday.toISOString().slice(0, 10);
  const firstOfMonth = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), 1));

  if (mode === 'this-week') return allWeeks.filter(w => w >= thisMondayStr);
  if (mode === 'last-week') { const s = new Date(thisMonday); s.setUTCDate(s.getUTCDate()-7); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < thisMondayStr); }
  if (mode === 'last-2-weeks') { const s = new Date(thisMonday); s.setUTCDate(s.getUTCDate()-14); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < thisMondayStr); }
  if (mode === 'last-4-weeks') { const s = new Date(thisMonday); s.setUTCDate(s.getUTCDate()-28); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < thisMondayStr); }
  if (mode === 'this-month') return allWeeks.filter(w => w >= firstOfMonth.toISOString().slice(0,10));
  if (mode === 'last-month') { const s = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth()-1, 1)); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < firstOfMonth.toISOString().slice(0,10)); }
  if (mode === 'last-2-months') { const s = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth()-2, 1)); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < firstOfMonth.toISOString().slice(0,10)); }
  if (mode === 'last-4-months') { const s = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth()-4, 1)); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < firstOfMonth.toISOString().slice(0,10)); }
  return allWeeks;
}

function filterByWeeks(arr, weeks) {
  const set = new Set(weeks);
  return arr.filter(r => set.has(r.week));
}

// ===== BUSINESS UNIT =====
function getCurrentBU() {
  return document.getElementById('buFilter').value;
}

function getBU(product) {
  if (!product) return 'Transcription';
  const media = ['Human-Made Subtitles', 'Machine-Made Subtitles', 'Translated Subtitles', 'Translations', 'Subtitles'];
  const innovations = ['Amber Notes', 'AI Meeting Notes', 'Meeting Notes'];
  if (media.includes(product)) return 'Media';
  if (innovations.includes(product)) return 'Innovations';
  return 'Transcription';
}

// ===== INTERACTIONS =====
function getSegmentKey() {
  const product = document.getElementById('filterProduct').value;
  const planType = document.getElementById('filterPlanType').value;
  const subtype = document.getElementById('filterSubtype').value || 'all';
  return `${product}.${planType}.${subtype}`;
}

function onFilterChange() {
  const product = document.getElementById('filterProduct').value;
  const planTypeEl = document.getElementById('filterPlanType');
  const subtypeEl = document.getElementById('filterSubtype');

  // Show/hide plan type dropdown
  if (product === 'hm' || product === 'inv') {
    planTypeEl.classList.add('hidden');
    planTypeEl.value = 'all';
    subtypeEl.classList.add('hidden');
    subtypeEl.value = 'all';
  } else {
    planTypeEl.classList.remove('hidden');
  }

  // Show/hide and populate subtype dropdown
  const planType = planTypeEl.value;
  if (planType === 'prepaid') {
    subtypeEl.innerHTML = '<option value="all">All Prepaid</option><option value="topup">Top-Up</option><option value="job">Job Creation</option>';
    subtypeEl.classList.remove('hidden');
  } else if (planType === 'sub') {
    subtypeEl.innerHTML = '<option value="all">All Subscriptions</option><option value="update">Update</option><option value="creation">Creation</option>';
    subtypeEl.classList.remove('hidden');
  } else {
    subtypeEl.classList.add('hidden');
    subtypeEl.value = 'all';
  }

  renderSelfServe(getFilteredWeeks());
}

function toggleInboundSummary(view) {
  inboundSummaryView = view;
  document.querySelectorAll('#inboundSummaryToggle .toggle-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.view === view);
  });
  renderInboundSummary(getFilteredWeeks());
}

function toggleSelfServeSummary(view) {
  selfServeSummaryView = view;
  document.querySelectorAll('#selfServeSummaryToggle .toggle-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.view === view);
  });
  renderSelfServeSummary(getFilteredWeeks());
}

// ===== MAIN RENDER =====
function render() {
  const weeks = getFilteredWeeks();
  const bu = getCurrentBU();
  document.getElementById('lastUpdated').textContent =
    `Last updated: ${new Date(DATA.updatedAt).toLocaleString('en-GB')} | ${DATA.dateRange.start} to ${DATA.dateRange.end}`;

  // Self-Serve is Transcription only (all Stripe is self-serve transcription)
  const showSelfServe = bu === 'all' || bu === 'Transcription';
  document.getElementById('selfServeSection').classList.toggle('hidden', !showSelfServe);

  populateInboundFilters();
  renderInboundSummary(weeks);
  if (showSelfServe) {
    renderSelfServeSummary(weeks);
    renderSelfServe(weeks);
  }
  renderInbound(weeks);
  renderGoogleAds(weeks);
}

// ===== INBOUND SUMMARY =====
function renderInboundSummary(weeks) {
  const bu = getCurrentBU();
  const head = document.getElementById('inboundSummaryHead');
  const body = document.getElementById('inboundSummaryBody');
  const allDeals = DATA.deals || [];
  const allForms = DATA.ga4Forms || [];
  const ads = filterByWeeks(DATA.weekly.ads, weeks);
  const adsMap = Object.fromEntries(ads.map(r => [r.week, r]));

  // Helper: get HM cost for a set of weeks, respecting BU filter
  function getHmCost(weekList) {
    let cost = 0;
    for (const w of weekList) {
      const a = adsMap[w];
      if (!a) continue;
      cost += bu === 'all' ? (a.hmCost || 0) : (a.byBU?.[bu]?.hmCost || 0);
    }
    return cost;
  }

  // Helper: compute funnel from deals + forms for a set of weeks
  function computeFunnel(weekList) {
    const ws = new Set(weekList);
    const deals = allDeals.filter(d => ws.has(d.week) && (bu === 'all' || d.bu === bu));
    const forms = (bu === 'all' || bu === 'Transcription')
      ? allForms.filter(f => ws.has(f.week))
      : [];
    const leads = forms.reduce((s, r) => s + r.count, 0);
    const mqls = deals.length;
    const mqlsFL = deals.filter(d => d.formId).length;
    const sqls = deals.filter(d => ['SQL', 'Customer'].includes(d.lifecycleStage)).length;
    const sqlsFL = deals.filter(d => d.formId && ['SQL', 'Customer'].includes(d.lifecycleStage)).length;
    const won = deals.filter(d => d.status === 'Won').length;
    const wonRev = deals.filter(d => d.status === 'Won').reduce((s, d) => s + (d.amount || 0), 0);
    return { leads, mqls, mqlsFL, sqls, sqlsFL, won, wonRev };
  }

  if (inboundSummaryView === 'monthly') {
    const allMonths = [...new Set(weeks.map(w => w.slice(0, 7)))].sort();
    head.innerHTML = `
      <th class="pb-2">Month</th>
      <th class="pb-2 text-right">HM Spend</th>
      <th class="pb-2 text-right">Leads</th>
      <th class="pb-2 text-right">MQLs</th>
      <th class="pb-2 text-right">from Leads</th>
      <th class="pb-2 text-right">SQLs</th>
      <th class="pb-2 text-right">from Leads</th>
      <th class="pb-2 text-right">Won</th>
      <th class="pb-2 text-right">Revenue</th>
      <th class="pb-2 text-right">L>MQL</th>
      <th class="pb-2 text-right">MQL>SQL</th>
      <th class="pb-2 text-right">SQL>Won</th>
    `;
    body.innerHTML = allMonths.map(month => {
      const monthWeeks = weeks.filter(w => w.slice(0, 7) === month);
      const hmCost = getHmCost(monthWeeks);
      const f = computeFunnel(monthWeeks);
      const l2m = f.leads > 0 ? (f.mqlsFL / f.leads * 100).toFixed(1) + '%' : '-';
      const m2s = f.mqls > 0 ? (f.sqls / f.mqls * 100).toFixed(1) + '%' : '-';
      const s2w = f.sqls > 0 ? (f.won / f.sqls * 100).toFixed(1) + '%' : '-';
      return `<tr class="border-b border-as-border/30 hover:bg-as-bg">
        <td class="py-2 font-medium">${fmt.monthLabel(month)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.currency(hmCost)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(f.leads)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(f.mqls)}</td>
        <td class="py-2 text-right text-as-muted">${fmt.number(f.mqlsFL)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(f.sqls)}</td>
        <td class="py-2 text-right text-as-muted">${fmt.number(f.sqlsFL)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(f.won)}</td>
        <td class="py-2 text-right font-medium">${fmt.currency(f.wonRev)}</td>
        <td class="py-2 text-right text-as-secondary">${l2m}</td>
        <td class="py-2 text-right text-as-secondary">${m2s}</td>
        <td class="py-2 text-right text-as-secondary">${s2w}</td>
      </tr>`;
    }).join('');
  } else {
    head.innerHTML = `
      <th class="pb-2">Week</th>
      <th class="pb-2 text-right">HM Spend</th>
      <th class="pb-2 text-right">Leads</th>
      <th class="pb-2 text-right">MQLs</th>
      <th class="pb-2 text-right">from Leads</th>
      <th class="pb-2 text-right">SQLs</th>
      <th class="pb-2 text-right">from Leads</th>
      <th class="pb-2 text-right">Won</th>
      <th class="pb-2 text-right">Revenue</th>
    `;
    body.innerHTML = weeks.map(w => {
      const hmCost = getHmCost([w]);
      const f = computeFunnel([w]);
      return `<tr class="border-b border-as-border/30 hover:bg-as-bg">
        <td class="py-2 font-medium">${fmt.shortDate(w)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.currency(hmCost)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(f.leads)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(f.mqls)}</td>
        <td class="py-2 text-right text-as-muted">${fmt.number(f.mqlsFL)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(f.sqls)}</td>
        <td class="py-2 text-right text-as-muted">${fmt.number(f.sqlsFL)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(f.won)}</td>
        <td class="py-2 text-right font-medium">${fmt.currency(f.wonRev)}</td>
      </tr>`;
    }).join('');
  }
}

// ===== SELF-SERVE SUMMARY =====
function renderSelfServeSummary(weeks) {
  const bu = getCurrentBU();
  const head = document.getElementById('selfServeSummaryHead');
  const body = document.getElementById('selfServeSummaryBody');

  // Helper: get MM cost for a set of weeks (Transcription BU only for self-serve)
  function getMmCost(weekList, adsMap) {
    let cost = 0;
    for (const w of weekList) {
      const a = adsMap[w];
      if (!a) continue;
      // Self-serve is all Transcription, so use Transcription MM cost when BU=all or Transcription
      cost += (bu === 'all') ? (a.mmCost || 0) : (a.byBU?.Transcription?.mmCost || 0);
    }
    return cost;
  }

  const ads = filterByWeeks(DATA.weekly.ads, weeks);
  const adsMap = Object.fromEntries(ads.map(r => [r.week, r]));

  if (selfServeSummaryView === 'monthly') {
    const allMonths = [...new Set(weeks.map(w => w.slice(0, 7)))].sort();
    head.innerHTML = `
      <th class="pb-2">Month</th>
      <th class="pb-2 text-right">MM Spend</th>
      <th class="pb-2 text-right">Payments</th>
      <th class="pb-2 text-right">Revenue</th>
      <th class="pb-2 text-right">New Subs</th>
      <th class="pb-2 text-right">Active Subs</th>
    `;
    body.innerHTML = allMonths.map(month => {
      const monthWeeks = weeks.filter(w => w.slice(0, 7) === month);
      const mmCost = getMmCost(monthWeeks, adsMap);
      // Aggregate stripe segments for the month
      const stripe = filterByWeeks(DATA.weekly.stripe, monthWeeks);
      let payments = 0, revenue = 0, newSubs = 0;
      for (const s of stripe) {
        const seg = s.seg || {};
        payments += (seg['all.all.all'] || {}).count || 0;
        revenue += (seg['all.all.all'] || {}).revenue || 0;
        newSubs += (seg['all.sub.creation'] || {}).count || 0;
      }
      return `<tr class="border-b border-as-border/30 hover:bg-as-bg">
        <td class="py-2 font-medium">${fmt.monthLabel(month)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.currency(mmCost)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(payments)}</td>
        <td class="py-2 text-right font-medium">${fmt.currency(revenue)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(newSubs)}</td>
        <td class="py-2 text-right text-as-muted">-</td>
      </tr>`;
    }).join('');
  } else {
    head.innerHTML = `
      <th class="pb-2">Week</th>
      <th class="pb-2 text-right">MM Spend</th>
      <th class="pb-2 text-right">Payments</th>
      <th class="pb-2 text-right">Revenue</th>
      <th class="pb-2 text-right">New Subs</th>
    `;
    body.innerHTML = weeks.map(w => {
      const mmCost = getMmCost([w], adsMap);
      const s = filterByWeeks(DATA.weekly.stripe, [w])[0] || {};
      const seg = s.seg || {};
      const payments = (seg['all.all.all'] || {}).count || 0;
      const revenue = (seg['all.all.all'] || {}).revenue || 0;
      const newSubs = (seg['all.sub.creation'] || {}).count || 0;
      return `<tr class="border-b border-as-border/30 hover:bg-as-bg">
        <td class="py-2 font-medium">${fmt.shortDate(w)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.currency(mmCost)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(payments)}</td>
        <td class="py-2 text-right font-medium">${fmt.currency(revenue)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(newSubs)}</td>
      </tr>`;
    }).join('');
  }
}

// ===== SELF-SERVE (Stripe) =====
function renderSelfServe(weeks) {
  const stripe = filterByWeeks(DATA.weekly.stripe, weeks);
  const segKey = getSegmentKey();

  // KPIs from segment
  let totalPayments = 0, totalRevenue = 0, newSubs = 0;
  const product = document.getElementById('filterProduct').value;
  const planType = document.getElementById('filterPlanType').value;
  for (const row of stripe) {
    const seg = row.seg || {};
    const s = seg[segKey] || { count: 0, revenue: 0 };
    totalPayments += s.count;
    totalRevenue += s.revenue;
    // New subs count (within current product filter)
    const subCreationKey = `${product}.sub.creation`;
    if (planType === 'all' || planType === 'sub') {
      newSubs += (seg[subCreationKey] || { count: 0 }).count;
    }
  }

  document.getElementById('selfServeKPIs').innerHTML = [
    { label: 'Payments', value: fmt.number(totalPayments), color: '#1A1A1A' },
    { label: 'Revenue', value: fmt.currency(totalRevenue), color: '#1A7B6B' },
    { label: 'New Subscriptions', value: fmt.number(newSubs), color: '#7B1FA2' },
    { label: 'Active Subscriptions', value: 'Coming soon', color: '#999999' },
  ].map(k => `
    <div class="kpi-card card !p-4">
      <p class="text-xs font-medium uppercase tracking-wide text-as-muted">${k.label}</p>
      <p class="text-lg font-bold mt-1" style="color: ${k.color}">${k.value}</p>
    </div>
  `).join('');

  // Revenue trend
  destroyChart('selfServeRevenueChart');
  charts.selfServeRevenueChart = new Chart(document.getElementById('selfServeRevenueChart'), {
    type: 'bar',
    data: {
      labels: stripe.map(r => fmt.shortDate(r.week)),
      datasets: [{
        label: 'Revenue',
        data: stripe.map(r => (r.seg?.[segKey] || { revenue: 0 }).revenue),
        backgroundColor: '#1A7B6B44',
        borderColor: '#1A7B6B',
        borderWidth: 1,
      }],
    },
    options: chartOptions('EUR'),
  });

  // Revenue by channel (only for "all" filter, uses byChannel)
  destroyChart('selfServeChannelChart');
  const channelTotals = {};
  for (const row of stripe) {
    for (const [ch, data] of Object.entries(row.byChannel || {})) {
      channelTotals[ch] = (channelTotals[ch] || 0) + data.revenue;
    }
  }
  const channels = Object.keys(channelTotals).sort((a, b) => channelTotals[b] - channelTotals[a]);
  charts.selfServeChannelChart = new Chart(document.getElementById('selfServeChannelChart'), {
    type: 'doughnut',
    data: {
      labels: channels,
      datasets: [{
        data: channels.map(c => Math.round(channelTotals[c])),
        backgroundColor: channels.map(c => CHANNEL_COLORS[c] || '#999'),
      }],
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right', labels: { font: { size: 11 } } },
        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${fmt.currency(ctx.raw)}` } },
      },
    },
  });
}

// ===== INBOUND FILTER LOGIC =====
const DACH = ['DE', 'AT', 'CH'];

function matchCountry(dealCountry, filterVal) {
  if (filterVal === 'all') return true;
  if (filterVal === 'DACH') return DACH.includes(dealCountry);
  return dealCountry === filterVal;
}

function populateInboundFilters() {
  if (!DATA.deals) return;
  const deals = DATA.deals;

  // Product dropdown
  const products = [...new Set(deals.map(d => d.product).filter(Boolean))].sort();
  const prodEl = document.getElementById('inbProductFilter');
  prodEl.innerHTML = '<option value="all">All Products</option>' +
    products.map(p => `<option value="${p}">${p}</option>`).join('');

  // Country dropdown (from deal + GA4 forms)
  const dealCountries = deals.map(d => d.country).filter(Boolean);
  const formCountries = (DATA.ga4Forms || []).map(f => f.country).filter(Boolean);
  const countries = [...new Set([...dealCountries, ...formCountries])].sort();
  const countryEl = document.getElementById('inbCountryFilter');
  countryEl.innerHTML = '<option value="all">All Countries</option><option value="DACH">DACH (DE+AT+CH)</option>' +
    countries.map(c => `<option value="${c}">${c}</option>`).join('');
}

function onInboundFilterChange() {
  const product = document.getElementById('inbProductFilter').value;
  const styleEl = document.getElementById('inbStyleFilter');
  const optionsEl = document.getElementById('inbOptionsFilter');

  // Show transcription style only for Human-Made Transcription
  if (product === 'Human-Made Transcription') {
    const styles = [...new Set((DATA.deals || []).map(d => d.transcriptionStyle).filter(Boolean))].sort();
    styleEl.innerHTML = '<option value="all">All Styles</option>' +
      styles.map(s => `<option value="${s}">${s}</option>`).join('');
    styleEl.classList.remove('hidden');
  } else {
    styleEl.classList.add('hidden');
    styleEl.value = 'all';
    optionsEl.classList.add('hidden');
    optionsEl.value = 'all';
  }

  // Show additional options only for Verbatim or Clean-Verbatim
  const style = styleEl.value;
  if (product === 'Human-Made Transcription' && (style === 'Verbatim' || style === 'Clean-Verbatim')) {
    const opts = [...new Set((DATA.deals || []).filter(d =>
      d.product === product && d.transcriptionStyle === style && d.additionalOptions
    ).map(d => d.additionalOptions))].sort();
    if (opts.length > 0) {
      optionsEl.innerHTML = '<option value="all">All Options</option>' +
        opts.map(o => `<option value="${o}">${o}</option>`).join('');
      optionsEl.classList.remove('hidden');
    } else {
      optionsEl.classList.add('hidden');
      optionsEl.value = 'all';
    }
  } else {
    optionsEl.classList.add('hidden');
    optionsEl.value = 'all';
  }

  renderInbound(getFilteredWeeks());
}

function getFilteredDeals(weekSet) {
  const bu = getCurrentBU();
  const product = document.getElementById('inbProductFilter').value;
  const style = document.getElementById('inbStyleFilter').value;
  const options = document.getElementById('inbOptionsFilter').value;
  const country = document.getElementById('inbCountryFilter').value;

  return (DATA.deals || []).filter(d => {
    if (!weekSet.has(d.week)) return false;
    if (bu !== 'all' && d.bu !== bu) return false;
    if (product !== 'all' && d.product !== product) return false;
    if (style !== 'all' && d.transcriptionStyle !== style) return false;
    if (options !== 'all' && d.additionalOptions !== options) return false;
    if (!matchCountry(d.country, country)) return false;
    return true;
  });
}

function getFilteredForms(weekSet) {
  const bu = getCurrentBU();
  // GA4 forms are all Transcription BU (from offerte.amberscript.com)
  if (bu !== 'all' && bu !== 'Transcription') return [];
  const country = document.getElementById('inbCountryFilter').value;
  return (DATA.ga4Forms || []).filter(f => {
    if (!weekSet.has(f.week)) return false;
    if (!matchCountry(f.country, country)) return false;
    return true;
  });
}

// ===== INBOUND (HubSpot + GA4 Leads) =====
function renderInbound(weeks) {
  const weekSet = new Set(weeks);
  const deals = getFilteredDeals(weekSet);
  const forms = getFilteredForms(weekSet);

  // Compute funnel from filtered deals
  const leads = forms.reduce((s, r) => s + r.count, 0);
  const mqls = deals.length;
  const mqlsFromLeads = deals.filter(r => r.formId).length;
  const sqls = deals.filter(r => ['SQL', 'Customer'].includes(r.lifecycleStage)).length;
  const sqlsFromLeads = deals.filter(r => r.formId && ['SQL', 'Customer'].includes(r.lifecycleStage)).length;
  const won = deals.filter(r => r.status === 'Won').length;
  const wonRev = deals.filter(r => r.status === 'Won').reduce((s, r) => s + (r.amount || 0), 0);

  // KPIs
  document.getElementById('inboundKPIs').innerHTML = [
    { label: 'Leads (GA4)', value: fmt.number(leads), color: '#F5A623' },
    { label: 'MQLs', value: `${fmt.number(mqls)} <span class="text-xs text-as-muted font-normal">(${fmt.number(mqlsFromLeads)} from leads)</span>`, color: '#1A7B6B' },
    { label: 'SQLs', value: `${fmt.number(sqls)} <span class="text-xs text-as-muted font-normal">(${fmt.number(sqlsFromLeads)} from leads)</span>`, color: '#7B1FA2' },
    { label: 'Won Deals', value: fmt.number(won), color: '#2E7D32' },
    { label: 'Deal Revenue', value: fmt.currency(wonRev), color: '#2E7D32' },
  ].map(k => `
    <div class="kpi-card card !p-4">
      <p class="text-xs font-medium uppercase tracking-wide text-as-muted">${k.label}</p>
      <p class="text-lg font-bold mt-1" style="color: ${k.color}">${k.value}</p>
    </div>
  `).join('');

  // Funnel bar chart
  const max = Math.max(leads, 1);
  const stages = [
    { label: 'Leads', count: leads, color: '#F5A623', pct: 100 },
    { label: 'MQLs', count: mqls, color: '#1A7B6B', pct: (mqls / max * 100) },
    { label: 'SQLs', count: sqls, color: '#7B1FA2', pct: (sqls / max * 100) },
    { label: 'Won', count: won, color: '#2E7D32', pct: (won / max * 100) },
  ];
  const convRates = [];
  if (leads > 0) convRates.push(`Lead > MQL: ${(mqls/leads*100).toFixed(1)}%`);
  if (mqls > 0) convRates.push(`MQL > SQL: ${(sqls/mqls*100).toFixed(1)}%`);
  if (sqls > 0) convRates.push(`SQL > Won: ${(won/sqls*100).toFixed(1)}%`);

  document.getElementById('funnelChart').innerHTML = stages.map(s => `
    <div class="flex items-center gap-3">
      <span class="text-sm font-medium text-as-secondary w-16">${s.label}</span>
      <div class="flex-1 bg-as-bg rounded-full h-7 overflow-hidden">
        <div class="funnel-bar h-full rounded-full flex items-center px-3" style="width:${Math.max(s.pct,4)}%;background:${s.color}">
          <span class="text-white text-xs font-medium">${fmt.number(s.count)}</span>
        </div>
      </div>
    </div>
  `).join('') + `<div class="flex gap-4 mt-2 text-xs text-as-muted">${convRates.map(r => `<span>${r}</span>`).join('')}</div>`;

  // Funnel trend (group filtered deals + forms by week)
  const dealsByWeek = {};
  const formsByWeek = {};
  for (const d of deals) { (dealsByWeek[d.week] = dealsByWeek[d.week] || []).push(d); }
  for (const f of forms) { (formsByWeek[f.week] = formsByWeek[f.week] || []).push(f); }

  const trendWeeks = weeks.filter(w => dealsByWeek[w] || formsByWeek[w]);
  destroyChart('funnelTrendChart');
  charts.funnelTrendChart = new Chart(document.getElementById('funnelTrendChart'), {
    type: 'line',
    data: {
      labels: trendWeeks.map(w => fmt.shortDate(w)),
      datasets: [
        { label: 'Leads', data: trendWeeks.map(w => (formsByWeek[w] || []).reduce((s, r) => s + r.count, 0)), borderColor: '#F5A623', tension: 0.3, fill: false },
        { label: 'MQLs', data: trendWeeks.map(w => (dealsByWeek[w] || []).length), borderColor: '#1A7B6B', tension: 0.3, fill: false },
        { label: 'SQLs', data: trendWeeks.map(w => (dealsByWeek[w] || []).filter(d => ['SQL','Customer'].includes(d.lifecycleStage)).length), borderColor: '#7B1FA2', tension: 0.3, fill: false },
        { label: 'Won', data: trendWeeks.map(w => (dealsByWeek[w] || []).filter(d => d.status === 'Won').length), borderColor: '#2E7D32', tension: 0.3, fill: false },
      ],
    },
    options: chartOptions(''),
  });

  // Channel chart (MQLs by channel from filtered deals)
  const channelTotals = {};
  for (const d of deals) {
    const ch = d.channel || 'Unknown';
    if (!channelTotals[ch]) channelTotals[ch] = { mqls: 0, sqls: 0, won: 0 };
    channelTotals[ch].mqls++;
    if (['SQL', 'Customer'].includes(d.lifecycleStage)) channelTotals[ch].sqls++;
    if (d.status === 'Won') channelTotals[ch].won++;
  }
  const chKeys = Object.keys(channelTotals).sort((a, b) => channelTotals[b].mqls - channelTotals[a].mqls);
  destroyChart('channelChart');
  charts.channelChart = new Chart(document.getElementById('channelChart'), {
    type: 'bar',
    data: {
      labels: chKeys,
      datasets: [
        { label: 'MQLs', data: chKeys.map(c => channelTotals[c].mqls), backgroundColor: '#1A7B6B99' },
        { label: 'SQLs', data: chKeys.map(c => channelTotals[c].sqls), backgroundColor: '#7B1FA299' },
        { label: 'Won', data: chKeys.map(c => channelTotals[c].won), backgroundColor: '#2E7D3299' },
      ],
    },
    options: chartOptions(''),
  });

  // === BREAKDOWN TABLES ===
  renderBreakdownTable(deals, 'productTable', d => d.product || 'Unknown');
  renderBreakdownTable(deals, 'ownerTable', d => d.ownerName || 'Unknown');
  renderBreakdownTable(deals, 'geoTable', d => d.country || 'Unknown');
}

function renderBreakdownTable(deals, tableId, keyFn) {
  const totals = {};
  for (const d of deals) {
    const key = keyFn(d);
    if (!totals[key]) totals[key] = { mqls: 0, sqls: 0, won: 0, wonRevenue: 0 };
    totals[key].mqls++;
    if (['SQL', 'Customer'].includes(d.lifecycleStage)) totals[key].sqls++;
    if (d.status === 'Won') { totals[key].won++; totals[key].wonRevenue += d.amount || 0; }
  }
  const keys = Object.keys(totals).sort((a, b) => totals[b].mqls - totals[a].mqls);
  document.querySelector(`#${tableId} tbody`).innerHTML = keys.map(k => {
    const d = totals[k];
    return `<tr class="border-b border-as-border/30 hover:bg-as-bg">
      <td class="py-2 font-medium">${k}</td>
      <td class="py-2 text-right text-as-secondary">${fmt.number(d.mqls)}</td>
      <td class="py-2 text-right text-as-secondary">${fmt.number(d.sqls)}</td>
      <td class="py-2 text-right text-as-secondary">${fmt.number(d.won)}</td>
      <td class="py-2 text-right font-medium">${fmt.currency(d.wonRevenue)}</td>
    </tr>`;
  }).join('');
}

// ===== GOOGLE ADS =====
function renderGoogleAds(weeks) {
  const bu = getCurrentBU();
  const ads = filterByWeeks(DATA.weekly.ads, weeks);
  const stripe = filterByWeeks(DATA.weekly.stripe, weeks);

  let totalCost, mmCost, hmCost, brandCost;
  if (bu === 'all') {
    totalCost = ads.reduce((s, r) => s + r.totalCost, 0);
    mmCost = ads.reduce((s, r) => s + r.mmCost, 0);
    hmCost = ads.reduce((s, r) => s + r.hmCost, 0);
    brandCost = ads.reduce((s, r) => s + r.brandCost, 0);
  } else {
    totalCost = ads.reduce((s, r) => s + (r.byBU?.[bu]?.totalCost || 0), 0);
    mmCost = ads.reduce((s, r) => s + (r.byBU?.[bu]?.mmCost || 0), 0);
    hmCost = ads.reduce((s, r) => s + (r.byBU?.[bu]?.hmCost || 0), 0);
    brandCost = ads.reduce((s, r) => s + (r.byBU?.[bu]?.brandCost || 0), 0);
  }

  // ROAS only meaningful for Transcription (all Stripe is self-serve transcription)
  const stripeRev = (bu === 'all' || bu === 'Transcription')
    ? stripe.reduce((s, r) => s + r.totalRevenue, 0) : 0;
  const roas = totalCost > 0 && stripeRev > 0 ? (stripeRev / totalCost).toFixed(1) + 'x' : '-';

  document.getElementById('adsKPIs').innerHTML = [
    { label: 'Total Spend', value: fmt.currency(totalCost), color: '#EF4444' },
    { label: 'ROAS', value: roas, color: '#1A7B6B' },
    { label: 'Machine-Made', value: fmt.currency(mmCost), color: '#1A7B6B' },
    { label: 'Human-Made', value: fmt.currency(hmCost), color: '#7B1FA2' },
  ].map(k => `
    <div class="kpi-card card !p-4">
      <p class="text-xs font-medium uppercase tracking-wide text-as-muted">${k.label}</p>
      <p class="text-lg font-bold mt-1" style="color: ${k.color}">${k.value}</p>
    </div>
  `).join('');

  // MM vs HM stacked chart
  destroyChart('mmVsHmChart');
  charts.mmVsHmChart = new Chart(document.getElementById('mmVsHmChart'), {
    type: 'bar',
    data: {
      labels: ads.map(r => fmt.shortDate(r.week)),
      datasets: [
        { label: 'Machine-Made', data: ads.map(r => bu === 'all' ? r.mmCost : (r.byBU?.[bu]?.mmCost || 0)), backgroundColor: '#1A7B6B44', borderColor: '#1A7B6B', borderWidth: 1 },
        { label: 'Human-Made', data: ads.map(r => bu === 'all' ? r.hmCost : (r.byBU?.[bu]?.hmCost || 0)), backgroundColor: '#7B1FA244', borderColor: '#7B1FA2', borderWidth: 1 },
        { label: 'Brand', data: ads.map(r => bu === 'all' ? r.brandCost : (r.byBU?.[bu]?.brandCost || 0)), backgroundColor: '#F5A62344', borderColor: '#F5A623', borderWidth: 1 },
      ],
    },
    options: { ...chartOptions('EUR'), scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } },
  });

  // By product (filtered by BU)
  const productTotals = {};
  for (const row of ads) {
    for (const [prod, cost] of Object.entries(row.byProduct || {})) {
      if (bu !== 'all' && getBU(prod) !== bu) continue;
      productTotals[prod] = (productTotals[prod] || 0) + cost;
    }
  }
  const products = Object.keys(productTotals).sort((a, b) => productTotals[b] - productTotals[a]);
  const prodColors = ['#1A7B6B', '#F5A623', '#7B1FA2', '#005a50', '#2E7D32', '#E65100', '#0061FF', '#999'];
  destroyChart('adProductChart');
  charts.adProductChart = new Chart(document.getElementById('adProductChart'), {
    type: 'doughnut',
    data: {
      labels: products,
      datasets: [{
        data: products.map(p => Math.round(productTotals[p])),
        backgroundColor: products.map((_, i) => prodColors[i % prodColors.length]),
      }],
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right', labels: { font: { size: 11 } } },
        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${fmt.currency(ctx.raw)}` } },
      },
    },
  });
}

// ===== CHART HELPERS =====
function chartOptions(prefix) {
  return {
    responsive: true, maintainAspectRatio: false,
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: { position: 'top', labels: { usePointStyle: true, pointStyleWidth: 10, font: { size: 11 } } },
      tooltip: {
        callbacks: {
          label: ctx => {
            const val = typeof ctx.raw === 'number' ? (prefix ? `${prefix} ${ctx.raw.toLocaleString()}` : ctx.raw.toLocaleString()) : ctx.raw;
            return `${ctx.dataset.label}: ${val}`;
          },
        },
      },
    },
    scales: {
      x: { grid: { display: false }, ticks: { font: { size: 11 } } },
      y: { beginAtZero: true, grid: { color: '#E0E0E033' }, ticks: { font: { size: 11 } } },
    },
  };
}

function destroyChart(id) {
  if (charts[id]) { charts[id].destroy(); delete charts[id]; }
}

// ===== EVENTS =====
document.getElementById('dateRange').addEventListener('change', () => { if (DATA) render(); });
document.getElementById('buFilter').addEventListener('change', () => { if (DATA) render(); });

loadData();
</script>
</body>
</html>
