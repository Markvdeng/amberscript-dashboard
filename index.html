<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amberscript Marketing Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            as: {
              primary: '#1A7B6B',
              deep: '#005a50',
              hover: '#155F54',
              accent: '#F5A623',
              bg: '#F7F8FA',
              card: '#FFFFFF',
              border: '#E8ECF0',
              text: '#0F1419',
              secondary: '#536471',
              muted: '#8899A6',
              success: '#2E7D32',
              purple: '#7B1FA2',
              red: '#E03E3E',
            }
          },
          fontFamily: {
            sans: ['"Plus Jakarta Sans"', 'system-ui', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <style>
    body { background: #F7F8FA; color: #0F1419; }

    /* Cards */
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06);
      border: 1px solid #E8ECF0;
    }

    /* KPI cards */
    .kpi-card {
      position: relative;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .kpi-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.06);
    }
    .kpi-card::before {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 3px;
      background: var(--kpi-color, #1A7B6B);
      border-radius: 3px 0 0 3px;
    }

    .chart-container { position: relative; min-height: 280px; }
    .funnel-bar { transition: width 0.6s cubic-bezier(0.16, 1, 0.3, 1); }

    /* Section titles */
    .section-title {
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #1A7B6B;
      padding-bottom: 12px;
      margin-bottom: 24px;
      border-bottom: 2px solid #1A7B6B;
    }
    .sub-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: #0F1419;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sub-title::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 2px;
      background: #1A7B6B;
      flex-shrink: 0;
    }

    .hidden { display: none !important; }
    .rotate-90 { transform: rotate(90deg); }

    /* Toggle buttons */
    .toggle-btn {
      padding: 5px 14px;
      font-size: 0.75rem;
      font-weight: 600;
      border: 1px solid #E8ECF0;
      cursor: pointer;
      color: #8899A6;
      background: #fff;
      transition: all 0.15s ease;
      letter-spacing: 0.02em;
    }
    .toggle-btn:first-child { border-radius: 8px 0 0 8px; }
    .toggle-btn:last-child { border-radius: 0 8px 8px 0; border-left: 0; }
    .toggle-btn:hover:not(.active) { color: #536471; background: #F7F8FA; }
    .toggle-btn.active {
      background: #1A7B6B;
      color: #fff;
      border-color: #1A7B6B;
    }

    /* Tables */
    th {
      color: #8899A6;
      font-weight: 600;
      font-size: 0.6875rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    th[title] {
      cursor: help;
      text-decoration: underline dotted #CFD9DE;
      text-underline-offset: 3px;
    }
    th.sortable { cursor: pointer; user-select: none; transition: color 0.15s; }
    th.sortable:hover { color: #1A7B6B; }
    td { font-size: 0.8125rem; }
    td.text-right, th.text-right { text-align: right; }
    tr.hover-row:hover { background: #F7F8FA; }

    /* Header selects */
    .header-select {
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s ease;
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 28px;
    }
    .header-select:hover { background: rgba(255,255,255,0.2); }
    .header-select option { color: #0F1419; background: #fff; }

    /* BU tabs */
    .bu-tab {
      padding: 8px 20px;
      font-size: 0.8125rem;
      font-weight: 600;
      color: rgba(255,255,255,0.55);
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: all 0.15s ease;
      letter-spacing: 0.01em;
    }
    .bu-tab:hover:not(.active) { color: rgba(255,255,255,0.8); }
    .bu-tab.active {
      color: #fff;
      border-bottom-color: #F5A623;
      background: rgba(255,255,255,0.08);
      border-radius: 6px 6px 0 0;
    }

    /* Body selects */
    .filter-select {
      border: 1px solid #E8ECF0;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 0.8125rem;
      font-weight: 500;
      background: #fff;
      color: #0F1419;
      cursor: pointer;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%238899A6' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 28px;
    }
    .filter-select:hover { border-color: #1A7B6B; }
    .filter-select:focus { outline: none; border-color: #1A7B6B; box-shadow: 0 0 0 3px rgba(26,123,107,0.12); }

    /* Funnel bar labels */
    .funnel-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #536471;
      width: 52px;
      text-align: right;
      flex-shrink: 0;
    }
    .funnel-track {
      background: #F0F2F5;
      border-radius: 6px;
      height: 32px;
      overflow: hidden;
    }
    .funnel-fill {
      height: 100%;
      border-radius: 6px;
      display: flex;
      align-items: center;
      padding: 0 12px;
      min-width: 40px;
      transition: width 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* Conversion rate pills */
    .conv-pill {
      font-size: 0.6875rem;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 4px;
      background: #F0F2F5;
      color: #536471;
    }

    /* Summary card header */
    .summary-header {
      font-size: 0.6875rem;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #8899A6;
    }
  </style>
</head>
<body class="font-sans antialiased">

  <!-- Header -->
  <header style="background: linear-gradient(135deg, #005a50 0%, #1A7B6B 60%, #228B7B 100%);">
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
      <div class="py-5">
        <h1 class="text-lg font-bold tracking-tight text-white">Amberscript</h1>
        <p class="text-white/50 text-xs mt-0.5 font-medium" id="lastUpdated">Loading...</p>
      </div>
      <!-- BU Tabs + Date Range -->
      <div class="flex items-end justify-between -mb-px">
        <nav class="flex gap-1" id="buTabs">
          <button class="bu-tab active" data-bu="Transcription" onclick="switchBU('Transcription')">Transcription</button>
          <button class="bu-tab" data-bu="Media" onclick="switchBU('Media')">Media</button>
          <button class="bu-tab" data-bu="Innovations" onclick="switchBU('Innovations')">Innovations</button>
        </nav>
        <div class="flex items-center gap-2 mb-1.5">
        <button onclick="openRawData()" class="header-select flex items-center gap-1 cursor-pointer" style="padding:6px 12px;">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M3 14h18M3 6h18M3 18h18"/></svg>
          Raw Data
        </button>
        <select id="dateRange" class="header-select">
          <option value="this-week">This week</option>
          <option value="last-week">Last week</option>
          <option value="last-2-weeks">Last 2 weeks</option>
          <option value="last-4-weeks">Last 4 weeks</option>
          <option value="this-month">This month</option>
          <option value="last-month">Last month</option>
          <option value="last-2-months">Last 2 months</option>
          <option value="last-4-months">Last 4 months</option>
          <option value="all" selected>All time</option>
        </select>
        </div>
      </div>
    </div>
  </header>

  <!-- Raw Data Overlay -->
  <div id="rawDataOverlay" class="fixed inset-0 bg-black/60 z-50 hidden" onclick="if(event.target===this)closeRawData()">
    <div class="absolute inset-4 sm:inset-8 bg-white rounded-xl shadow-2xl flex flex-col overflow-hidden">
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50">
        <div class="flex items-center gap-4">
          <h2 class="text-lg font-bold text-gray-900">Raw Data</h2>
          <nav class="flex gap-1" id="rawDataTabs"></nav>
        </div>
        <div class="flex items-center gap-3">
          <button onclick="downloadRawCSV()" class="px-3 py-1.5 bg-as-primary text-white text-sm font-semibold rounded-lg hover:opacity-90 transition-opacity flex items-center gap-1.5">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            Download CSV
          </button>
          <button onclick="closeRawData()" class="text-gray-400 hover:text-gray-600 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
      </div>
      <div id="rawDataContent" class="flex-1 overflow-auto p-6"></div>
    </div>
  </div>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8">

    <!-- ============================================ -->
    <!-- PAGE: TRANSCRIPTION (BUT)                    -->
    <!-- ============================================ -->
    <div id="page-Transcription" class="bu-page space-y-10">

    <div>
      <h2 class="section-title">Transcription</h2>

      <!-- ---- Inbound (HubSpot) ---- -->
      <div class="mb-10">
        <h3 class="sub-title">Inbound</h3>

        <!-- Filters -->
        <div class="flex flex-wrap items-center gap-2 mb-5" id="inboundFilters">
          <select id="inbProductFilter" class="filter-select" onchange="onInboundFilterChange()">
            <option value="all">All Products</option>
          </select>
          <select id="inbStyleFilter" class="filter-select hidden" onchange="onInboundFilterChange()">
            <option value="all">All Styles</option>
          </select>
          <select id="inbOptionsFilter" class="filter-select hidden" onchange="onInboundFilterChange()">
            <option value="all">All Options</option>
          </select>
          <select id="inbCountryFilter" class="filter-select" onchange="onInboundFilterChange()">
            <option value="all">All Countries</option>
            <option value="DACH">DACH (DE+AT+CH)</option>
          </select>
        </div>

        <!-- Inbound Summary -->
        <section class="card mb-6">
          <div class="flex items-center justify-between mb-4">
            <span class="summary-header">Summary</span>
            <div class="flex" id="inboundSummaryToggle">
              <button class="toggle-btn active" data-view="monthly" onclick="toggleInboundSummary('monthly')">Monthly</button>
              <button class="toggle-btn" data-view="weekly" onclick="toggleInboundSummary('weekly')">Weekly</button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="text-left border-b border-as-border"><tr id="inboundSummaryHead"></tr></thead>
              <tbody id="inboundSummaryBody"></tbody>
            </table>
          </div>
        </section>

        <!-- KPIs -->
        <div id="inboundKPIs" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4 mb-6"></div>

        <!-- Funnel -->
        <div class="card mb-6">
          <span class="summary-header">Sales Funnel</span>
          <div id="funnelChart" class="space-y-2 mt-4"></div>
        </div>

        <!-- By Product (full width, nested breakdown) -->
        <div class="card mb-6">
          <span class="summary-header">By Product</span>
          <div class="overflow-x-auto mt-3">
            <table id="productTable" class="w-full">
              <thead class="text-left border-b border-as-border">
                <tr>
                  <th class="pb-2">Product</th>
                  <th class="pb-2 text-center">Leads</th>
                  <th class="pb-2 text-center">MQL<span style="text-transform:none">s</span></th>
                  <th class="pb-2 text-center">SQL<span style="text-transform:none">s</span></th>
                  <th class="pb-2 text-center" title="By close date (by create date in brackets)">Won</th>
                  <th class="pb-2 text-center" title="By close date (by create date in brackets)">Revenue</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Owner + Country side by side -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card flex flex-col">
            <span class="summary-header">By Deal Owner</span>
            <div class="overflow-x-auto mt-3 flex-1">
              <table id="ownerTable" class="w-full">
                <colgroup><col><col style="width:12%"><col style="width:12%"><col style="width:12%"><col style="width:22%"><col style="width:14%"></colgroup>
                <thead class="text-left border-b border-as-border">
                  <tr>
                    <th class="pb-2">Owner</th>
                    <th class="pb-2 text-center">MQL<span style="text-transform:none">s</span></th>
                    <th class="pb-2 text-center">SQL<span style="text-transform:none">s</span></th>
                    <th class="pb-2 text-center" title="By close date (by create date in brackets)">Won</th>
                    <th class="pb-2 text-center" title="By close date (by create date in brackets)">Revenue</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="ownerTableTotal" class="overflow-x-auto mt-auto"></div>
          </div>
          <div class="card flex flex-col">
            <span class="summary-header">By Country</span>
            <div class="overflow-x-auto mt-3 flex-1">
              <table id="geoTable" class="w-full">
                <colgroup><col><col style="width:12%"><col style="width:12%"><col style="width:12%"><col style="width:22%"><col style="width:14%"></colgroup>
                <thead class="text-left border-b border-as-border">
                  <tr>
                    <th class="pb-2">Country</th>
                    <th class="pb-2 text-center">MQL<span style="text-transform:none">s</span></th>
                    <th class="pb-2 text-center">SQL<span style="text-transform:none">s</span></th>
                    <th class="pb-2 text-center" title="By close date (by create date in brackets)">Won</th>
                    <th class="pb-2 text-center" title="By close date (by create date in brackets)">Revenue</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="geoTableTotal" class="overflow-x-auto mt-auto"></div>
          </div>
        </div>
      </div>

      <!-- ---- Self-Serve (Stripe) ---- -->
      <div id="selfServeSection">
        <h3 class="sub-title">Self-Serve</h3>

        <!-- Filters -->
        <div class="flex flex-wrap items-center gap-2 mb-5" id="selfServeFilters">
          <select id="filterProduct" class="filter-select" onchange="onFilterChange()">
            <option value="all">All</option>
            <option value="mm">Machine-Made</option>
            <option value="hm">Human-Made</option>
            <option value="inv">Invoice</option>
          </select>
          <select id="filterPlanType" class="filter-select" onchange="onFilterChange()">
            <option value="all">All Types</option>
            <option value="prepaid">Prepaid</option>
            <option value="sub">Subscription</option>
          </select>
          <select id="filterSubtype" class="filter-select hidden" onchange="onFilterChange()">
          </select>
        </div>

        <!-- Self-Serve Summary -->
        <section class="card mb-6">
          <div class="flex items-center justify-between mb-4">
            <span class="summary-header">Summary</span>
            <div class="flex" id="selfServeSummaryToggle">
              <button class="toggle-btn active" data-view="monthly" onclick="toggleSelfServeSummary('monthly')">Monthly</button>
              <button class="toggle-btn" data-view="weekly" onclick="toggleSelfServeSummary('weekly')">Weekly</button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="text-left border-b border-as-border"><tr id="selfServeSummaryHead"></tr></thead>
              <tbody id="selfServeSummaryBody"></tbody>
            </table>
          </div>
        </section>

        <!-- KPIs -->
        <div id="selfServeKPIs" class="grid grid-cols-2 sm:grid-cols-5 gap-4 mb-6"></div>

        <!-- Revenue Trend -->
        <div class="card mb-6">
          <span class="summary-header">Revenue Trend</span>
          <div class="chart-container mt-3"><canvas id="selfServeRevenueChart"></canvas></div>
        </div>

        <!-- Breakdown tables -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="card flex flex-col">
            <span class="summary-header">By Product</span>
            <div class="overflow-x-auto mt-3 flex-1">
              <table id="ssProductTable" class="w-full">
                <thead class="text-left border-b border-as-border"><tr></tr></thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="ssProductTableTotal" class="overflow-x-auto mt-auto"></div>
          </div>
          <div class="card flex flex-col">
            <span class="summary-header">By Plan Type</span>
            <div class="overflow-x-auto mt-3 flex-1">
              <table id="ssPlanTable" class="w-full">
                <thead class="text-left border-b border-as-border">
                  <tr>
                    <th class="pb-2">Plan Type</th>
                    <th class="pb-2 text-center">Payments</th>
                    <th class="pb-2 text-center">Revenue</th>
                    <th class="pb-2 text-center">AOV</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card flex flex-col">
            <span class="summary-header">By Country</span>
            <div class="overflow-x-auto mt-3 flex-1">
              <table id="ssCountryTable" class="w-full">
                <thead class="text-left border-b border-as-border"><tr></tr></thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="ssCountryTableTotal" class="overflow-x-auto mt-auto"></div>
          </div>
          <div class="card flex flex-col">
            <span class="summary-header">By Channel</span>
            <div class="overflow-x-auto mt-3 flex-1">
              <table id="ssChannelTable" class="w-full">
                <thead class="text-left border-b border-as-border"><tr></tr></thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="ssChannelTableTotal" class="overflow-x-auto mt-auto"></div>
          </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- GOOGLE ADS                                   -->
    <!-- ============================================ -->
    <div>
      <h2 class="section-title">Google Ads</h2>

      <div id="adsKPIs" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6"></div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card">
          <span class="summary-header">Ad Spend: Machine-Made vs Human-Made</span>
          <div class="chart-container mt-3"><canvas id="mmVsHmChart"></canvas></div>
        </div>
        <div class="card">
          <span class="summary-header">Ad Spend by Product</span>
          <div class="chart-container mt-3"><canvas id="adProductChart"></canvas></div>
        </div>
      </div>
    </div>

    </div><!-- /page-Transcription -->

    <!-- ============================================ -->
    <!-- PAGE: MEDIA (BUM)                            -->
    <!-- ============================================ -->
    <div id="page-Media" class="bu-page hidden">
      <div class="flex flex-col items-center justify-center py-24 text-center">
        <div class="w-16 h-16 rounded-2xl bg-as-primary/10 flex items-center justify-center mb-5">
          <svg class="w-8 h-8 text-as-primary" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h1.5C5.496 19.5 6 18.996 6 18.375m-2.625 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-1.5A1.125 1.125 0 0 1 18 18.375M20.625 4.5H3.375m17.25 0c.621 0 1.125.504 1.125 1.125M20.625 4.5h-1.5C18.504 4.5 18 5.004 18 5.625m3.75 0v1.5c0 .621-.504 1.125-1.125 1.125M3.375 4.5c-.621 0-1.125.504-1.125 1.125M3.375 4.5h1.5C5.496 4.5 6 5.004 6 5.625m-2.625 0v1.5c0 .621.504 1.125 1.125 1.125m0 0h13.5c.621 0 1.125-.504 1.125-1.125m-14.625 0h14.625"/></svg>
        </div>
        <h2 class="text-xl font-bold text-as-text mb-2">Media (BUM)</h2>
        <p class="text-as-secondary text-sm max-w-md">Subtitles, dubbing, audio description, and localisation metrics. This page is under development.</p>
        <span class="mt-4 text-xs font-semibold uppercase tracking-wider text-as-accent bg-as-accent/10 px-3 py-1 rounded-full">Coming Soon</span>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- PAGE: INNOVATIONS (BUNS)                     -->
    <!-- ============================================ -->
    <div id="page-Innovations" class="bu-page hidden">
      <div class="flex flex-col items-center justify-center py-24 text-center">
        <div class="w-16 h-16 rounded-2xl bg-as-primary/10 flex items-center justify-center mb-5">
          <svg class="w-8 h-8 text-as-primary" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.383a14.406 14.406 0 0 1-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 1 0-7.517 0c.85.493 1.509 1.333 1.509 2.316V18"/></svg>
        </div>
        <h2 class="text-xl font-bold text-as-text mb-2">Innovations (BUNS)</h2>
        <p class="text-as-secondary text-sm max-w-md">AmberNotes and new product initiatives. This page is under development.</p>
        <span class="mt-4 text-xs font-semibold uppercase tracking-wider text-as-accent bg-as-accent/10 px-3 py-1 rounded-full">Coming Soon</span>
      </div>
    </div>

  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 py-8 text-center text-as-muted text-xs font-medium">
    Auto-updated daily via GitHub Actions &middot; Google Ads &middot; HubSpot &middot; Stripe &middot; GA4
  </footer>

<script>
let DATA = null;
let charts = {};
let inboundSummaryView = 'monthly';
let selfServeSummaryView = 'monthly';
let currentBU = 'Transcription';
const tableSortState = {
  productTable: { col: 'revenue', dir: 'desc' },
  ownerTable: { col: 'revenue', dir: 'desc' },
  geoTable: { col: 'revenue', dir: 'desc' },
  ssCountryTable: { col: 'revenue', dir: 'desc' },
  ssChannelTable: { col: 'revenue', dir: 'desc' },
  ssProductTable: { col: 'revenue', dir: 'desc' },
};

const CHANNEL_COLORS = {
  'Direct': '#1A7B6B', 'Paid Search': '#005a50', 'Organic Search': '#2E7D32',
  'Referral': '#F5A623', 'Email': '#E69100', 'Subscription': '#7B1FA2',
  'Unknown': '#8899A6', 'Organic Video': '#0061FF', 'Affiliates': '#155F54',
  'Organic Social': '#E65100', 'Cross-network': '#5C6BC0', 'Unassigned': '#CFD9DE',
};

const fmt = {
  currency: (n) => new Intl.NumberFormat('en-EU', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n),
  number: (n) => new Intl.NumberFormat('en-US').format(n),
  pct: (n) => n.toFixed(1) + '%',
  shortDate: (d) => {
    const date = new Date(d + 'T00:00:00');
    return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
  },
  monthLabel: (m) => {
    const [y, mo] = m.split('-');
    return new Date(parseInt(y), parseInt(mo) - 1).toLocaleDateString('en-GB', { month: 'short', year: '2-digit' });
  },
};

// ===== DATA LOADING =====
async function loadData() {
  try {
    const res = await fetch('data.json');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    DATA = await res.json();
    render();
  } catch (err) {
    document.getElementById('lastUpdated').textContent = 'Error loading data: ' + err.message;
  }
}

// ===== DATE FILTERING =====
function getFilteredWeeks() {
  const mode = document.getElementById('dateRange').value;
  const allWeeks = DATA.weekly.ads.map(r => r.week).filter(Boolean);
  if (!allWeeks.length || mode === 'all') return allWeeks;

  const today = new Date();
  const dayOfWeek = today.getUTCDay() || 7;
  const thisMonday = new Date(today);
  thisMonday.setUTCDate(today.getUTCDate() - dayOfWeek + 1);
  const thisMondayStr = thisMonday.toISOString().slice(0, 10);
  const firstOfMonth = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), 1));

  if (mode === 'this-week') return allWeeks.filter(w => w >= thisMondayStr);
  if (mode === 'last-week') { const s = new Date(thisMonday); s.setUTCDate(s.getUTCDate()-7); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < thisMondayStr); }
  if (mode === 'last-2-weeks') { const s = new Date(thisMonday); s.setUTCDate(s.getUTCDate()-14); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < thisMondayStr); }
  if (mode === 'last-4-weeks') { const s = new Date(thisMonday); s.setUTCDate(s.getUTCDate()-28); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < thisMondayStr); }
  if (mode === 'this-month') return allWeeks.filter(w => w >= firstOfMonth.toISOString().slice(0,10));
  if (mode === 'last-month') { const s = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth()-1, 1)); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < firstOfMonth.toISOString().slice(0,10)); }
  if (mode === 'last-2-months') { const s = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth()-2, 1)); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < firstOfMonth.toISOString().slice(0,10)); }
  if (mode === 'last-4-months') { const s = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth()-4, 1)); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < firstOfMonth.toISOString().slice(0,10)); }
  return allWeeks;
}

function filterByWeeks(arr, weeks) {
  const set = new Set(weeks);
  return arr.filter(r => set.has(r.week));
}

// ===== BUSINESS UNIT =====
function getCurrentBU() {
  return currentBU;
}

function switchBU(bu) {
  currentBU = bu;
  // Update tab active states
  document.querySelectorAll('#buTabs .bu-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.bu === bu);
  });
  // Show/hide page containers
  document.querySelectorAll('.bu-page').forEach(page => {
    page.classList.toggle('hidden', page.id !== `page-${bu}`);
  });
  // Re-render if data is loaded
  if (DATA) render();
}

function getBU(product) {
  if (!product) return 'Transcription';
  const media = ['Human-Made Subtitles', 'Machine-Made Subtitles', 'Translated Subtitles', 'Translations', 'Subtitles'];
  const innovations = ['Amber Notes', 'AI Meeting Notes', 'Meeting Notes'];
  if (media.includes(product)) return 'Media';
  if (innovations.includes(product)) return 'Innovations';
  return 'Transcription';
}

// ===== INTERACTIONS =====
function getSegmentKey() {
  const product = document.getElementById('filterProduct').value;
  const planType = document.getElementById('filterPlanType').value;
  const subtype = document.getElementById('filterSubtype').value || 'all';
  return `${product}.${planType}.${subtype}`;
}

function onFilterChange() {
  const product = document.getElementById('filterProduct').value;
  const planTypeEl = document.getElementById('filterPlanType');
  const subtypeEl = document.getElementById('filterSubtype');

  if (product === 'hm' || product === 'inv') {
    planTypeEl.classList.add('hidden');
    planTypeEl.value = 'all';
    subtypeEl.classList.add('hidden');
    subtypeEl.value = 'all';
  } else {
    planTypeEl.classList.remove('hidden');
  }

  const planType = planTypeEl.value;
  if (planType === 'prepaid') {
    subtypeEl.innerHTML = '<option value="all">All Prepaid</option><option value="topup">Top-Up</option><option value="job">Job Creation</option>';
    subtypeEl.classList.remove('hidden');
  } else if (planType === 'sub') {
    subtypeEl.innerHTML = '<option value="all">All Subscriptions</option><option value="update">Update</option><option value="creation">Creation</option>';
    subtypeEl.classList.remove('hidden');
  } else {
    subtypeEl.classList.add('hidden');
    subtypeEl.value = 'all';
  }

  const weeks = getFilteredWeeks();
  renderSelfServeSummary(weeks);
  renderSelfServe(weeks);
}

function toggleInboundSummary(view) {
  inboundSummaryView = view;
  document.querySelectorAll('#inboundSummaryToggle .toggle-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.view === view);
  });
  renderInboundSummary(getFilteredWeeks());
}

function toggleSelfServeSummary(view) {
  selfServeSummaryView = view;
  document.querySelectorAll('#selfServeSummaryToggle .toggle-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.view === view);
  });
  const weeks = getFilteredWeeks();
  renderSelfServeSummary(weeks);
  renderSelfServe(weeks);
}

// ===== KPI CARD HELPER =====
function kpiCard(label, value, color, sub) {
  return `<div class="kpi-card card !p-4 !pl-5" style="--kpi-color: ${color}">
    <p class="text-[0.6875rem] font-semibold uppercase tracking-wider text-as-muted">${label}</p>
    <p class="text-lg font-bold mt-1" style="color: ${color}">${value}</p>
    ${sub ? `<p class="text-xs font-semibold text-as-secondary mt-0.5">${sub}</p>` : ''}
  </div>`;
}

// ===== MAIN RENDER =====
function render() {
  const weeks = getFilteredWeeks();
  document.getElementById('lastUpdated').textContent =
    `Last updated: ${new Date(DATA.updatedAt).toLocaleString('en-GB')} \u00b7 ${DATA.dateRange.start} to ${DATA.dateRange.end}`;

  // Only render content for Transcription page (other pages are placeholders)
  if (currentBU !== 'Transcription') return;

  populateInboundFilters();
  renderInboundSummary(weeks);
  renderSelfServeSummary(weeks);
  renderSelfServe(weeks);
  renderInbound(weeks);
  renderGoogleAds(weeks);
}

// ===== INBOUND SUMMARY =====
function renderInboundSummary(weeks) {
  const bu = getCurrentBU();
  const head = document.getElementById('inboundSummaryHead');
  const body = document.getElementById('inboundSummaryBody');
  const ads = filterByWeeks(DATA.weekly.ads, weeks);
  const adsMap = Object.fromEntries(ads.map(r => [r.week, r]));

  function getHmCost(weekList) {
    let cost = 0;
    for (const w of weekList) {
      const a = adsMap[w];
      if (!a) continue;
      cost += (a.byBU?.[bu]?.hmCost || 0);
    }
    return cost;
  }

  // Use the same filters as the rest of the inbound section
  function computeFunnel(weekList) {
    const ws = new Set(weekList);
    const deals = getFilteredDeals(ws);
    const closedDeals = getClosedDeals(ws);
    const forms = getFilteredForms(ws);
    const leads = forms.reduce((s, r) => s + r.count, 0);
    const mqls = deals.length;
    const mqlsFL = deals.filter(d => d.formId).length;
    const sqls = deals.filter(d => ['SQL', 'Customer'].includes(d.lifecycleStage)).length;
    const won = deals.filter(d => d.status === 'Won').length;
    const wonRev = deals.filter(d => d.status === 'Won').reduce((s, d) => s + (d.amount || 0), 0);
    const wonClose = closedDeals.length;
    const wonRevClose = closedDeals.reduce((s, d) => s + (d.amount || 0), 0);
    return { leads, mqls, mqlsFL, sqls, won, wonRev, wonClose, wonRevClose };
  }

  function mqlCell(mqls, mqlsFL) {
    return `${fmt.number(mqls)} <span class="text-as-muted">(${fmt.number(mqlsFL)})</span>`;
  }

  // col-gap adds left padding to visually group related columns
  const g = 'pl-5'; // group separator
  const summaryHead = (label) => `
      <th class="pb-2">${label}</th>
      <th class="pb-2 text-center">Spend</th>
      <th class="pb-2 text-center ${g}">Leads</th>
      <th class="pb-2 text-center">MQL<span style="text-transform:none">s</span></th>
      <th class="pb-2 text-center">L&gt;MQL</th>
      <th class="pb-2 text-center ${g}">SQL<span style="text-transform:none">s</span></th>
      <th class="pb-2 text-center">MQL&gt;SQL</th>
      <th class="pb-2 text-center ${g}" title="By close date (by create date in brackets)">Won</th>
      <th class="pb-2 text-center">SQL&gt;Won</th>
      <th class="pb-2 text-center ${g}" title="By close date (by create date in brackets)">Revenue</th>
      <th class="pb-2 text-center ${g}">AOV</th>
  `;
  function summaryRow(label, hmCost, f) {
    const l2m = f.leads > 0 ? (f.mqlsFL / f.leads * 100).toFixed(1) + '%' : '-';
    const m2s = f.mqls > 0 ? (f.sqls / f.mqls * 100).toFixed(1) + '%' : '-';
    const s2w = f.sqls > 0 ? (f.won / f.sqls * 100).toFixed(1) + '%' : '-';
    const aov = f.wonClose > 0 ? fmt.currency(Math.round(f.wonRevClose / f.wonClose)) : '-';
    return `<tr class="border-b border-as-border/40 hover-row">
      <td class="py-2.5 font-semibold text-sm">${label}</td>
      <td class="py-2.5 text-center text-as-secondary">${fmt.currency(hmCost)}</td>
      <td class="py-2.5 text-center text-as-secondary ${g}">${fmt.number(f.leads)}</td>
      <td class="py-2.5 text-center text-as-secondary">${mqlCell(f.mqls, f.mqlsFL)}</td>
      <td class="py-2.5 text-center text-as-muted">${l2m}</td>
      <td class="py-2.5 text-center text-as-secondary ${g}">${fmt.number(f.sqls)}</td>
      <td class="py-2.5 text-center text-as-muted">${m2s}</td>
      <td class="py-2.5 text-center text-as-secondary ${g}">${fmt.number(f.wonClose)} <span class="text-as-muted">(${fmt.number(f.won)})</span></td>
      <td class="py-2.5 text-center text-as-muted">${s2w}</td>
      <td class="py-2.5 text-center font-semibold ${g}">${fmt.currency(f.wonRevClose)} <span class="text-as-muted font-normal">(${fmt.currency(f.wonRev)})</span></td>
      <td class="py-2.5 text-center text-as-secondary ${g}">${aov}</td>
    </tr>`;
  }

  if (inboundSummaryView === 'monthly') {
    const allMonths = [...new Set(weeks.map(w => w.slice(0, 7)))].sort();
    head.innerHTML = summaryHead('Month');
    body.innerHTML = allMonths.map(month => {
      const monthWeeks = weeks.filter(w => w.slice(0, 7) === month);
      return summaryRow(fmt.monthLabel(month), getHmCost(monthWeeks), computeFunnel(monthWeeks));
    }).join('');
  } else {
    head.innerHTML = summaryHead('Week');
    body.innerHTML = weeks.map(w => {
      return summaryRow(fmt.shortDate(w), getHmCost([w]), computeFunnel([w]));
    }).join('');
  }
}

// ===== SELF-SERVE SUMMARY =====
function renderSelfServeSummary(weeks) {
  const head = document.getElementById('selfServeSummaryHead');
  const body = document.getElementById('selfServeSummaryBody');
  const segKey = getSegmentKey();
  const product = document.getElementById('filterProduct').value;
  const planType = document.getElementById('filterPlanType').value;

  const ads = filterByWeeks(DATA.weekly.ads, weeks);
  const adsMap = Object.fromEntries(ads.map(r => [r.week, r]));

  function getMmCost(weekList) {
    let cost = 0;
    for (const w of weekList) { cost += (adsMap[w]?.byBU?.Transcription?.mmCost || 0); }
    return cost;
  }
  function getStripeMetrics(weekList) {
    const stripe = filterByWeeks(DATA.weekly.stripe, weekList);
    let payments = 0, revenue = 0, newSubs = 0;
    for (const s of stripe) {
      const seg = s.seg || {};
      payments += (seg[segKey] || {}).count || 0;
      revenue += (seg[segKey] || {}).revenue || 0;
      const subKey = `${product}.sub.creation`;
      if (planType === 'all' || planType === 'sub') {
        newSubs += (seg[subKey] || {}).count || 0;
      }
    }
    return { payments, revenue, newSubs };
  }
  function getSubMetrics(weekList) {
    const subs = filterByWeeks(DATA.weekly.subs || [], weekList);
    let churned = 0, newMrr = 0, churnedMrr = 0;
    for (const s of subs) {
      churned += s.churnedSubs || 0;
      newMrr += s.newMrr || 0;
      churnedMrr += s.churnedMrr || 0;
    }
    return { churned, netMrr: newMrr - churnedMrr };
  }

  const g = 'pl-5';
  const ssHead = (label) => `
    <th class="pb-2">${label}</th>
    <th class="pb-2 text-center">MM Spend</th>
    <th class="pb-2 text-center ${g}">Payments</th>
    <th class="pb-2 text-center">Revenue</th>
    <th class="pb-2 text-center ${g}">New Subs</th>
    <th class="pb-2 text-center">Churned</th>
    <th class="pb-2 text-center ${g}">Net MRR</th>
  `;
  function ssRow(label, weekList) {
    const mmCost = getMmCost(weekList);
    const m = getStripeMetrics(weekList);
    const sub = getSubMetrics(weekList);
    const mrrClass = sub.netMrr >= 0 ? 'text-green-600' : 'text-red-500';
    const mrrSign = sub.netMrr >= 0 ? '+' : '';
    return `<tr class="border-b border-as-border/40 hover-row">
      <td class="py-2.5 font-semibold text-sm">${label}</td>
      <td class="py-2.5 text-center text-as-secondary">${fmt.currency(mmCost)}</td>
      <td class="py-2.5 text-center text-as-secondary ${g}">${fmt.number(m.payments)}</td>
      <td class="py-2.5 text-center font-semibold">${fmt.currency(m.revenue)}</td>
      <td class="py-2.5 text-center text-as-secondary ${g}">${fmt.number(m.newSubs)}</td>
      <td class="py-2.5 text-center text-as-secondary">${fmt.number(sub.churned)}</td>
      <td class="py-2.5 text-center font-semibold ${g} ${mrrClass}">${mrrSign}${fmt.currency(Math.round(sub.netMrr))}</td>
    </tr>`;
  }

  if (selfServeSummaryView === 'monthly') {
    const allMonths = [...new Set(weeks.map(w => w.slice(0, 7)))].sort();
    head.innerHTML = ssHead('Month');
    body.innerHTML = allMonths.map(month => {
      const monthWeeks = weeks.filter(w => w.slice(0, 7) === month);
      return ssRow(fmt.monthLabel(month), monthWeeks);
    }).join('');
  } else {
    head.innerHTML = ssHead('Week');
    body.innerHTML = weeks.map(w => ssRow(fmt.shortDate(w), [w])).join('');
  }
}

// ===== SELF-SERVE (Stripe) =====
function renderSelfServe(weeks) {
  const stripe = filterByWeeks(DATA.weekly.stripe, weeks);
  const segKey = getSegmentKey();

  let totalPayments = 0, totalRevenue = 0, newSubs = 0;
  const product = document.getElementById('filterProduct').value;
  const planType = document.getElementById('filterPlanType').value;
  for (const row of stripe) {
    const seg = row.seg || {};
    const s = seg[segKey] || { count: 0, revenue: 0 };
    totalPayments += s.count;
    totalRevenue += s.revenue;
    const subCreationKey = `${product}.sub.creation`;
    if (planType === 'all' || planType === 'sub') {
      newSubs += (seg[subCreationKey] || { count: 0 }).count;
    }
  }

  const aov = totalPayments > 0 ? fmt.currency(Math.round(totalRevenue / totalPayments)) : '-';
  const mrr = DATA.subSnapshot ? fmt.currency(DATA.subSnapshot.mrr) : '-';
  document.getElementById('selfServeKPIs').innerHTML = [
    { label: 'Payments', value: fmt.number(totalPayments), color: '#0F1419' },
    { label: 'Revenue', value: fmt.currency(totalRevenue), color: '#1A7B6B' },
    { label: 'AOV', value: aov, color: '#E69100' },
    { label: 'New Subscriptions', value: fmt.number(newSubs), color: '#7B1FA2' },
    { label: 'Current MRR', value: mrr, color: '#1565C0' },
  ].map(k => kpiCard(k.label, k.value, k.color)).join('');

  // Revenue trend chart - follows monthly/weekly toggle
  let chartLabels, chartData;
  if (selfServeSummaryView === 'monthly') {
    const allMonths = [...new Set(weeks.map(w => w.slice(0, 7)))].sort();
    chartLabels = allMonths.map(m => fmt.monthLabel(m));
    chartData = allMonths.map(month => {
      const monthWeeks = weeks.filter(w => w.slice(0, 7) === month);
      const monthStripe = filterByWeeks(DATA.weekly.stripe, monthWeeks);
      return monthStripe.reduce((s, r) => s + (r.seg?.[segKey] || { revenue: 0 }).revenue, 0);
    });
  } else {
    chartLabels = stripe.map(r => fmt.shortDate(r.week));
    chartData = stripe.map(r => (r.seg?.[segKey] || { revenue: 0 }).revenue);
  }

  destroyChart('selfServeRevenueChart');
  charts.selfServeRevenueChart = new Chart(document.getElementById('selfServeRevenueChart'), {
    type: 'bar',
    data: {
      labels: chartLabels,
      datasets: [{
        label: 'Revenue',
        data: chartData,
        backgroundColor: 'rgba(26,123,107,0.15)',
        borderColor: '#1A7B6B',
        borderWidth: 1.5,
        borderRadius: 4,
      }],
    },
    options: chartOptions('EUR'),
  });

  // Breakdown tables
  renderSSBreakdown(stripe, 'ssProductTable', 'Product', 'byProduct');
  renderSSPlanTable(stripe);
  renderSSBreakdown(stripe, 'ssCountryTable', 'Country', 'byCountry');
  renderSSBreakdown(stripe, 'ssChannelTable', 'Channel', 'byChannel');
}

function renderSSBreakdown(stripe, tableId, labelCol, dataKey) {
  const totals = {};
  for (const row of stripe) {
    for (const [k, data] of Object.entries(row[dataKey] || {})) {
      if (!totals[k]) totals[k] = { payments: 0, revenue: 0 };
      totals[k].payments += data.count || 0;
      totals[k].revenue += data.revenue || 0;
    }
  }

  const ss = tableSortState[tableId];
  const keys = Object.keys(totals).sort((a, b) => {
    let va, vb;
    switch (ss.col) {
      case 'name': return ss.dir === 'asc' ? a.localeCompare(b) : b.localeCompare(a);
      case 'payments': va = totals[a].payments; vb = totals[b].payments; break;
      case 'aov': va = totals[a].payments > 0 ? totals[a].revenue / totals[a].payments : 0; vb = totals[b].payments > 0 ? totals[b].revenue / totals[b].payments : 0; break;
      default: va = totals[a].revenue; vb = totals[b].revenue;
    }
    return ss.dir === 'desc' ? vb - va : va - vb;
  });

  const sum = { payments: 0, revenue: 0 };
  for (const k of keys) { sum.payments += totals[k].payments; sum.revenue += totals[k].revenue; }
  const sumAov = sum.payments > 0 ? fmt.currency(Math.round(sum.revenue / sum.payments)) : '-';

  const si = (col) => sortIndicator(tableId, col);
  document.querySelector(`#${tableId} thead tr`).innerHTML = `
    <th class="pb-2 sortable" onclick="sortSSTable('${tableId}','name')">${labelCol}${si('name')}</th>
    <th class="pb-2 text-center sortable" onclick="sortSSTable('${tableId}','payments')">Payments${si('payments')}</th>
    <th class="pb-2 text-center sortable" onclick="sortSSTable('${tableId}','revenue')">Revenue${si('revenue')}</th>
    <th class="pb-2 text-center sortable" onclick="sortSSTable('${tableId}','aov')">AOV${si('aov')}</th>`;

  const isCountry = tableId === 'ssCountryTable';
  const LIMIT = 10;

  const rows = keys.map((k, i) => {
    const d = totals[k];
    const aov = d.payments > 0 ? fmt.currency(Math.round(d.revenue / d.payments)) : '-';
    const extra = (isCountry && i >= LIMIT) ? ' ss-country-extra hidden' : '';
    return `<tr class="border-b border-as-border/40 hover-row${extra}">
      <td class="py-2 font-medium text-sm">${k}</td>
      <td class="py-2 text-center text-as-secondary">${fmt.number(d.payments)}</td>
      <td class="py-2 text-center font-semibold">${fmt.currency(d.revenue)}</td>
      <td class="py-2 text-center text-as-secondary">${aov}</td>
    </tr>`;
  }).join('');

  const showMore = (isCountry && keys.length > LIMIT)
    ? `<tr class="ss-country-toggle border-b border-as-border/40 cursor-pointer hover-row" onclick="toggleSSCountryShowMore()">
        <td colspan="4" class="py-2 text-center text-as-primary text-sm font-semibold">Show ${keys.length - LIMIT} more countries <svg class="inline w-3 h-3 ml-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg></td>
      </tr>` : '';

  document.querySelector(`#${tableId} tbody`).innerHTML = rows + showMore;
  document.getElementById(`${tableId}Total`).innerHTML = `<table class="w-full">
    <colgroup><col><col style="width:20%"><col style="width:22%"><col style="width:18%"></colgroup>
    <tr class="border-t-2 border-as-border">
      <td class="py-2 font-bold text-sm">Total</td>
      <td class="py-2 text-center font-bold text-sm">${fmt.number(sum.payments)}</td>
      <td class="py-2 text-center font-bold text-sm">${fmt.currency(sum.revenue)}</td>
      <td class="py-2 text-center font-bold text-sm">${sumAov}</td>
    </tr>
  </table>`;
}

function renderSSPlanTable(stripe) {
  const product = document.getElementById('filterProduct').value;

  function sumSeg(segKey) {
    let payments = 0, revenue = 0;
    for (const row of stripe) {
      payments += (row.seg?.[segKey] || {}).count || 0;
      revenue += (row.seg?.[segKey] || {}).revenue || 0;
    }
    return { payments, revenue };
  }
  function aovStr(d) { return d.payments > 0 ? fmt.currency(Math.round(d.revenue / d.payments)) : '-'; }

  const planTypes = [];
  if (product !== 'inv') {
    planTypes.push({
      key: 'prepaid', label: 'Prepaid',
      subtypes: [{ key: 'topup', label: 'Top-Up' }, { key: 'job', label: 'Job Creation' }],
    });
    planTypes.push({
      key: 'sub', label: 'Subscription',
      subtypes: [{ key: 'update', label: 'Update' }, { key: 'creation', label: 'Creation' }],
    });
  }
  if (product === 'all' || product === 'inv') {
    planTypes.push({ key: 'inv', label: 'Invoice', subtypes: [], isInvoice: true });
  }

  let html = '';
  let totalPayments = 0, totalRevenue = 0;

  for (const pt of planTypes) {
    const data = pt.isInvoice ? sumSeg('inv.all.all') : sumSeg(`${product}.${pt.key}.all`);
    totalPayments += data.payments;
    totalRevenue += data.revenue;

    html += `<tr class="border-b border-as-border/40 hover-row">
      <td class="py-2 text-sm font-semibold">${pt.label}</td>
      <td class="py-2 text-center text-as-secondary text-sm">${fmt.number(data.payments)}</td>
      <td class="py-2 text-center font-semibold text-sm">${fmt.currency(data.revenue)}</td>
      <td class="py-2 text-center text-as-secondary text-sm">${aovStr(data)}</td>
    </tr>`;

    for (const st of pt.subtypes) {
      const sub = sumSeg(`${product}.${pt.key}.${st.key}`);
      html += `<tr class="border-b border-as-border/40 hover-row">
        <td class="py-1.5 text-xs text-as-secondary pl-5">${st.label}</td>
        <td class="py-1.5 text-center text-as-secondary text-xs">${fmt.number(sub.payments)}</td>
        <td class="py-1.5 text-center font-semibold text-xs">${fmt.currency(sub.revenue)}</td>
        <td class="py-1.5 text-center text-as-secondary text-xs">${aovStr(sub)}</td>
      </tr>`;
    }
  }

  const totalAov = totalPayments > 0 ? fmt.currency(Math.round(totalRevenue / totalPayments)) : '-';
  html += `<tr class="border-t-2 border-as-border">
    <td class="py-2 text-sm font-bold">Total</td>
    <td class="py-2 text-center font-bold text-sm">${fmt.number(totalPayments)}</td>
    <td class="py-2 text-center font-bold text-sm">${fmt.currency(totalRevenue)}</td>
    <td class="py-2 text-center font-bold text-sm">${totalAov}</td>
  </tr>`;

  document.querySelector('#ssPlanTable tbody').innerHTML = html;
}

function sortSSTable(tableId, col) {
  const s = tableSortState[tableId];
  if (s.col === col) { s.dir = s.dir === 'desc' ? 'asc' : 'desc'; }
  else { s.col = col; s.dir = col === 'name' ? 'asc' : 'desc'; }
  renderSelfServe(getFilteredWeeks());
}

function toggleSSCountryShowMore() {
  const rows = document.querySelectorAll('.ss-country-extra');
  const btn = document.querySelector('.ss-country-toggle');
  const isHidden = rows[0]?.classList.contains('hidden');
  rows.forEach(r => r.classList.toggle('hidden'));
  if (btn) {
    const td = btn.querySelector('td');
    if (isHidden) {
      td.innerHTML = 'Show fewer <svg class="inline w-3 h-3 ml-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7"/></svg>';
    } else {
      td.innerHTML = `Show ${rows.length} more countries <svg class="inline w-3 h-3 ml-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>`;
    }
  }
}

// ===== INBOUND FILTER LOGIC =====
const DACH = ['DE', 'AT', 'CH'];

function getKnownCountries() {
  const bu = getCurrentBU();
  return new Set((DATA.deals || []).filter(d => d.bu === bu).map(d => d.country).filter(Boolean));
}

function matchCountry(dealCountry, filterVal) {
  if (filterVal === 'all') return true;
  if (filterVal === 'DACH') return DACH.includes(dealCountry);
  if (filterVal === 'Other') return !getKnownCountries().has(dealCountry);
  return dealCountry === filterVal;
}

function populateInboundFilters() {
  if (!DATA.deals) return;
  const bu = getCurrentBU();
  const deals = DATA.deals.filter(d => d.bu === bu);

  const products = [...new Set(deals.map(d => d.product).filter(Boolean))].sort()
    .filter(p => p !== 'Other');
  const prodEl = document.getElementById('inbProductFilter');
  prodEl.innerHTML = '<option value="all">All Products</option>' +
    products.map(p => `<option value="${p}">${p}</option>`).join('') +
    '<option value="Other">Other</option>';

  const countryCounts = {};
  for (const d of deals) { if (d.country) countryCounts[d.country] = (countryCounts[d.country] || 0) + 1; }
  const countries = Object.keys(countryCounts).sort((a, b) => countryCounts[b] - countryCounts[a]);
  const countryEl = document.getElementById('inbCountryFilter');
  countryEl.innerHTML = '<option value="all">All Countries</option><option value="DACH">DACH (DE+AT+CH)</option>' +
    countries.map(c => `<option value="${c}">${c}</option>`).join('') +
    '<option value="Other">Other</option>';
}

function onInboundFilterChange() {
  const product = document.getElementById('inbProductFilter').value;
  const styleEl = document.getElementById('inbStyleFilter');
  const optionsEl = document.getElementById('inbOptionsFilter');

  if (product === 'Human-Made Transcription') {
    const styles = [...new Set((DATA.deals || []).map(d => d.transcriptionStyle).filter(Boolean))].sort();
    const prevStyle = styleEl.value;
    styleEl.innerHTML = '<option value="all">All Styles</option>' +
      styles.map(s => `<option value="${s}">${s}</option>`).join('');
    if (styles.includes(prevStyle)) styleEl.value = prevStyle;
    styleEl.classList.remove('hidden');
  } else {
    styleEl.classList.add('hidden');
    styleEl.value = 'all';
    optionsEl.classList.add('hidden');
    optionsEl.value = 'all';
  }

  const style = styleEl.value;
  if (product === 'Human-Made Transcription' && (style === 'Verbatim' || style === 'Clean-Verbatim')) {
    const opts = [...new Set((DATA.deals || []).filter(d =>
      d.product === product && d.transcriptionStyle === style && d.additionalOptions
    ).map(d => d.additionalOptions))].sort();
    if (opts.length > 0) {
      const prevOpt = optionsEl.value;
      optionsEl.innerHTML = '<option value="all">All Options</option>' +
        opts.map(o => `<option value="${o}">${o}</option>`).join('');
      if (opts.includes(prevOpt)) optionsEl.value = prevOpt;
      optionsEl.classList.remove('hidden');
    } else {
      optionsEl.classList.add('hidden');
      optionsEl.value = 'all';
    }
  } else {
    optionsEl.classList.add('hidden');
    optionsEl.value = 'all';
  }

  const weeks = getFilteredWeeks();
  renderInboundSummary(weeks);
  renderInbound(weeks);
}

function getFilteredDeals(weekSet) {
  const bu = getCurrentBU();
  const product = document.getElementById('inbProductFilter').value;
  const style = document.getElementById('inbStyleFilter').value;
  const options = document.getElementById('inbOptionsFilter').value;
  const country = document.getElementById('inbCountryFilter').value;

  return (DATA.deals || []).filter(d => {
    if (!weekSet.has(d.week)) return false;
    if (d.bu !== bu) return false;
    if (product !== 'all' && d.product !== product) return false;
    if (style !== 'all' && d.transcriptionStyle !== style) return false;
    if (options !== 'all' && d.additionalOptions !== options) return false;
    if (!matchCountry(d.country, country)) return false;
    return true;
  });
}

function getFilteredForms(weekSet) {
  const bu = getCurrentBU();
  const country = document.getElementById('inbCountryFilter').value;
  return (DATA.ga4Forms || []).filter(f => {
    if (!weekSet.has(f.week)) return false;
    if (f.bu && f.bu !== bu) return false;
    if (!matchCountry(f.country, country)) return false;
    return true;
  });
}

function getClosedDeals(weekSet) {
  const bu = getCurrentBU();
  const product = document.getElementById('inbProductFilter').value;
  const style = document.getElementById('inbStyleFilter').value;
  const options = document.getElementById('inbOptionsFilter').value;
  const country = document.getElementById('inbCountryFilter').value;
  return (DATA.deals || []).filter(d => {
    if (d.status !== 'Won') return false;
    if (!d.closeWeek || !weekSet.has(d.closeWeek)) return false;
    if (d.bu !== bu) return false;
    if (product !== 'all' && d.product !== product) return false;
    if (style !== 'all' && d.transcriptionStyle !== style) return false;
    if (options !== 'all' && d.additionalOptions !== options) return false;
    if (!matchCountry(d.country, country)) return false;
    return true;
  });
}

// ===== INBOUND (HubSpot + GA4 Leads) =====
function renderInbound(weeks) {
  const weekSet = new Set(weeks);
  const deals = getFilteredDeals(weekSet);
  const forms = getFilteredForms(weekSet);

  const leads = forms.reduce((s, r) => s + r.count, 0);
  const mqls = deals.length;
  const mqlsFromLeads = deals.filter(r => r.formId).length;
  const sqls = deals.filter(r => ['SQL', 'Customer'].includes(r.lifecycleStage)).length;
  const sqlsFromLeads = deals.filter(r => r.formId && ['SQL', 'Customer'].includes(r.lifecycleStage)).length;
  const won = deals.filter(r => r.status === 'Won').length;
  const wonFromLeads = deals.filter(r => r.formId && r.status === 'Won').length;
  const wonRev = deals.filter(r => r.status === 'Won').reduce((s, r) => s + (r.amount || 0), 0);
  const closedDeals = getClosedDeals(weekSet);
  const wonClose = closedDeals.length;
  const wonRevClose = closedDeals.reduce((s, r) => s + (r.amount || 0), 0);
  const aov = won > 0 ? fmt.currency(Math.round(wonRev / won)) : '-';

  document.getElementById('inboundKPIs').innerHTML = [
    { label: 'Leads (GA4)', value: fmt.number(leads), color: '#005a50' },
    { label: 'MQL<span style="text-transform:none">s</span>', value: `${fmt.number(mqls)} <span class="text-[0.6875rem] text-as-muted font-normal">(${fmt.number(mqlsFromLeads)} from leads)</span>`, color: '#0F6B5E' },
    { label: 'SQL<span style="text-transform:none">s</span>', value: `${fmt.number(sqls)} <span class="text-[0.6875rem] text-as-muted font-normal">(${fmt.number(sqlsFromLeads)} from leads)</span>`, color: '#1A7B6B' },
    { label: 'Won Deals', value: fmt.number(wonClose), color: '#F5A623', sub: `${fmt.number(won)} by create date` },
    { label: 'Deal Revenue', value: fmt.currency(wonRevClose), color: '#F5A623', sub: `${fmt.currency(wonRev)} by create date` },
    { label: 'Deal AOV', value: aov, color: '#E69100' },
  ].map(k => kpiCard(k.label, k.value, k.color, k.sub)).join('');

  // Funnel
  const max = Math.max(leads, 1);
  const stages = [
    { label: 'Leads', count: leads, color: '#005a50', pct: 100 },
    { label: 'MQL<span style="text-transform:none">s</span>', count: mqls, color: '#0F6B5E', pct: (mqls / max * 100) },
    { label: 'SQL<span style="text-transform:none">s</span>', count: sqls, color: '#1A7B6B', pct: (sqls / max * 100) },
    { label: 'Won', count: won, color: '#F5A623', pct: (won / max * 100) },
  ];
  const l2m = leads > 0 ? (mqls/leads*100).toFixed(1) + '%' : '-';
  const m2s = mqls > 0 ? (sqls/mqls*100).toFixed(1) + '%' : '-';
  const s2w = sqls > 0 ? (won/sqls*100).toFixed(1) + '%' : '-';
  const l2mFL = leads > 0 ? (mqlsFromLeads/leads*100).toFixed(1) + '%' : '-';
  const m2sFL = mqlsFromLeads > 0 ? (sqlsFromLeads/mqlsFromLeads*100).toFixed(1) + '%' : '-';
  const s2wFL = sqlsFromLeads > 0 ? (wonFromLeads/sqlsFromLeads*100).toFixed(1) + '%' : '-';

  document.getElementById('funnelChart').innerHTML = stages.map(s => `
    <div class="flex items-center gap-3">
      <span class="funnel-label">${s.label}</span>
      <div class="funnel-track flex-1">
        <div class="funnel-fill" style="width:${Math.max(s.pct,5)}%;background:${s.color}">
          <span class="text-white text-xs font-bold">${fmt.number(s.count)}</span>
        </div>
      </div>
    </div>
  `).join('') + `
    <table class="mt-3 ml-14" style="border-spacing:0">
      <thead><tr>
        <th></th>
        <th class="text-center pb-1 px-3" style="min-width:90px">Lead &gt; MQL</th>
        <th class="text-center pb-1 px-3" style="min-width:90px">MQL &gt; SQL</th>
        <th class="text-center pb-1 px-3" style="min-width:90px">SQL &gt; Won</th>
      </tr></thead>
      <tbody>
        <tr>
          <td class="pr-2"><span class="conv-pill">All deals</span></td>
          <td class="text-center px-3 text-sm font-semibold text-as-secondary">${l2m}</td>
          <td class="text-center px-3 text-sm font-semibold text-as-secondary">${m2s}</td>
          <td class="text-center px-3 text-sm font-semibold text-as-secondary">${s2w}</td>
        </tr>
        <tr>
          <td class="pr-2"><span class="conv-pill" style="background:#E8ECF0">From lead</span></td>
          <td class="text-center px-3 text-sm font-semibold text-as-secondary">${l2mFL}</td>
          <td class="text-center px-3 text-sm font-semibold text-as-secondary">${m2sFL}</td>
          <td class="text-center px-3 text-sm font-semibold text-as-secondary">${s2wFL}</td>
        </tr>
      </tbody>
    </table>`;

  // Breakdown tables
  renderProductTable(deals, closedDeals, forms);
  renderBreakdownTable(deals, closedDeals, 'ownerTable', d => d.ownerName || 'Unknown');
  renderBreakdownTable(deals, closedDeals, 'geoTable', d => d.country || 'Unknown');
}

let productExpandState = {};

function sortIndicator(tableId, col) {
  const s = tableSortState[tableId];
  if (s.col !== col) return '';
  return s.dir === 'desc'
    ? ' <span class="text-as-primary">&#9662;</span>'
    : ' <span class="text-as-primary">&#9652;</span>';
}

function sortTableBy(tableId, col) {
  const s = tableSortState[tableId];
  if (s.col === col) { s.dir = s.dir === 'desc' ? 'asc' : 'desc'; }
  else { s.col = col; s.dir = col === 'name' ? 'asc' : 'desc'; }
  const weeks = getFilteredWeeks();
  const weekSet = new Set(weeks);
  const deals = getFilteredDeals(weekSet);
  const closedDeals = getClosedDeals(weekSet);
  if (tableId === 'productTable') {
    renderProductTable(deals, closedDeals, getFilteredForms(weekSet));
  } else {
    const keyFn = tableId === 'ownerTable' ? d => d.ownerName || 'Unknown' : d => d.country || 'Unknown';
    renderBreakdownTable(deals, closedDeals, tableId, keyFn);
  }
}

function renderProductTable(deals, closedDeals, forms) {
  function tally(dealList) {
    const t = { mqls: 0, sqls: 0, won: 0, wonRevenue: 0 };
    for (const d of dealList) {
      t.mqls++;
      if (['SQL', 'Customer'].includes(d.lifecycleStage)) t.sqls++;
      if (d.status === 'Won') { t.won++; t.wonRevenue += d.amount || 0; }
    }
    return t;
  }
  function closeTally(dealList) {
    return { won: dealList.length, wonRevenue: dealList.reduce((s, d) => s + (d.amount || 0), 0) };
  }
  function cells(t, ct, leads, size) {
    const cls = size === 'sm' ? 'text-sm' : 'text-xs';
    const aov = ct.won > 0 ? fmt.currency(Math.round(ct.wonRevenue / ct.won)) : '-';
    return `
      <td class="py-1.5 text-center text-as-secondary ${cls}">${typeof leads === 'number' ? fmt.number(leads) : '-'}</td>
      <td class="py-1.5 text-center text-as-secondary ${cls}">${fmt.number(t.mqls)}</td>
      <td class="py-1.5 text-center text-as-secondary ${cls}">${fmt.number(t.sqls)}</td>
      <td class="py-1.5 text-center text-as-secondary ${cls}">${fmt.number(ct.won)}</td>
      <td class="py-1.5 text-center font-semibold ${cls}">${fmt.currency(ct.wonRevenue)}</td>
      <td class="py-1.5 text-center text-as-secondary ${cls}">${aov}</td>`;
  }

  // Count leads by product from GA4 forms
  const leadsByProduct = {};
  for (const f of forms) {
    const p = f.product || 'Other';
    leadsByProduct[p] = (leadsByProduct[p] || 0) + f.count;
  }
  const totalLeads = forms.reduce((s, f) => s + f.count, 0);

  // Group deals by product
  const byProduct = {};
  for (const d of deals) {
    const p = d.product || 'Other';
    (byProduct[p] = byProduct[p] || []).push(d);
  }
  const closeByProduct = {};
  for (const d of closedDeals) {
    const p = d.product || 'Other';
    (closeByProduct[p] = closeByProduct[p] || []).push(d);
  }
  // Include products that only have leads or closed deals
  for (const p of Object.keys(leadsByProduct)) {
    if (!byProduct[p]) byProduct[p] = [];
  }
  for (const p of Object.keys(closeByProduct)) {
    if (!byProduct[p]) byProduct[p] = [];
  }
  // Compute per-product metrics for sorting
  const prodMetrics = {};
  for (const p of Object.keys(byProduct)) {
    const t = tally(byProduct[p]);
    const ct = closeTally(closeByProduct[p] || []);
    prodMetrics[p] = { leads: leadsByProduct[p] || 0, mqls: t.mqls, sqls: t.sqls, won: ct.won, revenue: ct.wonRevenue, aov: ct.won > 0 ? ct.wonRevenue / ct.won : 0 };
  }
  const ss = tableSortState.productTable;
  const products = Object.keys(byProduct).sort((a, b) => {
    const ma = prodMetrics[a], mb = prodMetrics[b];
    let va, vb;
    switch (ss.col) {
      case 'name': return ss.dir === 'asc' ? a.localeCompare(b) : b.localeCompare(a);
      case 'leads': va = ma.leads; vb = mb.leads; break;
      case 'mqls': va = ma.mqls; vb = mb.mqls; break;
      case 'sqls': va = ma.sqls; vb = mb.sqls; break;
      case 'won': va = ma.won; vb = mb.won; break;
      case 'aov': va = ma.aov; vb = mb.aov; break;
      default: va = ma.revenue; vb = mb.revenue;
    }
    return ss.dir === 'desc' ? vb - va : va - vb;
  });

  let html = '';
  for (const prod of products) {
    const prodDeals = byProduct[prod];
    const prodClosed = closeByProduct[prod] || [];
    const prodLeads = leadsByProduct[prod] || 0;
    html += `<tr class="border-b border-as-border/40 hover-row">
      <td class="py-2 text-sm font-semibold">${prod}</td>${cells(tally(prodDeals), closeTally(prodClosed), prodLeads, 'sm')}
    </tr>`;

    // Nested breakdown for Human-Made Transcription
    if (prod === 'Human-Made Transcription') {
      const byStyle = {};
      for (const d of prodDeals) {
        const s = d.transcriptionStyle || '(no style)';
        (byStyle[s] = byStyle[s] || []).push(d);
      }
      const closeByStyle = {};
      for (const d of prodClosed) {
        const s = d.transcriptionStyle || '(no style)';
        (closeByStyle[s] = closeByStyle[s] || []).push(d);
      }
      const styles = Object.keys(byStyle).sort((a, b) => byStyle[b].length - byStyle[a].length);
      for (const style of styles) {
        const styleDeals = byStyle[style];
        const styleClosed = closeByStyle[style] || [];
        const styleId = style.replace(/[^a-zA-Z]/g, '');

        // Check if this style has expandable options
        const byOpt = {};
        for (const d of styleDeals) {
          if (d.additionalOptions) {
            (byOpt[d.additionalOptions] = byOpt[d.additionalOptions] || []).push(d);
          }
        }
        const closeByOpt = {};
        for (const d of styleClosed) {
          if (d.additionalOptions) {
            (closeByOpt[d.additionalOptions] = closeByOpt[d.additionalOptions] || []).push(d);
          }
        }
        const opts = Object.keys(byOpt).sort((a, b) => byOpt[b].length - byOpt[a].length);
        const hasOpts = opts.length > 0;
        const expanded = productExpandState[styleId] || false;
        const chevron = hasOpts
          ? `<svg class="inline w-3 h-3 ml-1 transition-transform ${expanded ? 'rotate-90' : ''}" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>`
          : '';
        const clickAttr = hasOpts ? `style="cursor:pointer" onclick="toggleProductStyle('${styleId}')"` : '';

        html += `<tr class="border-b border-as-border/40 hover-row" ${clickAttr}>
          <td class="py-1.5 text-xs text-as-secondary pl-5">${style}${chevron}</td>${cells(tally(styleDeals), closeTally(styleClosed), '-', 'xs')}
        </tr>`;

        for (const opt of opts) {
          html += `<tr class="border-b border-as-border/40 hover-row prod-opt-${styleId}" ${expanded ? '' : 'style="display:none"'}>
            <td class="py-1 text-xs text-as-muted pl-10">${opt}</td>${cells(tally(byOpt[opt]), closeTally(closeByOpt[opt] || []), '-', 'xs')}
          </tr>`;
        }
      }
    }
  }
  const total = tally(deals);
  const closeTotal = closeTally(closedDeals);
  const totalAov = closeTotal.won > 0 ? fmt.currency(Math.round(closeTotal.wonRevenue / closeTotal.won)) : '-';
  html += `<tr class="border-t-2 border-as-border">
    <td class="py-2 text-sm font-bold">Total</td>
    <td class="py-2 text-center font-bold text-sm">${fmt.number(totalLeads)}</td>
    <td class="py-2 text-center font-bold text-sm">${fmt.number(total.mqls)}</td>
    <td class="py-2 text-center font-bold text-sm">${fmt.number(total.sqls)}</td>
    <td class="py-2 text-center font-bold text-sm">${fmt.number(closeTotal.won)}</td>
    <td class="py-2 text-center font-bold text-sm">${fmt.currency(closeTotal.wonRevenue)}</td>
    <td class="py-2 text-center font-bold text-sm">${totalAov}</td>
  </tr>`;
  document.querySelector('#productTable thead tr').innerHTML = `
    <th class="pb-2 sortable" onclick="sortTableBy('productTable','name')">Product${sortIndicator('productTable','name')}</th>
    <th class="pb-2 text-center sortable" onclick="sortTableBy('productTable','leads')">Leads${sortIndicator('productTable','leads')}</th>
    <th class="pb-2 text-center sortable" onclick="sortTableBy('productTable','mqls')">MQL<span style="text-transform:none">s</span>${sortIndicator('productTable','mqls')}</th>
    <th class="pb-2 text-center sortable" onclick="sortTableBy('productTable','sqls')">SQL<span style="text-transform:none">s</span>${sortIndicator('productTable','sqls')}</th>
    <th class="pb-2 text-center sortable" onclick="sortTableBy('productTable','won')">Won${sortIndicator('productTable','won')}</th>
    <th class="pb-2 text-center sortable" onclick="sortTableBy('productTable','revenue')">Revenue${sortIndicator('productTable','revenue')}</th>
    <th class="pb-2 text-center sortable" onclick="sortTableBy('productTable','aov')">AOV${sortIndicator('productTable','aov')}</th>`;
  document.querySelector('#productTable tbody').innerHTML = html;
}

function toggleProductStyle(styleId) {
  productExpandState[styleId] = !productExpandState[styleId];
  const rows = document.querySelectorAll(`.prod-opt-${styleId}`);
  const show = productExpandState[styleId];
  rows.forEach(r => r.style.display = show ? '' : 'none');
  // Rotate chevron
  const parentRow = rows[0]?.previousElementSibling;
  if (parentRow) {
    const svg = parentRow.querySelector('svg');
    if (svg) svg.classList.toggle('rotate-90', show);
  }
}

function renderBreakdownTable(deals, closedDeals, tableId, keyFn) {
  const totals = {};
  for (const d of deals) {
    const key = keyFn(d);
    if (!totals[key]) totals[key] = { mqls: 0, sqls: 0, won: 0, wonRevenue: 0, wonClose: 0, wonRevClose: 0 };
    totals[key].mqls++;
    if (['SQL', 'Customer'].includes(d.lifecycleStage)) totals[key].sqls++;
    if (d.status === 'Won') { totals[key].won++; totals[key].wonRevenue += d.amount || 0; }
  }
  for (const d of closedDeals) {
    const key = keyFn(d);
    if (!totals[key]) totals[key] = { mqls: 0, sqls: 0, won: 0, wonRevenue: 0, wonClose: 0, wonRevClose: 0 };
    totals[key].wonClose++;
    totals[key].wonRevClose += d.amount || 0;
  }
  const ss = tableSortState[tableId];
  const keys = Object.keys(totals).sort((a, b) => {
    let va, vb;
    switch (ss.col) {
      case 'name': return ss.dir === 'asc' ? a.localeCompare(b) : b.localeCompare(a);
      case 'mqls': va = totals[a].mqls; vb = totals[b].mqls; break;
      case 'sqls': va = totals[a].sqls; vb = totals[b].sqls; break;
      case 'won': va = totals[a].wonClose; vb = totals[b].wonClose; break;
      case 'aov': va = totals[a].wonClose > 0 ? totals[a].wonRevClose / totals[a].wonClose : 0; vb = totals[b].wonClose > 0 ? totals[b].wonRevClose / totals[b].wonClose : 0; break;
      default: va = totals[a].wonRevClose; vb = totals[b].wonRevClose;
    }
    return ss.dir === 'desc' ? vb - va : va - vb;
  });
  const sum = { mqls: 0, sqls: 0, won: 0, wonRevenue: 0, wonClose: 0, wonRevClose: 0 };
  for (const k of keys) { sum.mqls += totals[k].mqls; sum.sqls += totals[k].sqls; sum.won += totals[k].won; sum.wonRevenue += totals[k].wonRevenue; sum.wonClose += totals[k].wonClose; sum.wonRevClose += totals[k].wonRevClose; }

  const isGeo = tableId === 'geoTable';
  const SHOW_LIMIT = 4;

  const rows = keys.map((k, i) => {
    const d = totals[k];
    const extra = (isGeo && i >= SHOW_LIMIT) ? ' geo-extra-row hidden' : '';
    const aov = d.wonClose > 0 ? fmt.currency(Math.round(d.wonRevClose / d.wonClose)) : '-';
    return `<tr class="border-b border-as-border/40 hover-row${extra}">
      <td class="py-2 font-medium text-sm">${k}</td>
      <td class="py-2 text-center text-as-secondary">${fmt.number(d.mqls)}</td>
      <td class="py-2 text-center text-as-secondary">${fmt.number(d.sqls)}</td>
      <td class="py-2 text-center text-as-secondary">${fmt.number(d.wonClose)}</td>
      <td class="py-2 text-center font-semibold">${fmt.currency(d.wonRevClose)}</td>
      <td class="py-2 text-center text-as-secondary">${aov}</td>
    </tr>`;
  }).join('');

  const showMore = (isGeo && keys.length > SHOW_LIMIT)
    ? `<tr class="geo-show-more border-b border-as-border/40 cursor-pointer hover-row" onclick="toggleGeoShowMore()">
        <td colspan="6" class="py-2 text-center text-as-primary text-sm font-semibold">Show ${keys.length - SHOW_LIMIT} more countries <svg class="inline w-3 h-3 ml-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg></td>
      </tr>` : '';

  const sumAov = sum.wonClose > 0 ? fmt.currency(Math.round(sum.wonRevClose / sum.wonClose)) : '-';
  const totalRow = `<tr class="border-t-2 border-as-border">
    <td class="py-2 font-bold text-sm">Total</td>
    <td class="py-2 text-center font-bold text-sm">${fmt.number(sum.mqls)}</td>
    <td class="py-2 text-center font-bold text-sm">${fmt.number(sum.sqls)}</td>
    <td class="py-2 text-center font-bold text-sm">${fmt.number(sum.wonClose)}</td>
    <td class="py-2 text-center font-bold text-sm">${fmt.currency(sum.wonRevClose)}</td>
    <td class="py-2 text-center font-bold text-sm">${sumAov}</td>
  </tr>`;

  const labelCol = tableId === 'ownerTable' ? 'Owner' : 'Country';
  document.querySelector(`#${tableId} thead tr`).innerHTML = `
    <th class="pb-2 sortable" onclick="sortTableBy('${tableId}','name')">${labelCol}${sortIndicator(tableId,'name')}</th>
    <th class="pb-2 text-center sortable" onclick="sortTableBy('${tableId}','mqls')">MQL<span style="text-transform:none">s</span>${sortIndicator(tableId,'mqls')}</th>
    <th class="pb-2 text-center sortable" onclick="sortTableBy('${tableId}','sqls')">SQL<span style="text-transform:none">s</span>${sortIndicator(tableId,'sqls')}</th>
    <th class="pb-2 text-center sortable" onclick="sortTableBy('${tableId}','won')">Won${sortIndicator(tableId,'won')}</th>
    <th class="pb-2 text-center sortable" onclick="sortTableBy('${tableId}','revenue')">Revenue${sortIndicator(tableId,'revenue')}</th>
    <th class="pb-2 text-center sortable" onclick="sortTableBy('${tableId}','aov')">AOV${sortIndicator(tableId,'aov')}</th>`;
  document.querySelector(`#${tableId} tbody`).innerHTML = rows + showMore;
  document.getElementById(`${tableId}Total`).innerHTML = `<table class="w-full">
    <colgroup><col><col style="width:12%"><col style="width:12%"><col style="width:12%"><col style="width:22%"><col style="width:14%"></colgroup>
    ${totalRow}
  </table>`;
}

function toggleGeoShowMore() {
  const rows = document.querySelectorAll('.geo-extra-row');
  const btn = document.querySelector('.geo-show-more');
  const isHidden = rows[0]?.classList.contains('hidden');
  rows.forEach(r => r.classList.toggle('hidden'));
  if (btn) {
    const td = btn.querySelector('td');
    if (isHidden) {
      td.innerHTML = 'Show fewer <svg class="inline w-3 h-3 ml-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7"/></svg>';
    } else {
      td.innerHTML = `Show ${rows.length} more countries <svg class="inline w-3 h-3 ml-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>`;
    }
  }
}

// ===== GOOGLE ADS =====
function renderGoogleAds(weeks) {
  const bu = getCurrentBU();
  const ads = filterByWeeks(DATA.weekly.ads, weeks);
  const stripe = filterByWeeks(DATA.weekly.stripe, weeks);

  const totalCost = ads.reduce((s, r) => s + (r.byBU?.[bu]?.totalCost || 0), 0);
  const mmCost = ads.reduce((s, r) => s + (r.byBU?.[bu]?.mmCost || 0), 0);
  const hmCost = ads.reduce((s, r) => s + (r.byBU?.[bu]?.hmCost || 0), 0);
  const brandCost = ads.reduce((s, r) => s + (r.byBU?.[bu]?.brandCost || 0), 0);

  const stripeRev = bu === 'Transcription'
    ? stripe.reduce((s, r) => s + r.totalRevenue, 0) : 0;
  const roas = totalCost > 0 && stripeRev > 0 ? (stripeRev / totalCost).toFixed(1) + 'x' : '-';

  document.getElementById('adsKPIs').innerHTML = [
    { label: 'Total Spend', value: fmt.currency(totalCost), color: '#E03E3E' },
    { label: 'ROAS', value: roas, color: '#1A7B6B' },
    { label: 'Machine-Made', value: fmt.currency(mmCost), color: '#1A7B6B' },
    { label: 'Human-Made', value: fmt.currency(hmCost), color: '#7B1FA2' },
  ].map(k => kpiCard(k.label, k.value, k.color)).join('');

  destroyChart('mmVsHmChart');
  charts.mmVsHmChart = new Chart(document.getElementById('mmVsHmChart'), {
    type: 'bar',
    data: {
      labels: ads.map(r => fmt.shortDate(r.week)),
      datasets: [
        { label: 'Machine-Made', data: ads.map(r => r.byBU?.[bu]?.mmCost || 0), backgroundColor: 'rgba(26,123,107,0.2)', borderColor: '#1A7B6B', borderWidth: 1.5, borderRadius: 3 },
        { label: 'Human-Made', data: ads.map(r => r.byBU?.[bu]?.hmCost || 0), backgroundColor: 'rgba(123,31,162,0.2)', borderColor: '#7B1FA2', borderWidth: 1.5, borderRadius: 3 },
        { label: 'Brand', data: ads.map(r => r.byBU?.[bu]?.brandCost || 0), backgroundColor: 'rgba(245,166,35,0.2)', borderColor: '#F5A623', borderWidth: 1.5, borderRadius: 3 },
      ],
    },
    options: { ...chartOptions('EUR'), scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true, beginAtZero: true, grid: { color: 'rgba(0,0,0,0.04)' } } } },
  });

  const productTotals = {};
  for (const row of ads) {
    for (const [prod, cost] of Object.entries(row.byProduct || {})) {
      if (getBU(prod) !== bu) continue;
      productTotals[prod] = (productTotals[prod] || 0) + cost;
    }
  }
  const products = Object.keys(productTotals).sort((a, b) => productTotals[b] - productTotals[a]);
  const prodColors = ['#1A7B6B', '#F5A623', '#7B1FA2', '#005a50', '#2E7D32', '#E65100', '#0061FF', '#8899A6'];
  destroyChart('adProductChart');
  charts.adProductChart = new Chart(document.getElementById('adProductChart'), {
    type: 'doughnut',
    data: {
      labels: products,
      datasets: [{
        data: products.map(p => Math.round(productTotals[p])),
        backgroundColor: products.map((_, i) => prodColors[i % prodColors.length]),
        borderWidth: 0,
      }],
    },
    options: doughnutOptions(),
  });
}

// ===== CHART HELPERS =====
function chartOptions(prefix) {
  return {
    responsive: true, maintainAspectRatio: false,
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: { position: 'top', labels: { usePointStyle: true, pointStyleWidth: 10, font: { size: 11, family: '"Plus Jakarta Sans"', weight: 500 }, padding: 16 } },
      tooltip: {
        backgroundColor: '#0F1419',
        titleFont: { family: '"Plus Jakarta Sans"', size: 12, weight: 600 },
        bodyFont: { family: '"Plus Jakarta Sans"', size: 11 },
        cornerRadius: 8,
        padding: 10,
        callbacks: {
          label: ctx => {
            const val = typeof ctx.raw === 'number' ? (prefix ? `${prefix} ${ctx.raw.toLocaleString()}` : ctx.raw.toLocaleString()) : ctx.raw;
            return ` ${ctx.dataset.label}: ${val}`;
          },
        },
      },
    },
    scales: {
      x: { grid: { display: false }, ticks: { font: { size: 11, family: '"Plus Jakarta Sans"' } } },
      y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { size: 11, family: '"Plus Jakarta Sans"' } } },
    },
  };
}

function doughnutOptions() {
  return {
    responsive: true, maintainAspectRatio: false,
    cutout: '65%',
    plugins: {
      legend: { position: 'right', labels: { font: { size: 11, family: '"Plus Jakarta Sans"', weight: 500 }, padding: 12, usePointStyle: true, pointStyleWidth: 8 } },
      tooltip: {
        backgroundColor: '#0F1419',
        titleFont: { family: '"Plus Jakarta Sans"', size: 12, weight: 600 },
        bodyFont: { family: '"Plus Jakarta Sans"', size: 11 },
        cornerRadius: 8,
        callbacks: { label: ctx => ` ${ctx.label}: ${fmt.currency(ctx.raw)}` },
      },
    },
  };
}

function destroyChart(id) {
  if (charts[id]) { charts[id].destroy(); delete charts[id]; }
}

// ===== RAW DATA OVERLAY =====
let rawDataTab = 'deals';
const RAW_TABS = [
  { id: 'deals', label: 'Deals' },
  { id: 'forms', label: 'Form Submissions' },
  { id: 'stripe', label: 'Stripe (Weekly)' },
  { id: 'subs', label: 'Subscriptions' },
  { id: 'ads', label: 'Google Ads (Weekly)' },
];

function openRawData() {
  document.getElementById('rawDataOverlay').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  renderRawTabs();
  renderRawTable();
}
function closeRawData() {
  document.getElementById('rawDataOverlay').classList.add('hidden');
  document.body.style.overflow = '';
}
function switchRawTab(tab) {
  rawDataTab = tab;
  renderRawTabs();
  renderRawTable();
}
function renderRawTabs() {
  document.getElementById('rawDataTabs').innerHTML = RAW_TABS.map(t =>
    `<button onclick="switchRawTab('${t.id}')" class="px-3 py-1.5 text-sm font-medium rounded-lg transition-colors ${rawDataTab === t.id ? 'bg-as-primary text-white' : 'text-gray-600 hover:bg-gray-200'}">${t.label}</button>`
  ).join('');
}

function getRawData() {
  if (!DATA) return { headers: [], rows: [] };
  const weeks = getFilteredWeeks();
  const weekSet = new Set(weeks);

  switch (rawDataTab) {
    case 'deals': {
      const deals = (DATA.deals || []).filter(d => weekSet.has(d.week));
      return {
        headers: ['Week', 'Close Week', 'Product', 'Style', 'Options', 'Country', 'Channel', 'Owner', 'Stage', 'Status', 'Amount'],
        rows: deals.map(d => [d.week, d.closeWeek, d.product, d.transcriptionStyle, d.additionalOptions, d.country, d.channel, d.ownerName, d.lifecycleStage, d.status, d.amount]),
      };
    }
    case 'forms': {
      const forms = (DATA.ga4Forms || []).filter(f => weekSet.has(f.week));
      return {
        headers: ['Week', 'Country', 'Channel', 'Product', 'BU', 'Count'],
        rows: forms.map(f => [f.week, f.country, f.channel, f.product, f.bu, f.count]),
      };
    }
    case 'stripe': {
      const stripe = filterByWeeks(DATA.weekly.stripe, weeks);
      return {
        headers: ['Week', 'Payments', 'Revenue', 'By Product', 'By Plan Type', 'By Country', 'By Channel'],
        rows: stripe.map(r => [
          r.week, r.count, r.totalRevenue,
          Object.entries(r.byProduct || {}).map(([k, v]) => `${k}: ${v.count} / ${fmt.currency(v.revenue)}`).join('; '),
          Object.entries(r.byPlanType || {}).map(([k, v]) => `${k}: ${v.count} / ${fmt.currency(v.revenue)}`).join('; '),
          Object.entries(r.byCountry || {}).map(([k, v]) => `${k}: ${v.count} / ${fmt.currency(v.revenue)}`).join('; '),
          Object.entries(r.byChannel || {}).map(([k, v]) => `${k}: ${v.count} / ${fmt.currency(v.revenue)}`).join('; '),
        ]),
      };
    }
    case 'subs': {
      const subs = filterByWeeks(DATA.weekly.subs || [], weeks);
      const snap = DATA.subSnapshot;
      const snapRow = snap ? [['Current', '-', '-', snap.totalActiveSubs, '-', '-', fmt.currency(snap.mrr)]] : [];
      return {
        headers: ['Week', 'New Subs', 'New MRR', 'Churned Subs', 'Churned MRR', 'Net MRR', 'MRR'],
        rows: [...subs.map(s => [s.week, s.newSubs, fmt.currency(s.newMrr), s.churnedSubs, fmt.currency(s.churnedMrr), fmt.currency(s.netMrr), '-']), ...snapRow],
      };
    }
    case 'ads': {
      const ads = filterByWeeks(DATA.weekly.ads, weeks);
      return {
        headers: ['Week', 'Total Cost', 'MM Cost', 'HM Cost', 'Brand Cost', 'By Country', 'By Product'],
        rows: ads.map(r => [
          r.week, fmt.currency(r.totalCost), fmt.currency(r.mmCost), fmt.currency(r.hmCost), fmt.currency(r.brandCost),
          Object.entries(r.byCountry || {}).map(([k, v]) => `${k}: ${fmt.currency(v)}`).join('; '),
          Object.entries(r.byProduct || {}).map(([k, v]) => `${k}: ${fmt.currency(v)}`).join('; '),
        ]),
      };
    }
    default: return { headers: [], rows: [] };
  }
}

function renderRawTable() {
  const { headers, rows } = getRawData();
  const el = document.getElementById('rawDataContent');
  if (rows.length === 0) {
    el.innerHTML = '<p class="text-gray-500 text-center py-12">No data for selected date range</p>';
    return;
  }
  el.innerHTML = `
    <p class="text-sm text-gray-500 mb-3">${rows.length} rows</p>
    <table class="w-full text-sm border-collapse">
      <thead><tr class="border-b-2 border-gray-200 bg-gray-50 sticky top-0">
        ${headers.map(h => `<th class="py-2 px-3 text-left font-semibold text-gray-700 whitespace-nowrap">${h}</th>`).join('')}
      </tr></thead>
      <tbody>
        ${rows.map(r => `<tr class="border-b border-gray-100 hover:bg-gray-50">${r.map(v => `<td class="py-1.5 px-3 text-gray-700 whitespace-nowrap">${v ?? ''}</td>`).join('')}</tr>`).join('')}
      </tbody>
    </table>`;
}

function downloadRawCSV() {
  const { headers, rows } = getRawData();
  const esc = v => { const s = String(v ?? ''); return s.includes(',') || s.includes('"') || s.includes('\n') ? '"' + s.replace(/"/g, '""') + '"' : s; };
  const csv = [headers.map(esc).join(','), ...rows.map(r => r.map(esc).join(','))].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `amberscript-${rawDataTab}-${new Date().toISOString().slice(0, 10)}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

// ===== EVENTS =====
document.getElementById('dateRange').addEventListener('change', () => { if (DATA) render(); });

loadData();
</script>
</body>
</html>
