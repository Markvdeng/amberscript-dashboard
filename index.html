<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amberscript Marketing Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            as: {
              primary: '#1A7B6B',
              hover: '#155F54',
              accent: '#F5A623',
              bg: '#F5F5F5',
              border: '#E0E0E0',
              text: '#1A1A1A',
              secondary: '#666666',
              muted: '#999999',
              success: '#2E7D32',
              purple: '#7B1FA2',
            }
          },
          fontFamily: {
            sans: ['"DM Sans"', 'system-ui', 'sans-serif'],
          },
          borderRadius: { card: '8px' },
        }
      }
    }
  </script>
  <style>
    body { background: #F5F5F5; color: #1A1A1A; }
    .card { background: #fff; border: 1px solid #E0E0E0; border-radius: 8px; padding: 24px; }
    .kpi-card { transition: transform 0.15s ease, border-color 0.15s ease; }
    .kpi-card:hover { transform: translateY(-2px); border-color: #1A7B6B; }
    .chart-container { position: relative; min-height: 280px; }
    .funnel-bar { transition: width 0.6s ease; }
    .section-title { font-size: 1.25rem; font-weight: 500; color: #1A1A1A; border-bottom: 2px solid #1A7B6B; padding-bottom: 8px; margin-bottom: 24px; }
    .sub-title { font-size: 1rem; font-weight: 500; color: #666666; margin-bottom: 16px; }
    .pill { display: inline-block; padding: 6px 14px; border-radius: 20px; font-size: 0.8125rem; font-weight: 500; cursor: pointer; border: 1px solid #E0E0E0; color: #666666; background: #fff; transition: all 0.15s ease; }
    .pill:hover { border-color: #1A7B6B; color: #1A7B6B; }
    .pill.active { background: #1A7B6B; color: #fff; border-color: #1A7B6B; }
    .pill-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
    .toggle-btn { padding: 4px 12px; font-size: 0.8125rem; font-weight: 500; border: 1px solid #E0E0E0; cursor: pointer; color: #666; background: #fff; }
    .toggle-btn:first-child { border-radius: 6px 0 0 6px; }
    .toggle-btn:last-child { border-radius: 0 6px 6px 0; }
    .toggle-btn.active { background: #1A7B6B; color: #fff; border-color: #1A7B6B; }
    th { color: #999999; font-weight: 500; font-size: 0.8125rem; }
    td { font-size: 0.8125rem; }
    select { font-size: 0.875rem; }
  </style>
</head>
<body class="font-sans">

  <!-- Header -->
  <header class="bg-as-primary text-white">
    <div class="max-w-7xl mx-auto px-4 py-5 sm:px-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
      <div>
        <h1 class="text-xl font-medium tracking-tight">Amberscript Marketing Dashboard</h1>
        <p class="text-white/60 text-xs mt-1" id="lastUpdated">Loading...</p>
      </div>
      <select id="dateRange" class="bg-white/10 border border-white/20 text-white rounded-card px-3 py-1.5 text-sm">
        <option value="this-week">This week</option>
        <option value="last-week">Last week</option>
        <option value="last-2-weeks">Last 2 weeks</option>
        <option value="last-4-weeks" selected>Last 4 weeks</option>
        <option value="this-month">This month</option>
        <option value="last-month">Last month</option>
        <option value="last-2-months">Last 2 months</option>
        <option value="last-4-months">Last 4 months</option>
        <option value="all">All time</option>
      </select>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8 space-y-10">

    <!-- ============================================ -->
    <!-- SUMMARY TABLE                                -->
    <!-- ============================================ -->
    <section class="card">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-medium text-as-text">Summary</h2>
        <div class="flex">
          <button class="toggle-btn active" data-view="monthly" onclick="toggleSummary('monthly')">Monthly</button>
          <button class="toggle-btn" data-view="weekly" onclick="toggleSummary('weekly')">Weekly</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table id="summaryTable" class="w-full">
          <thead class="text-left border-b border-as-border"><tr id="summaryHead"></tr></thead>
          <tbody id="summaryBody"></tbody>
        </table>
      </div>
    </section>

    <!-- ============================================ -->
    <!-- TRANSCRIPTION & MEDIA                        -->
    <!-- ============================================ -->
    <div>
      <h2 class="section-title">Transcription & Media</h2>

      <!-- ---- Self-Serve (Stripe) ---- -->
      <div class="mb-10">
        <h3 class="sub-title">Self-Serve</h3>

        <!-- Filters -->
        <div class="pill-group" id="selfServeFilters">
          <span class="pill active" data-filter="all" onclick="setFilter('all')">All</span>
          <span class="pill" data-filter="prepaid" onclick="setFilter('prepaid')">Prepaid</span>
          <span class="pill" data-filter="prepaid-topup" onclick="setFilter('prepaid-topup')">Top-Up</span>
          <span class="pill" data-filter="prepaid-job" onclick="setFilter('prepaid-job')">Job Creation</span>
          <span class="pill" data-filter="subscription" onclick="setFilter('subscription')">Subscription</span>
          <span class="pill" data-filter="sub-update" onclick="setFilter('sub-update')">Sub Update</span>
          <span class="pill" data-filter="sub-creation" onclick="setFilter('sub-creation')">Sub Creation</span>
          <span class="pill" data-filter="human-made" onclick="setFilter('human-made')">Human-Made</span>
          <span class="pill" data-filter="invoice" onclick="setFilter('invoice')">Invoice</span>
        </div>

        <!-- KPIs -->
        <div id="selfServeKPIs" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6"></div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card">
            <h4 class="text-sm font-medium text-as-secondary mb-3">Revenue Trend</h4>
            <div class="chart-container"><canvas id="selfServeRevenueChart"></canvas></div>
          </div>
          <div class="card">
            <h4 class="text-sm font-medium text-as-secondary mb-3">Revenue by Channel</h4>
            <div class="chart-container"><canvas id="selfServeChannelChart"></canvas></div>
          </div>
        </div>
      </div>

      <!-- ---- Inbound (HubSpot) ---- -->
      <div>
        <h3 class="sub-title">Inbound</h3>

        <!-- KPIs -->
        <div id="inboundKPIs" class="grid grid-cols-2 sm:grid-cols-5 gap-4 mb-6"></div>

        <!-- Funnel -->
        <div class="card mb-6">
          <h4 class="text-sm font-medium text-as-secondary mb-3">Sales Funnel</h4>
          <div id="funnelChart" class="space-y-3"></div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card">
            <h4 class="text-sm font-medium text-as-secondary mb-3">Weekly Leads & SQLs</h4>
            <div class="chart-container"><canvas id="funnelTrendChart"></canvas></div>
          </div>
          <div class="card">
            <h4 class="text-sm font-medium text-as-secondary mb-3">Leads by Channel</h4>
            <div class="chart-container"><canvas id="channelChart"></canvas></div>
          </div>
        </div>

        <!-- Geo Table -->
        <div class="card mt-6">
          <h4 class="text-sm font-medium text-as-secondary mb-3">Performance by Country</h4>
          <div class="overflow-x-auto">
            <table id="geoTable" class="w-full">
              <thead class="text-left border-b border-as-border">
                <tr>
                  <th class="pb-2">Country</th>
                  <th class="pb-2 text-right">Leads</th>
                  <th class="pb-2 text-right">SQLs</th>
                  <th class="pb-2 text-right">Won</th>
                  <th class="pb-2 text-right">Revenue</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- GOOGLE ADS                                   -->
    <!-- ============================================ -->
    <div>
      <h2 class="section-title">Google Ads</h2>

      <div id="adsKPIs" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6"></div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card">
          <h4 class="text-sm font-medium text-as-secondary mb-3">Ad Spend: Machine-Made vs Human-Made</h4>
          <div class="chart-container"><canvas id="mmVsHmChart"></canvas></div>
        </div>
        <div class="card">
          <h4 class="text-sm font-medium text-as-secondary mb-3">Ad Spend by Product</h4>
          <div class="chart-container"><canvas id="adProductChart"></canvas></div>
        </div>
      </div>
    </div>

  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 py-8 text-center text-as-muted text-xs">
    Auto-updated daily via GitHub Actions. Data from Google Ads, HubSpot, Stripe, GA4.
  </footer>

<script>
let DATA = null;
let charts = {};
let currentFilter = 'all';
let summaryView = 'monthly';

const CHANNEL_COLORS = {
  'Direct': '#1A7B6B', 'Paid Search': '#005a50', 'Organic Search': '#2E7D32',
  'Referral': '#F5A623', 'Email': '#E69100', 'Subscription': '#7B1FA2',
  'Unknown': '#999999', 'Organic Video': '#0061FF', 'Affiliates': '#155F54',
  'Organic Social': '#E65100', 'Cross-network': '#5C6BC0', 'Unassigned': '#E0E0E0',
};

const fmt = {
  currency: (n) => new Intl.NumberFormat('en-EU', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n),
  number: (n) => new Intl.NumberFormat('en-US').format(n),
  pct: (n) => n.toFixed(1) + '%',
  shortDate: (d) => {
    const date = new Date(d + 'T00:00:00');
    return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
  },
  monthLabel: (m) => {
    const [y, mo] = m.split('-');
    return new Date(parseInt(y), parseInt(mo) - 1).toLocaleDateString('en-GB', { month: 'short', year: '2-digit' });
  },
};

// ===== DATA LOADING =====
async function loadData() {
  try {
    const res = await fetch('data.json');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    DATA = await res.json();
    render();
  } catch (err) {
    document.getElementById('lastUpdated').textContent = 'Error loading data: ' + err.message;
  }
}

// ===== DATE FILTERING =====
function getFilteredWeeks() {
  const mode = document.getElementById('dateRange').value;
  const allWeeks = DATA.weekly.ads.map(r => r.week).filter(Boolean);
  if (!allWeeks.length || mode === 'all') return allWeeks;

  const today = new Date();
  const dayOfWeek = today.getUTCDay() || 7;
  const thisMonday = new Date(today);
  thisMonday.setUTCDate(today.getUTCDate() - dayOfWeek + 1);
  const thisMondayStr = thisMonday.toISOString().slice(0, 10);
  const firstOfMonth = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), 1));

  if (mode === 'this-week') return allWeeks.filter(w => w >= thisMondayStr);
  if (mode === 'last-week') { const s = new Date(thisMonday); s.setUTCDate(s.getUTCDate()-7); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < thisMondayStr); }
  if (mode === 'last-2-weeks') { const s = new Date(thisMonday); s.setUTCDate(s.getUTCDate()-14); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < thisMondayStr); }
  if (mode === 'last-4-weeks') { const s = new Date(thisMonday); s.setUTCDate(s.getUTCDate()-28); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < thisMondayStr); }
  if (mode === 'this-month') return allWeeks.filter(w => w >= firstOfMonth.toISOString().slice(0,10));
  if (mode === 'last-month') { const s = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth()-1, 1)); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < firstOfMonth.toISOString().slice(0,10)); }
  if (mode === 'last-2-months') { const s = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth()-2, 1)); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < firstOfMonth.toISOString().slice(0,10)); }
  if (mode === 'last-4-months') { const s = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth()-4, 1)); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < firstOfMonth.toISOString().slice(0,10)); }
  return allWeeks;
}

function filterByWeeks(arr, weeks) {
  const set = new Set(weeks);
  return arr.filter(r => set.has(r.week));
}

// ===== INTERACTIONS =====
function setFilter(filter) {
  currentFilter = filter;
  document.querySelectorAll('#selfServeFilters .pill').forEach(p => {
    p.classList.toggle('active', p.dataset.filter === filter);
  });
  renderSelfServe(getFilteredWeeks());
}

function toggleSummary(view) {
  summaryView = view;
  document.querySelectorAll('.toggle-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.view === view);
  });
  renderSummaryTable(getFilteredWeeks());
}

// ===== MAIN RENDER =====
function render() {
  const weeks = getFilteredWeeks();
  document.getElementById('lastUpdated').textContent =
    `Last updated: ${new Date(DATA.updatedAt).toLocaleString('en-GB')} | ${DATA.dateRange.start} to ${DATA.dateRange.end}`;

  renderSummaryTable(weeks);
  renderSelfServe(weeks);
  renderInbound(weeks);
  renderGoogleAds(weeks);
}

// ===== SUMMARY TABLE =====
function renderSummaryTable(weeks) {
  const head = document.getElementById('summaryHead');
  const body = document.getElementById('summaryBody');

  if (summaryView === 'monthly') {
    head.innerHTML = `
      <th class="pb-2">Month</th>
      <th class="pb-2 text-right">Ad Spend</th>
      <th class="pb-2 text-right">Stripe Rev</th>
      <th class="pb-2 text-right">ROAS</th>
      <th class="pb-2 text-right">Forms</th>
      <th class="pb-2 text-right">Leads</th>
      <th class="pb-2 text-right">SQLs</th>
      <th class="pb-2 text-right">Won</th>
      <th class="pb-2 text-right">Deal Rev</th>
      <th class="pb-2 text-right">Lead>SQL</th>
      <th class="pb-2 text-right">SQL>Won</th>
    `;
    body.innerHTML = (DATA.monthly || []).map(m => {
      const roas = m.adsCost > 0 ? (m.stripeRevenue / m.adsCost).toFixed(1) + 'x' : '-';
      return `<tr class="border-b border-as-border/30 hover:bg-as-bg">
        <td class="py-2 font-medium">${fmt.monthLabel(m.month)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.currency(m.adsCost)}</td>
        <td class="py-2 text-right font-medium">${fmt.currency(m.stripeRevenue)}</td>
        <td class="py-2 text-right text-as-primary font-medium">${roas}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(m.formSubmissions)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(m.leads)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(m.sqls)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(m.won)}</td>
        <td class="py-2 text-right font-medium">${fmt.currency(m.wonRevenue)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.pct(m.leadToSql)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.pct(m.sqlToWon)}</td>
      </tr>`;
    }).join('');
  } else {
    // Weekly view
    const ads = filterByWeeks(DATA.weekly.ads, weeks);
    const funnel = filterByWeeks(DATA.weekly.funnel, weeks);
    const stripe = filterByWeeks(DATA.weekly.stripe, weeks);
    const ga4 = filterByWeeks(DATA.weekly.ga4, weeks);

    const adsMap = Object.fromEntries(ads.map(r => [r.week, r]));
    const funnelMap = Object.fromEntries(funnel.map(r => [r.week, r]));
    const stripeMap = Object.fromEntries(stripe.map(r => [r.week, r]));
    const ga4Map = Object.fromEntries(ga4.map(r => [r.week, r]));

    head.innerHTML = `
      <th class="pb-2">Week</th>
      <th class="pb-2 text-right">Ad Spend</th>
      <th class="pb-2 text-right">Stripe Rev</th>
      <th class="pb-2 text-right">Payments</th>
      <th class="pb-2 text-right">Forms</th>
      <th class="pb-2 text-right">Leads</th>
      <th class="pb-2 text-right">SQLs</th>
      <th class="pb-2 text-right">Won</th>
      <th class="pb-2 text-right">Deal Rev</th>
    `;
    body.innerHTML = weeks.map(w => {
      const a = adsMap[w] || {};
      const f = funnelMap[w] || {};
      const s = stripeMap[w] || {};
      const g = ga4Map[w] || {};
      return `<tr class="border-b border-as-border/30 hover:bg-as-bg">
        <td class="py-2 font-medium">${fmt.shortDate(w)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.currency(a.totalCost || 0)}</td>
        <td class="py-2 text-right font-medium">${fmt.currency(s.totalRevenue || 0)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(s.count || 0)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(g.formSubmissions || 0)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(f.leads || 0)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(f.sqls || 0)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(f.won || 0)}</td>
        <td class="py-2 text-right font-medium">${fmt.currency(f.wonRevenue || 0)}</td>
      </tr>`;
    }).join('');
  }
}

// ===== SELF-SERVE (Stripe) =====
function renderSelfServe(weeks) {
  const stripe = filterByWeeks(DATA.weekly.stripe, weeks);
  const f = currentFilter;

  // KPIs from segment
  let totalPayments = 0, totalRevenue = 0, newSubs = 0;
  for (const row of stripe) {
    const seg = row.seg || {};
    const s = seg[f] || { count: 0, revenue: 0 };
    totalPayments += s.count;
    totalRevenue += s.revenue;
    // New subs: sub-creation segment count
    if (f === 'all' || f === 'subscription' || f === 'sub-creation') {
      newSubs += (seg['sub-creation'] || { count: 0 }).count;
    }
  }

  document.getElementById('selfServeKPIs').innerHTML = [
    { label: 'Payments', value: fmt.number(totalPayments), color: '#1A1A1A' },
    { label: 'Revenue', value: fmt.currency(totalRevenue), color: '#1A7B6B' },
    { label: 'New Subscriptions', value: fmt.number(newSubs), color: '#7B1FA2' },
    { label: 'Active Subscriptions', value: 'Coming soon', color: '#999999' },
  ].map(k => `
    <div class="kpi-card card !p-4">
      <p class="text-xs font-medium uppercase tracking-wide text-as-muted">${k.label}</p>
      <p class="text-lg font-bold mt-1" style="color: ${k.color}">${k.value}</p>
    </div>
  `).join('');

  // Revenue trend
  destroyChart('selfServeRevenueChart');
  charts.selfServeRevenueChart = new Chart(document.getElementById('selfServeRevenueChart'), {
    type: 'bar',
    data: {
      labels: stripe.map(r => fmt.shortDate(r.week)),
      datasets: [{
        label: 'Revenue',
        data: stripe.map(r => (r.seg?.[f] || { revenue: 0 }).revenue),
        backgroundColor: '#1A7B6B44',
        borderColor: '#1A7B6B',
        borderWidth: 1,
      }],
    },
    options: chartOptions('EUR'),
  });

  // Revenue by channel (only for "all" filter, uses byChannel)
  destroyChart('selfServeChannelChart');
  const channelTotals = {};
  for (const row of stripe) {
    for (const [ch, data] of Object.entries(row.byChannel || {})) {
      channelTotals[ch] = (channelTotals[ch] || 0) + data.revenue;
    }
  }
  const channels = Object.keys(channelTotals).sort((a, b) => channelTotals[b] - channelTotals[a]);
  charts.selfServeChannelChart = new Chart(document.getElementById('selfServeChannelChart'), {
    type: 'doughnut',
    data: {
      labels: channels,
      datasets: [{
        data: channels.map(c => Math.round(channelTotals[c])),
        backgroundColor: channels.map(c => CHANNEL_COLORS[c] || '#999'),
      }],
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right', labels: { font: { size: 11 } } },
        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${fmt.currency(ctx.raw)}` } },
      },
    },
  });
}

// ===== INBOUND (HubSpot) =====
function renderInbound(weeks) {
  const funnel = filterByWeeks(DATA.weekly.funnel, weeks);
  const ga4 = filterByWeeks(DATA.weekly.ga4, weeks);

  const leads = funnel.reduce((s, r) => s + r.leads, 0);
  const sqls = funnel.reduce((s, r) => s + r.sqls, 0);
  const won = funnel.reduce((s, r) => s + r.won, 0);
  const wonRev = funnel.reduce((s, r) => s + r.wonRevenue, 0);
  const forms = ga4.reduce((s, r) => s + r.formSubmissions, 0);

  // KPIs
  document.getElementById('inboundKPIs').innerHTML = [
    { label: 'GA4 Forms', value: fmt.number(forms), color: '#F5A623' },
    { label: 'Leads', value: fmt.number(leads), color: '#1A7B6B' },
    { label: 'SQLs', value: fmt.number(sqls), color: '#7B1FA2' },
    { label: 'Won Deals', value: fmt.number(won), color: '#2E7D32' },
    { label: 'Deal Revenue', value: fmt.currency(wonRev), color: '#2E7D32' },
  ].map(k => `
    <div class="kpi-card card !p-4">
      <p class="text-xs font-medium uppercase tracking-wide text-as-muted">${k.label}</p>
      <p class="text-lg font-bold mt-1" style="color: ${k.color}">${k.value}</p>
    </div>
  `).join('');

  // Funnel
  const max = Math.max(leads, 1);
  const stages = [
    { label: 'Leads', count: leads, color: '#1A7B6B', pct: 100 },
    { label: 'SQLs', count: sqls, color: '#7B1FA2', pct: (sqls / max * 100) },
    { label: 'Won', count: won, color: '#2E7D32', pct: (won / max * 100) },
  ];
  const convRates = [];
  if (leads > 0) convRates.push(`Lead > SQL: ${(sqls/leads*100).toFixed(1)}%`);
  if (sqls > 0) convRates.push(`SQL > Won: ${(won/sqls*100).toFixed(1)}%`);

  document.getElementById('funnelChart').innerHTML = stages.map(s => `
    <div class="flex items-center gap-3">
      <span class="text-sm font-medium text-as-secondary w-16">${s.label}</span>
      <div class="flex-1 bg-as-bg rounded-full h-7 overflow-hidden">
        <div class="funnel-bar h-full rounded-full flex items-center px-3" style="width:${Math.max(s.pct,4)}%;background:${s.color}">
          <span class="text-white text-xs font-medium">${fmt.number(s.count)}</span>
        </div>
      </div>
    </div>
  `).join('') + `<div class="flex gap-4 mt-2 text-xs text-as-muted">${convRates.map(r => `<span>${r}</span>`).join('')}</div>`;

  // Funnel trend
  destroyChart('funnelTrendChart');
  const ga4Map = Object.fromEntries(ga4.map(r => [r.week, r.formSubmissions]));
  charts.funnelTrendChart = new Chart(document.getElementById('funnelTrendChart'), {
    type: 'line',
    data: {
      labels: funnel.map(r => fmt.shortDate(r.week)),
      datasets: [
        { label: 'GA4 Forms', data: funnel.map(r => ga4Map[r.week] || 0), borderColor: '#F5A623', tension: 0.3, fill: false, borderDash: [5,5] },
        { label: 'Leads', data: funnel.map(r => r.leads), borderColor: '#1A7B6B', tension: 0.3, fill: false },
        { label: 'SQLs', data: funnel.map(r => r.sqls), borderColor: '#7B1FA2', tension: 0.3, fill: false },
        { label: 'Won', data: funnel.map(r => r.won), borderColor: '#2E7D32', tension: 0.3, fill: false },
      ],
    },
    options: chartOptions(''),
  });

  // Channel chart
  const channelTotals = {};
  for (const row of funnel) {
    for (const [ch, data] of Object.entries(row.byChannel || {})) {
      if (!channelTotals[ch]) channelTotals[ch] = { leads: 0, sqls: 0, won: 0 };
      channelTotals[ch].leads += data.leads;
      channelTotals[ch].sqls += data.sqls;
      channelTotals[ch].won += data.won;
    }
  }
  const chKeys = Object.keys(channelTotals).sort((a, b) => channelTotals[b].leads - channelTotals[a].leads);
  destroyChart('channelChart');
  charts.channelChart = new Chart(document.getElementById('channelChart'), {
    type: 'bar',
    data: {
      labels: chKeys,
      datasets: [
        { label: 'Leads', data: chKeys.map(c => channelTotals[c].leads), backgroundColor: '#1A7B6B99' },
        { label: 'SQLs', data: chKeys.map(c => channelTotals[c].sqls), backgroundColor: '#7B1FA299' },
        { label: 'Won', data: chKeys.map(c => channelTotals[c].won), backgroundColor: '#2E7D3299' },
      ],
    },
    options: chartOptions(''),
  });

  // Geo table
  const geoTotals = {};
  for (const row of funnel) {
    for (const [geo, data] of Object.entries(row.byCountry || {})) {
      if (!geoTotals[geo]) geoTotals[geo] = { leads: 0, sqls: 0, won: 0, wonRevenue: 0 };
      geoTotals[geo].leads += data.leads;
      geoTotals[geo].sqls += data.sqls;
      geoTotals[geo].won += data.won;
      geoTotals[geo].wonRevenue += data.wonRevenue;
    }
  }
  const geos = Object.keys(geoTotals).sort((a, b) => geoTotals[b].leads - geoTotals[a].leads);
  document.querySelector('#geoTable tbody').innerHTML = geos.map(g => {
    const d = geoTotals[g];
    return `<tr class="border-b border-as-border/30 hover:bg-as-bg">
      <td class="py-2 font-medium">${g}</td>
      <td class="py-2 text-right text-as-secondary">${fmt.number(d.leads)}</td>
      <td class="py-2 text-right text-as-secondary">${fmt.number(d.sqls)}</td>
      <td class="py-2 text-right text-as-secondary">${fmt.number(d.won)}</td>
      <td class="py-2 text-right font-medium">${fmt.currency(d.wonRevenue)}</td>
    </tr>`;
  }).join('');
}

// ===== GOOGLE ADS =====
function renderGoogleAds(weeks) {
  const ads = filterByWeeks(DATA.weekly.ads, weeks);
  const stripe = filterByWeeks(DATA.weekly.stripe, weeks);

  const totalCost = ads.reduce((s, r) => s + r.totalCost, 0);
  const stripeRev = stripe.reduce((s, r) => s + r.totalRevenue, 0);
  const roas = totalCost > 0 ? (stripeRev / totalCost).toFixed(1) + 'x' : '-';
  const mmCost = ads.reduce((s, r) => s + r.mmCost, 0);
  const hmCost = ads.reduce((s, r) => s + r.hmCost, 0);

  document.getElementById('adsKPIs').innerHTML = [
    { label: 'Total Spend', value: fmt.currency(totalCost), color: '#EF4444' },
    { label: 'ROAS', value: roas, color: '#1A7B6B' },
    { label: 'Machine-Made', value: fmt.currency(mmCost), color: '#1A7B6B' },
    { label: 'Human-Made', value: fmt.currency(hmCost), color: '#7B1FA2' },
  ].map(k => `
    <div class="kpi-card card !p-4">
      <p class="text-xs font-medium uppercase tracking-wide text-as-muted">${k.label}</p>
      <p class="text-lg font-bold mt-1" style="color: ${k.color}">${k.value}</p>
    </div>
  `).join('');

  // MM vs HM
  destroyChart('mmVsHmChart');
  charts.mmVsHmChart = new Chart(document.getElementById('mmVsHmChart'), {
    type: 'bar',
    data: {
      labels: ads.map(r => fmt.shortDate(r.week)),
      datasets: [
        { label: 'Machine-Made', data: ads.map(r => r.mmCost), backgroundColor: '#1A7B6B44', borderColor: '#1A7B6B', borderWidth: 1 },
        { label: 'Human-Made', data: ads.map(r => r.hmCost), backgroundColor: '#7B1FA244', borderColor: '#7B1FA2', borderWidth: 1 },
        { label: 'Brand', data: ads.map(r => r.brandCost), backgroundColor: '#F5A62344', borderColor: '#F5A623', borderWidth: 1 },
      ],
    },
    options: { ...chartOptions('EUR'), scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } },
  });

  // By product
  const productTotals = {};
  for (const row of ads) {
    for (const [prod, cost] of Object.entries(row.byProduct || {})) {
      productTotals[prod] = (productTotals[prod] || 0) + cost;
    }
  }
  const products = Object.keys(productTotals).sort((a, b) => productTotals[b] - productTotals[a]);
  const prodColors = ['#1A7B6B', '#F5A623', '#7B1FA2', '#005a50', '#2E7D32', '#E65100', '#0061FF', '#999'];
  destroyChart('adProductChart');
  charts.adProductChart = new Chart(document.getElementById('adProductChart'), {
    type: 'doughnut',
    data: {
      labels: products,
      datasets: [{
        data: products.map(p => Math.round(productTotals[p])),
        backgroundColor: products.map((_, i) => prodColors[i % prodColors.length]),
      }],
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right', labels: { font: { size: 11 } } },
        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${fmt.currency(ctx.raw)}` } },
      },
    },
  });
}

// ===== CHART HELPERS =====
function chartOptions(prefix) {
  return {
    responsive: true, maintainAspectRatio: false,
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: { position: 'top', labels: { usePointStyle: true, pointStyleWidth: 10, font: { size: 11 } } },
      tooltip: {
        callbacks: {
          label: ctx => {
            const val = typeof ctx.raw === 'number' ? (prefix ? `${prefix} ${ctx.raw.toLocaleString()}` : ctx.raw.toLocaleString()) : ctx.raw;
            return `${ctx.dataset.label}: ${val}`;
          },
        },
      },
    },
    scales: {
      x: { grid: { display: false }, ticks: { font: { size: 11 } } },
      y: { beginAtZero: true, grid: { color: '#E0E0E033' }, ticks: { font: { size: 11 } } },
    },
  };
}

function destroyChart(id) {
  if (charts[id]) { charts[id].destroy(); delete charts[id]; }
}

// ===== EVENTS =====
document.getElementById('dateRange').addEventListener('change', () => { if (DATA) render(); });

loadData();
</script>
</body>
</html>
