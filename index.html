<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amberscript Marketing Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            as: {
              primary: '#1A7B6B',
              hover: '#155F54',
              accent: '#F5A623',
              bg: '#F5F5F5',
              border: '#E0E0E0',
              text: '#1A1A1A',
              secondary: '#666666',
              muted: '#999999',
              success: '#2E7D32',
            }
          },
          fontFamily: {
            sans: ['"DM Sans"', 'system-ui', 'sans-serif'],
          },
          fontSize: {
            'h2': ['2rem', { lineHeight: '2rem', fontWeight: '400' }],
            'h3': ['1.5rem', { lineHeight: '2rem', fontWeight: '500' }],
            'body-lg': ['1.125rem', { lineHeight: '1.875rem', fontWeight: '400' }],
            'body': ['0.875rem', { lineHeight: '1.25rem', fontWeight: '400' }],
            'body-md': ['0.875rem', { lineHeight: '1.25rem', fontWeight: '500' }],
            'caption': ['0.75rem', { lineHeight: '1rem', fontWeight: '400' }],
          },
          borderRadius: {
            'card': '8px',
          },
          spacing: {
            'card': '24px',
            'section': '32px',
          }
        }
      }
    }
  </script>
  <style>
    body { background: #F5F5F5; color: #1A1A1A; }
    .card {
      background: #fff;
      border: 1px solid #E0E0E0;
      border-radius: 8px;
      padding: 24px;
    }
    .kpi-card {
      transition: transform 0.15s ease, border-color 0.15s ease;
    }
    .kpi-card:hover {
      transform: translateY(-2px);
      border-color: #1A7B6B;
    }
    .chart-container { position: relative; min-height: 300px; }
    .funnel-bar { transition: width 0.6s ease; }
    select { font-size: 0.875rem; }
    th { color: #999999; }
    td { color: #1A1A1A; }
  </style>
</head>
<body class="font-sans">

  <!-- Header -->
  <header class="bg-as-primary text-white">
    <div class="max-w-7xl mx-auto px-4 py-5 sm:px-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
      <div>
        <h1 class="text-h3 font-medium tracking-tight">Amberscript Marketing Dashboard</h1>
        <p class="text-white/60 text-caption mt-1" id="lastUpdated">Loading...</p>
      </div>
      <div class="flex items-center gap-3">
        <select id="dateRange" class="bg-white/10 border border-white/20 text-white rounded-card px-3 py-1.5 text-body">
          <option value="this-week">This week</option>
          <option value="last-week">Last week</option>
          <option value="last-2-weeks">Last 2 weeks</option>
          <option value="last-4-weeks" selected>Last 4 weeks</option>
          <option value="this-month">This month</option>
          <option value="last-month">Last month</option>
          <option value="last-2-months">Last 2 months</option>
          <option value="last-4-months">Last 4 months</option>
          <option value="all">All time</option>
        </select>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 py-section space-y-section">

    <!-- 1. KPI Row -->
    <section id="kpiSection" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-4"></section>

    <!-- 2. Sales Funnel -->
    <section class="card">
      <h2 class="text-body-lg font-medium text-as-text mb-4">Sales Funnel</h2>
      <div id="funnelChart" class="space-y-3"></div>
    </section>

    <!-- 3. Trend Charts -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="card">
        <h2 class="text-body-lg font-medium text-as-text mb-4">Weekly Leads & SQLs</h2>
        <div class="chart-container"><canvas id="funnelTrendChart"></canvas></div>
      </div>
      <div class="card">
        <h2 class="text-body-lg font-medium text-as-text mb-4">Weekly Ad Spend & Stripe Revenue</h2>
        <div class="chart-container"><canvas id="revenueTrendChart"></canvas></div>
      </div>
    </section>

    <!-- 4. Channel Breakdown -->
    <section class="card">
      <h2 class="text-body-lg font-medium text-as-text mb-4">Leads by Channel</h2>
      <div class="chart-container"><canvas id="channelChart"></canvas></div>
    </section>

    <!-- 5. Geo Breakdown -->
    <section class="card">
      <h2 class="text-body-lg font-medium text-as-text mb-4">Performance by Country</h2>
      <div class="overflow-x-auto">
        <table id="geoTable" class="w-full text-body">
          <thead class="text-left border-b border-as-border">
            <tr>
              <th class="pb-2 font-medium text-as-muted">Country</th>
              <th class="pb-2 font-medium text-as-muted text-right">Leads</th>
              <th class="pb-2 font-medium text-as-muted text-right">SQLs</th>
              <th class="pb-2 font-medium text-as-muted text-right">Won</th>
              <th class="pb-2 font-medium text-as-muted text-right">Revenue</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- 6. Stripe Revenue -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="card">
        <h2 class="text-body-lg font-medium text-as-text mb-4">Stripe Revenue by Plan Type</h2>
        <div class="chart-container"><canvas id="stripeTypeChart"></canvas></div>
      </div>
      <div class="card">
        <h2 class="text-body-lg font-medium text-as-text mb-4">Stripe Revenue by Channel</h2>
        <div class="chart-container"><canvas id="stripeChannelChart"></canvas></div>
      </div>
    </section>

    <!-- 7. Machine-Made vs Human-Made -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="card">
        <h2 class="text-body-lg font-medium text-as-text mb-4">Ad Spend: Machine-Made vs Human-Made</h2>
        <div class="chart-container"><canvas id="mmVsHmChart"></canvas></div>
      </div>
      <div class="card">
        <h2 class="text-body-lg font-medium text-as-text mb-4">Ad Spend by Product</h2>
        <div class="chart-container"><canvas id="adProductChart"></canvas></div>
      </div>
    </section>

    <!-- 8. Monthly Summary Table -->
    <section class="card">
      <h2 class="text-body-lg font-medium text-as-text mb-4">Monthly Summary</h2>
      <div class="overflow-x-auto">
        <table id="monthlyTable" class="w-full text-body">
          <thead class="text-left border-b border-as-border">
            <tr>
              <th class="pb-2 font-medium text-as-muted">Month</th>
              <th class="pb-2 font-medium text-as-muted text-right">Ad Spend</th>
              <th class="pb-2 font-medium text-as-muted text-right">Leads</th>
              <th class="pb-2 font-medium text-as-muted text-right">SQLs</th>
              <th class="pb-2 font-medium text-as-muted text-right">Won</th>
              <th class="pb-2 font-medium text-as-muted text-right">Deal Rev</th>
              <th class="pb-2 font-medium text-as-muted text-right">Stripe Rev</th>
              <th class="pb-2 font-medium text-as-muted text-right">Forms</th>
              <th class="pb-2 font-medium text-as-muted text-right">Lead&#8594;SQL</th>
              <th class="pb-2 font-medium text-as-muted text-right">SQL&#8594;Won</th>
              <th class="pb-2 font-medium text-as-muted text-right">ROAS</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- 9. Payment Health -->
    <section class="card">
      <h2 class="text-body-lg font-medium text-as-text mb-4">Payment Health</h2>
      <div id="paymentHealth" class="grid grid-cols-2 sm:grid-cols-4 gap-4"></div>
    </section>

  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 py-8 text-center text-as-muted text-caption">
    Auto-updated daily via GitHub Actions. Data from Google Ads, HubSpot, Stripe, GA4.
  </footer>

<script>
let DATA = null;
let charts = {};

const COLORS = {
  primary: '#1A7B6B',
  primaryHover: '#155F54',
  accent: '#F5A623',
  success: '#2E7D32',
  text: '#1A1A1A',
  secondary: '#666666',
  muted: '#999999',
  border: '#E0E0E0',
};

const CHANNEL_COLORS = {
  'Direct': '#1A7B6B',
  'Paid Search': '#005a50',
  'Organic Search': '#2E7D32',
  'Referral': '#F5A623',
  'Email': '#E69100',
  'Subscription': '#7B1FA2',
  'Unknown': '#999999',
  'Organic Video': '#0061FF',
  'Affiliates': '#155F54',
  'Organic Social': '#E65100',
  'Cross-network': '#5C6BC0',
  'Unassigned': '#E0E0E0',
};

const fmt = {
  currency: (n) => new Intl.NumberFormat('en-EU', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n),
  number: (n) => new Intl.NumberFormat('en-US').format(n),
  pct: (n) => n.toFixed(1) + '%',
  shortDate: (d) => {
    const date = new Date(d + 'T00:00:00');
    return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
  },
  monthLabel: (m) => {
    const [y, mo] = m.split('-');
    return new Date(parseInt(y), parseInt(mo) - 1).toLocaleDateString('en-GB', { month: 'short', year: '2-digit' });
  },
};

async function loadData() {
  try {
    const res = await fetch('data.json');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    DATA = await res.json();
    render();
  } catch (err) {
    document.getElementById('lastUpdated').textContent = 'Error loading data: ' + err.message;
  }
}

function getFilteredWeeks() {
  const mode = document.getElementById('dateRange').value;
  const allWeeks = DATA.weekly.ads.map(r => r.week).filter(Boolean);
  if (!allWeeks.length || mode === 'all') return allWeeks;

  const today = new Date();
  const dayOfWeek = today.getUTCDay() || 7; // 1=Mon, 7=Sun
  const thisMonday = new Date(today);
  thisMonday.setUTCDate(today.getUTCDate() - dayOfWeek + 1);
  const thisMondayStr = thisMonday.toISOString().slice(0, 10);

  const firstOfMonth = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), 1));

  if (mode === 'this-week') {
    return allWeeks.filter(w => w >= thisMondayStr);
  } else if (mode === 'last-week') {
    const lastMonday = new Date(thisMonday);
    lastMonday.setUTCDate(lastMonday.getUTCDate() - 7);
    return allWeeks.filter(w => w >= lastMonday.toISOString().slice(0, 10) && w < thisMondayStr);
  } else if (mode === 'last-2-weeks') {
    const start = new Date(thisMonday);
    start.setUTCDate(start.getUTCDate() - 14);
    return allWeeks.filter(w => w >= start.toISOString().slice(0, 10) && w < thisMondayStr);
  } else if (mode === 'last-4-weeks') {
    const start = new Date(thisMonday);
    start.setUTCDate(start.getUTCDate() - 28);
    return allWeeks.filter(w => w >= start.toISOString().slice(0, 10) && w < thisMondayStr);
  } else if (mode === 'this-month') {
    return allWeeks.filter(w => w >= firstOfMonth.toISOString().slice(0, 10));
  } else if (mode === 'last-month') {
    const lastMonth = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth() - 1, 1));
    return allWeeks.filter(w => w >= lastMonth.toISOString().slice(0, 10) && w < firstOfMonth.toISOString().slice(0, 10));
  } else if (mode === 'last-2-months') {
    const start = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth() - 2, 1));
    return allWeeks.filter(w => w >= start.toISOString().slice(0, 10) && w < firstOfMonth.toISOString().slice(0, 10));
  } else if (mode === 'last-4-months') {
    const start = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth() - 4, 1));
    return allWeeks.filter(w => w >= start.toISOString().slice(0, 10) && w < firstOfMonth.toISOString().slice(0, 10));
  }
  return allWeeks;
}

function filterByWeeks(arr, weeks) {
  const set = new Set(weeks);
  return arr.filter(r => set.has(r.week));
}

function render() {
  const weeks = getFilteredWeeks();
  document.getElementById('lastUpdated').textContent =
    `Last updated: ${new Date(DATA.updatedAt).toLocaleString('en-GB')} | ${DATA.dateRange.start} to ${DATA.dateRange.end}`;

  renderKPIs(weeks);
  renderFunnel(weeks);
  renderFunnelTrend(weeks);
  renderRevenueTrend(weeks);
  renderChannelChart(weeks);
  renderGeoTable(weeks);
  renderStripeTypeChart(weeks);
  renderStripeChannelChart(weeks);
  renderMmVsHm(weeks);
  renderAdProductChart(weeks);
  renderMonthlyTable();
  renderPaymentHealth(weeks);
}

// 1. KPIs
function renderKPIs(weeks) {
  const funnel = filterByWeeks(DATA.weekly.funnel, weeks);
  const ads = filterByWeeks(DATA.weekly.ads, weeks);
  const stripe = filterByWeeks(DATA.weekly.stripe, weeks);
  const ga4 = filterByWeeks(DATA.weekly.ga4, weeks);

  const leads = funnel.reduce((s, r) => s + r.leads, 0);
  const sqls = funnel.reduce((s, r) => s + r.sqls, 0);
  const won = funnel.reduce((s, r) => s + r.won, 0);
  const wonRev = funnel.reduce((s, r) => s + r.wonRevenue, 0);
  const stripeRev = stripe.reduce((s, r) => s + r.totalRevenue, 0);
  const adsCost = ads.reduce((s, r) => s + r.totalCost, 0);
  const roas = adsCost > 0 ? (stripeRev / adsCost).toFixed(1) : '-';
  const forms = ga4.reduce((s, r) => s + r.formSubmissions, 0);

  const kpis = [
    { label: 'GA4 Form Leads', value: fmt.number(forms), color: '#1A1A1A' },
    { label: 'HubSpot Leads', value: fmt.number(leads), color: '#1A7B6B' },
    { label: 'SQLs', value: fmt.number(sqls), color: '#7B1FA2' },
    { label: 'Won Deals', value: fmt.number(won), color: '#2E7D32' },
    { label: 'Deal Revenue', value: fmt.currency(wonRev), color: '#2E7D32' },
    { label: 'Stripe Revenue', value: fmt.currency(stripeRev), color: '#F5A623' },
    { label: 'Google Ads Cost', value: fmt.currency(adsCost), color: '#EF4444' },
    { label: 'ROAS', value: roas + 'x', color: '#1A7B6B' },
  ];

  document.getElementById('kpiSection').innerHTML = kpis.map(k => `
    <div class="kpi-card card !p-4">
      <p class="text-caption font-medium uppercase tracking-wide text-as-muted">${k.label}</p>
      <p class="text-body-lg font-bold mt-1" style="color: ${k.color}">${k.value}</p>
    </div>
  `).join('');
}

// 2. Funnel
function renderFunnel(weeks) {
  const funnel = filterByWeeks(DATA.weekly.funnel, weeks);
  const leads = funnel.reduce((s, r) => s + r.leads, 0);
  const sqls = funnel.reduce((s, r) => s + r.sqls, 0);
  const won = funnel.reduce((s, r) => s + r.won, 0);

  const max = Math.max(leads, 1);
  const stages = [
    { label: 'Leads', count: leads, color: '#1A7B6B', pct: 100 },
    { label: 'SQLs', count: sqls, color: '#7B1FA2', pct: (sqls / max * 100) },
    { label: 'Won', count: won, color: '#2E7D32', pct: (won / max * 100) },
  ];

  const convRates = [];
  if (leads > 0) convRates.push(`Lead > SQL: ${(sqls / leads * 100).toFixed(1)}%`);
  if (sqls > 0) convRates.push(`SQL > Won: ${(won / sqls * 100).toFixed(1)}%`);
  if (leads > 0) convRates.push(`Lead > Won: ${(won / leads * 100).toFixed(1)}%`);

  document.getElementById('funnelChart').innerHTML = stages.map(s => `
    <div class="flex items-center gap-3">
      <span class="text-body-md text-as-secondary w-20">${s.label}</span>
      <div class="flex-1 bg-as-bg rounded-full h-8 overflow-hidden">
        <div class="funnel-bar h-full rounded-full flex items-center px-3" style="width: ${Math.max(s.pct, 4)}%; background: ${s.color}">
          <span class="text-white text-caption font-medium">${fmt.number(s.count)}</span>
        </div>
      </div>
    </div>
  `).join('') + `
    <div class="flex gap-4 mt-2 text-caption text-as-muted">
      ${convRates.map(r => `<span>${r}</span>`).join('')}
    </div>
  `;
}

// 3. Funnel Trend
function renderFunnelTrend(weeks) {
  const funnel = filterByWeeks(DATA.weekly.funnel, weeks);
  const ga4 = filterByWeeks(DATA.weekly.ga4, weeks);
  destroyChart('funnelTrendChart');

  // Merge GA4 form submissions with funnel weeks
  const ga4Map = Object.fromEntries(ga4.map(r => [r.week, r.formSubmissions]));

  charts.funnelTrendChart = new Chart(document.getElementById('funnelTrendChart'), {
    type: 'line',
    data: {
      labels: funnel.map(r => fmt.shortDate(r.week)),
      datasets: [
        { label: 'GA4 Forms', data: funnel.map(r => ga4Map[r.week] || 0), borderColor: '#F5A623', tension: 0.3, fill: false, borderDash: [5, 5] },
        { label: 'Leads', data: funnel.map(r => r.leads), borderColor: '#1A7B6B', tension: 0.3, fill: false },
        { label: 'SQLs', data: funnel.map(r => r.sqls), borderColor: '#7B1FA2', tension: 0.3, fill: false },
        { label: 'Won', data: funnel.map(r => r.won), borderColor: '#2E7D32', tension: 0.3, fill: false },
      ],
    },
    options: chartOptions(''),
  });
}

// 4. Revenue Trend
function renderRevenueTrend(weeks) {
  const ads = filterByWeeks(DATA.weekly.ads, weeks);
  const stripe = filterByWeeks(DATA.weekly.stripe, weeks);

  const adsMap = Object.fromEntries(ads.map(r => [r.week, r.totalCost]));
  const stripeMap = Object.fromEntries(stripe.map(r => [r.week, r.totalRevenue]));

  destroyChart('revenueTrendChart');
  charts.revenueTrendChart = new Chart(document.getElementById('revenueTrendChart'), {
    type: 'bar',
    data: {
      labels: weeks.map(w => fmt.shortDate(w)),
      datasets: [
        { label: 'Ad Spend', data: weeks.map(w => adsMap[w] || 0), backgroundColor: '#EF444433', borderColor: '#EF4444', borderWidth: 1 },
        { label: 'Stripe Revenue', data: weeks.map(w => stripeMap[w] || 0), backgroundColor: '#1A7B6B33', borderColor: '#1A7B6B', borderWidth: 1 },
      ],
    },
    options: chartOptions('EUR'),
  });
}

// 5. Channel Chart
function renderChannelChart(weeks) {
  const funnel = filterByWeeks(DATA.weekly.funnel, weeks);
  const channelTotals = {};
  for (const row of funnel) {
    for (const [ch, data] of Object.entries(row.byChannel || {})) {
      if (!channelTotals[ch]) channelTotals[ch] = { leads: 0, sqls: 0, won: 0 };
      channelTotals[ch].leads += data.leads;
      channelTotals[ch].sqls += data.sqls;
      channelTotals[ch].won += data.won;
    }
  }

  const channels = Object.keys(channelTotals).sort((a, b) => channelTotals[b].leads - channelTotals[a].leads);

  destroyChart('channelChart');
  charts.channelChart = new Chart(document.getElementById('channelChart'), {
    type: 'bar',
    data: {
      labels: channels,
      datasets: [
        { label: 'Leads', data: channels.map(c => channelTotals[c].leads), backgroundColor: '#1A7B6B99' },
        { label: 'SQLs', data: channels.map(c => channelTotals[c].sqls), backgroundColor: '#7B1FA299' },
        { label: 'Won', data: channels.map(c => channelTotals[c].won), backgroundColor: '#2E7D3299' },
      ],
    },
    options: { ...chartOptions(''), scales: { x: { stacked: false }, y: { stacked: false, beginAtZero: true } } },
  });
}

// 6. Geo Table
function renderGeoTable(weeks) {
  const funnel = filterByWeeks(DATA.weekly.funnel, weeks);
  const geoTotals = {};
  for (const row of funnel) {
    for (const [geo, data] of Object.entries(row.byCountry || {})) {
      if (!geoTotals[geo]) geoTotals[geo] = { leads: 0, sqls: 0, won: 0, wonRevenue: 0 };
      geoTotals[geo].leads += data.leads;
      geoTotals[geo].sqls += data.sqls;
      geoTotals[geo].won += data.won;
      geoTotals[geo].wonRevenue += data.wonRevenue;
    }
  }

  const geos = Object.keys(geoTotals).sort((a, b) => geoTotals[b].leads - geoTotals[a].leads);
  const tbody = document.querySelector('#geoTable tbody');
  tbody.innerHTML = geos.map(g => {
    const d = geoTotals[g];
    return `
      <tr class="border-b border-as-border/50 hover:bg-as-bg">
        <td class="py-2 font-medium text-as-text">${g}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(d.leads)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(d.sqls)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(d.won)}</td>
        <td class="py-2 text-right text-as-text font-medium">${fmt.currency(d.wonRevenue)}</td>
      </tr>
    `;
  }).join('');
}

// 7a. Stripe Revenue by Plan Type
function renderStripeTypeChart(weeks) {
  const stripe = filterByWeeks(DATA.weekly.stripe, weeks);
  const typeTotals = {};
  for (const row of stripe) {
    for (const [type, data] of Object.entries(row.byPlanType || {})) {
      typeTotals[type] = (typeTotals[type] || 0) + data.revenue;
    }
  }

  const types = Object.keys(typeTotals).sort((a, b) => typeTotals[b] - typeTotals[a]);
  const typeColors = ['#1A7B6B', '#F5A623', '#7B1FA2', '#005a50'];

  destroyChart('stripeTypeChart');
  charts.stripeTypeChart = new Chart(document.getElementById('stripeTypeChart'), {
    type: 'doughnut',
    data: {
      labels: types,
      datasets: [{
        data: types.map(t => Math.round(typeTotals[t])),
        backgroundColor: types.map((_, i) => typeColors[i % typeColors.length]),
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right' },
        tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${fmt.currency(ctx.raw)}` } },
      },
    },
  });
}

// 7b. Stripe Revenue by Channel
function renderStripeChannelChart(weeks) {
  const stripe = filterByWeeks(DATA.weekly.stripe, weeks);
  const channelTotals = {};
  for (const row of stripe) {
    for (const [ch, data] of Object.entries(row.byChannel || {})) {
      channelTotals[ch] = (channelTotals[ch] || 0) + data.revenue;
    }
  }

  const channels = Object.keys(channelTotals).sort((a, b) => channelTotals[b] - channelTotals[a]);

  destroyChart('stripeChannelChart');
  charts.stripeChannelChart = new Chart(document.getElementById('stripeChannelChart'), {
    type: 'doughnut',
    data: {
      labels: channels,
      datasets: [{
        data: channels.map(c => Math.round(channelTotals[c])),
        backgroundColor: channels.map(c => CHANNEL_COLORS[c] || '#9CA3AF'),
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right' },
        tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${fmt.currency(ctx.raw)}` } },
      },
    },
  });
}

// 8a. Machine-Made vs Human-Made Ad Spend
function renderMmVsHm(weeks) {
  const ads = filterByWeeks(DATA.weekly.ads, weeks);
  destroyChart('mmVsHmChart');

  charts.mmVsHmChart = new Chart(document.getElementById('mmVsHmChart'), {
    type: 'bar',
    data: {
      labels: ads.map(r => fmt.shortDate(r.week)),
      datasets: [
        { label: 'Machine-Made', data: ads.map(r => r.mmCost), backgroundColor: '#1A7B6B44', borderColor: '#1A7B6B', borderWidth: 1 },
        { label: 'Human-Made', data: ads.map(r => r.hmCost), backgroundColor: '#7B1FA244', borderColor: '#7B1FA2', borderWidth: 1 },
        { label: 'Brand', data: ads.map(r => r.brandCost), backgroundColor: '#F5A62344', borderColor: '#F5A623', borderWidth: 1 },
      ],
    },
    options: { ...chartOptions('EUR'), scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } },
  });
}

// 8b. Ad Spend by Product
function renderAdProductChart(weeks) {
  const ads = filterByWeeks(DATA.weekly.ads, weeks);

  // Aggregate all products across weeks
  const productTotals = {};
  for (const row of ads) {
    for (const [prod, cost] of Object.entries(row.byProduct || {})) {
      productTotals[prod] = (productTotals[prod] || 0) + cost;
    }
  }

  const products = Object.keys(productTotals).sort((a, b) => productTotals[b] - productTotals[a]);
  const prodColors = ['#1A7B6B', '#F5A623', '#7B1FA2', '#005a50', '#2E7D32', '#E65100', '#0061FF', '#999999'];

  destroyChart('adProductChart');
  charts.adProductChart = new Chart(document.getElementById('adProductChart'), {
    type: 'doughnut',
    data: {
      labels: products,
      datasets: [{
        data: products.map(p => Math.round(productTotals[p])),
        backgroundColor: products.map((_, i) => prodColors[i % prodColors.length]),
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right' },
        tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${fmt.currency(ctx.raw)}` } },
      },
    },
  });
}

// 9. Monthly Table
function renderMonthlyTable() {
  const tbody = document.querySelector('#monthlyTable tbody');
  const months = DATA.monthly || [];
  tbody.innerHTML = months.map(m => {
    const roas = m.adsCost > 0 ? (m.stripeRevenue / m.adsCost).toFixed(1) + 'x' : '-';
    return `
      <tr class="border-b border-as-border/50 hover:bg-as-bg">
        <td class="py-2 font-medium text-as-text">${fmt.monthLabel(m.month)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.currency(m.adsCost)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(m.leads)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(m.sqls)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(m.won)}</td>
        <td class="py-2 text-right text-as-text font-medium">${fmt.currency(m.wonRevenue)}</td>
        <td class="py-2 text-right text-as-text font-medium">${fmt.currency(m.stripeRevenue)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.number(m.formSubmissions)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.pct(m.leadToSql)}</td>
        <td class="py-2 text-right text-as-secondary">${fmt.pct(m.sqlToWon)}</td>
        <td class="py-2 text-right text-as-primary font-medium">${roas}</td>
      </tr>
    `;
  }).join('');
}

// 10. Payment Health
function renderPaymentHealth(weeks) {
  const stripe = filterByWeeks(DATA.weekly.stripe, weeks);
  const totalPayments = stripe.reduce((s, r) => s + r.count, 0);
  const totalRevenue = stripe.reduce((s, r) => s + r.totalRevenue, 0);

  // Product breakdown
  const byProduct = {};
  for (const row of stripe) {
    for (const [prod, data] of Object.entries(row.byProduct || {})) {
      if (!byProduct[prod]) byProduct[prod] = { count: 0, revenue: 0 };
      byProduct[prod].count += data.count;
      byProduct[prod].revenue += data.revenue;
    }
  }

  // Currency breakdown
  const byCurrency = {};
  for (const row of stripe) {
    for (const [cur, data] of Object.entries(row.byCurrency || {})) {
      if (!byCurrency[cur]) byCurrency[cur] = { count: 0, revenue: 0 };
      byCurrency[cur].count += data.count;
      byCurrency[cur].revenue += data.revenue;
    }
  }

  // Channel match rate
  const byChannel = {};
  for (const row of stripe) {
    for (const [ch, data] of Object.entries(row.byChannel || {})) {
      if (!byChannel[ch]) byChannel[ch] = { count: 0, revenue: 0 };
      byChannel[ch].count += data.count;
      byChannel[ch].revenue += data.revenue;
    }
  }
  const matched = totalPayments - (byChannel['Unknown']?.count || 0) - (byChannel['Subscription']?.count || 0);
  const matchRate = totalPayments > 0 ? (matched / totalPayments * 100).toFixed(1) : 0;

  const items = [
    { label: 'Total Payments', value: fmt.number(totalPayments), sub: fmt.currency(totalRevenue) },
    { label: 'GA4 Match Rate', value: matchRate + '%', sub: fmt.number(matched) + ' matched' },
    ...Object.entries(byProduct).map(([prod, data]) => ({
      label: prod, value: fmt.number(data.count), sub: fmt.currency(data.revenue),
    })),
    ...Object.entries(byCurrency).map(([cur, data]) => ({
      label: cur, value: fmt.number(data.count) + ' payments', sub: fmt.currency(data.revenue),
    })),
  ];

  document.getElementById('paymentHealth').innerHTML = items.map(i => `
    <div class="bg-as-bg rounded-card p-4 border border-as-border/50">
      <p class="text-caption font-medium uppercase text-as-muted">${i.label}</p>
      <p class="text-body-lg font-bold text-as-text mt-1">${i.value}</p>
      <p class="text-caption text-as-muted mt-0.5">${i.sub}</p>
    </div>
  `).join('');
}

// Chart helpers
function chartOptions(prefix) {
  return {
    responsive: true,
    maintainAspectRatio: false,
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: { position: 'top', labels: { usePointStyle: true, pointStyleWidth: 10 } },
      tooltip: {
        callbacks: {
          label: (ctx) => {
            const val = typeof ctx.raw === 'number' ? (prefix ? `${prefix} ${ctx.raw.toLocaleString()}` : ctx.raw.toLocaleString()) : ctx.raw;
            return `${ctx.dataset.label}: ${val}`;
          },
        },
      },
    },
    scales: {
      x: { grid: { display: false } },
      y: { beginAtZero: true, grid: { color: '#E0E0E033' } },
    },
  };
}

function destroyChart(id) {
  if (charts[id]) { charts[id].destroy(); delete charts[id]; }
}

document.getElementById('dateRange').addEventListener('change', () => { if (DATA) render(); });

loadData();
</script>

</body>
</html>
