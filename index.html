<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amberscript Marketing Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            as: {
              primary: '#1A7B6B',
              deep: '#005a50',
              hover: '#155F54',
              accent: '#F5A623',
              bg: '#F7F8FA',
              card: '#FFFFFF',
              border: '#E8ECF0',
              text: '#0F1419',
              secondary: '#536471',
              muted: '#8899A6',
              success: '#2E7D32',
              purple: '#7B1FA2',
              red: '#E03E3E',
            }
          },
          fontFamily: {
            sans: ['"Plus Jakarta Sans"', 'system-ui', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <style>
    body { background: #F7F8FA; color: #0F1419; }

    /* Cards */
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06);
      border: 1px solid #E8ECF0;
    }

    /* KPI cards */
    .kpi-card {
      position: relative;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .kpi-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.06);
    }
    .kpi-card::before {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 3px;
      background: var(--kpi-color, #1A7B6B);
      border-radius: 3px 0 0 3px;
    }

    .chart-container { position: relative; min-height: 280px; }
    .funnel-bar { transition: width 0.6s cubic-bezier(0.16, 1, 0.3, 1); }

    /* Section titles */
    .section-title {
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #1A7B6B;
      padding-bottom: 12px;
      margin-bottom: 24px;
      border-bottom: 2px solid #1A7B6B;
    }
    .sub-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: #0F1419;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sub-title::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 2px;
      background: #1A7B6B;
      flex-shrink: 0;
    }

    .hidden { display: none !important; }
    .rotate-90 { transform: rotate(90deg); }

    /* Toggle buttons */
    .toggle-btn {
      padding: 5px 14px;
      font-size: 0.75rem;
      font-weight: 600;
      border: 1px solid #E8ECF0;
      cursor: pointer;
      color: #8899A6;
      background: #fff;
      transition: all 0.15s ease;
      letter-spacing: 0.02em;
    }
    .toggle-btn:first-child { border-radius: 8px 0 0 8px; }
    .toggle-btn:last-child { border-radius: 0 8px 8px 0; border-left: 0; }
    .toggle-btn:hover:not(.active) { color: #536471; background: #F7F8FA; }
    .toggle-btn.active {
      background: #1A7B6B;
      color: #fff;
      border-color: #1A7B6B;
    }

    /* Tables */
    th {
      color: #8899A6;
      font-weight: 600;
      font-size: 0.6875rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    th[title] {
      cursor: help;
      text-decoration: underline dotted #CFD9DE;
      text-underline-offset: 3px;
    }
    td { font-size: 0.8125rem; }
    tr.hover-row:hover { background: #F7F8FA; }

    /* Header selects */
    .header-select {
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s ease;
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 28px;
    }
    .header-select:hover { background: rgba(255,255,255,0.2); }
    .header-select option { color: #0F1419; background: #fff; }

    /* BU tabs */
    .bu-tab {
      padding: 8px 20px;
      font-size: 0.8125rem;
      font-weight: 600;
      color: rgba(255,255,255,0.55);
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: all 0.15s ease;
      letter-spacing: 0.01em;
    }
    .bu-tab:hover:not(.active) { color: rgba(255,255,255,0.8); }
    .bu-tab.active {
      color: #fff;
      border-bottom-color: #F5A623;
      background: rgba(255,255,255,0.08);
      border-radius: 6px 6px 0 0;
    }

    /* Body selects */
    .filter-select {
      border: 1px solid #E8ECF0;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 0.8125rem;
      font-weight: 500;
      background: #fff;
      color: #0F1419;
      cursor: pointer;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%238899A6' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 28px;
    }
    .filter-select:hover { border-color: #1A7B6B; }
    .filter-select:focus { outline: none; border-color: #1A7B6B; box-shadow: 0 0 0 3px rgba(26,123,107,0.12); }

    /* Funnel bar labels */
    .funnel-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #536471;
      width: 52px;
      text-align: right;
      flex-shrink: 0;
    }
    .funnel-track {
      background: #F0F2F5;
      border-radius: 6px;
      height: 32px;
      overflow: hidden;
    }
    .funnel-fill {
      height: 100%;
      border-radius: 6px;
      display: flex;
      align-items: center;
      padding: 0 12px;
      min-width: 40px;
      transition: width 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* Conversion rate pills */
    .conv-pill {
      font-size: 0.6875rem;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 4px;
      background: #F0F2F5;
      color: #536471;
    }

    /* Summary card header */
    .summary-header {
      font-size: 0.6875rem;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #8899A6;
    }
  </style>
</head>
<body class="font-sans antialiased">

  <!-- Header -->
  <header style="background: linear-gradient(135deg, #005a50 0%, #1A7B6B 60%, #228B7B 100%);">
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
      <div class="py-5">
        <h1 class="text-lg font-bold tracking-tight text-white">Amberscript</h1>
        <p class="text-white/50 text-xs mt-0.5 font-medium" id="lastUpdated">Loading...</p>
      </div>
      <!-- BU Tabs + Date Range -->
      <div class="flex items-end justify-between -mb-px">
        <nav class="flex gap-1" id="buTabs">
          <button class="bu-tab active" data-bu="Transcription" onclick="switchBU('Transcription')">Transcription</button>
          <button class="bu-tab" data-bu="Media" onclick="switchBU('Media')">Media</button>
          <button class="bu-tab" data-bu="Innovations" onclick="switchBU('Innovations')">Innovations</button>
        </nav>
        <select id="dateRange" class="header-select mb-1.5">
          <option value="this-week">This week</option>
          <option value="last-week">Last week</option>
          <option value="last-2-weeks">Last 2 weeks</option>
          <option value="last-4-weeks">Last 4 weeks</option>
          <option value="this-month">This month</option>
          <option value="last-month">Last month</option>
          <option value="last-2-months">Last 2 months</option>
          <option value="last-4-months">Last 4 months</option>
          <option value="all" selected>All time</option>
        </select>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8">

    <!-- ============================================ -->
    <!-- PAGE: TRANSCRIPTION (BUT)                    -->
    <!-- ============================================ -->
    <div id="page-Transcription" class="bu-page space-y-10">

    <div>
      <h2 class="section-title">Transcription</h2>

      <!-- ---- Inbound (HubSpot) ---- -->
      <div class="mb-10">
        <h3 class="sub-title">Inbound</h3>

        <!-- Filters -->
        <div class="flex flex-wrap items-center gap-2 mb-5" id="inboundFilters">
          <select id="inbProductFilter" class="filter-select" onchange="onInboundFilterChange()">
            <option value="all">All Products</option>
          </select>
          <select id="inbStyleFilter" class="filter-select hidden" onchange="onInboundFilterChange()">
            <option value="all">All Styles</option>
          </select>
          <select id="inbOptionsFilter" class="filter-select hidden" onchange="onInboundFilterChange()">
            <option value="all">All Options</option>
          </select>
          <select id="inbCountryFilter" class="filter-select" onchange="onInboundFilterChange()">
            <option value="all">All Countries</option>
            <option value="DACH">DACH (DE+AT+CH)</option>
          </select>
        </div>

        <!-- Inbound Summary -->
        <section class="card mb-6">
          <div class="flex items-center justify-between mb-4">
            <span class="summary-header">Summary</span>
            <div class="flex" id="inboundSummaryToggle">
              <button class="toggle-btn active" data-view="monthly" onclick="toggleInboundSummary('monthly')">Monthly</button>
              <button class="toggle-btn" data-view="weekly" onclick="toggleInboundSummary('weekly')">Weekly</button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="text-left border-b border-as-border"><tr id="inboundSummaryHead"></tr></thead>
              <tbody id="inboundSummaryBody"></tbody>
            </table>
          </div>
        </section>

        <!-- KPIs -->
        <div id="inboundKPIs" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4 mb-6"></div>

        <!-- Funnel -->
        <div class="card mb-6">
          <span class="summary-header">Sales Funnel</span>
          <div id="funnelChart" class="space-y-2 mt-4"></div>
        </div>

        <!-- By Product (full width, nested breakdown) -->
        <div class="card mb-6">
          <span class="summary-header">By Product</span>
          <div class="overflow-x-auto mt-3">
            <table id="productTable" class="w-full">
              <thead class="text-left border-b border-as-border">
                <tr>
                  <th class="pb-2">Product</th>
                  <th class="pb-2 text-center">Leads</th>
                  <th class="pb-2 text-center">MQL<span style="text-transform:none">s</span></th>
                  <th class="pb-2 text-center">SQL<span style="text-transform:none">s</span></th>
                  <th class="pb-2 text-center" title="By close date (by create date in brackets)">Won</th>
                  <th class="pb-2 text-center" title="By close date (by create date in brackets)">Revenue</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Owner + Country side by side -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card flex flex-col">
            <span class="summary-header">By Deal Owner</span>
            <div class="overflow-x-auto mt-3 flex-1">
              <table id="ownerTable" class="w-full">
                <thead class="text-left border-b border-as-border">
                  <tr>
                    <th class="pb-2">Owner</th>
                    <th class="pb-2 text-center">MQL<span style="text-transform:none">s</span></th>
                    <th class="pb-2 text-center">SQL<span style="text-transform:none">s</span></th>
                    <th class="pb-2 text-center" title="By close date (by create date in brackets)">Won</th>
                    <th class="pb-2 text-center" title="By close date (by create date in brackets)">Revenue</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="ownerTableTotal" class="overflow-x-auto"></div>
          </div>
          <div class="card flex flex-col">
            <span class="summary-header">By Country</span>
            <div class="overflow-x-auto mt-3 flex-1">
              <table id="geoTable" class="w-full">
                <thead class="text-left border-b border-as-border">
                  <tr>
                    <th class="pb-2">Country</th>
                    <th class="pb-2 text-center">MQL<span style="text-transform:none">s</span></th>
                    <th class="pb-2 text-center">SQL<span style="text-transform:none">s</span></th>
                    <th class="pb-2 text-center" title="By close date (by create date in brackets)">Won</th>
                    <th class="pb-2 text-center" title="By close date (by create date in brackets)">Revenue</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="geoTableTotal" class="overflow-x-auto"></div>
          </div>
        </div>
      </div>

      <!-- ---- Self-Serve (Stripe) ---- -->
      <div id="selfServeSection">
        <h3 class="sub-title">Self-Serve</h3>

        <!-- Self-Serve Summary -->
        <section class="card mb-6">
          <div class="flex items-center justify-between mb-4">
            <span class="summary-header">Summary</span>
            <div class="flex" id="selfServeSummaryToggle">
              <button class="toggle-btn active" data-view="monthly" onclick="toggleSelfServeSummary('monthly')">Monthly</button>
              <button class="toggle-btn" data-view="weekly" onclick="toggleSelfServeSummary('weekly')">Weekly</button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="text-left border-b border-as-border"><tr id="selfServeSummaryHead"></tr></thead>
              <tbody id="selfServeSummaryBody"></tbody>
            </table>
          </div>
        </section>

        <!-- Filters -->
        <div class="flex flex-wrap items-center gap-2 mb-5" id="selfServeFilters">
          <select id="filterProduct" class="filter-select" onchange="onFilterChange()">
            <option value="all">All</option>
            <option value="mm">Machine-Made</option>
            <option value="hm">Human-Made</option>
            <option value="inv">Invoice</option>
          </select>
          <select id="filterPlanType" class="filter-select" onchange="onFilterChange()">
            <option value="all">All Types</option>
            <option value="prepaid">Prepaid</option>
            <option value="sub">Subscription</option>
          </select>
          <select id="filterSubtype" class="filter-select hidden" onchange="onFilterChange()">
          </select>
        </div>

        <!-- KPIs -->
        <div id="selfServeKPIs" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6"></div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card">
            <span class="summary-header">Revenue Trend</span>
            <div class="chart-container mt-3"><canvas id="selfServeRevenueChart"></canvas></div>
          </div>
          <div class="card">
            <span class="summary-header">Revenue by Channel</span>
            <div class="chart-container mt-3"><canvas id="selfServeChannelChart"></canvas></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- GOOGLE ADS                                   -->
    <!-- ============================================ -->
    <div>
      <h2 class="section-title">Google Ads</h2>

      <div id="adsKPIs" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6"></div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card">
          <span class="summary-header">Ad Spend: Machine-Made vs Human-Made</span>
          <div class="chart-container mt-3"><canvas id="mmVsHmChart"></canvas></div>
        </div>
        <div class="card">
          <span class="summary-header">Ad Spend by Product</span>
          <div class="chart-container mt-3"><canvas id="adProductChart"></canvas></div>
        </div>
      </div>
    </div>

    </div><!-- /page-Transcription -->

    <!-- ============================================ -->
    <!-- PAGE: MEDIA (BUM)                            -->
    <!-- ============================================ -->
    <div id="page-Media" class="bu-page hidden">
      <div class="flex flex-col items-center justify-center py-24 text-center">
        <div class="w-16 h-16 rounded-2xl bg-as-primary/10 flex items-center justify-center mb-5">
          <svg class="w-8 h-8 text-as-primary" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h1.5C5.496 19.5 6 18.996 6 18.375m-2.625 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-1.5A1.125 1.125 0 0 1 18 18.375M20.625 4.5H3.375m17.25 0c.621 0 1.125.504 1.125 1.125M20.625 4.5h-1.5C18.504 4.5 18 5.004 18 5.625m3.75 0v1.5c0 .621-.504 1.125-1.125 1.125M3.375 4.5c-.621 0-1.125.504-1.125 1.125M3.375 4.5h1.5C5.496 4.5 6 5.004 6 5.625m-2.625 0v1.5c0 .621.504 1.125 1.125 1.125m0 0h13.5c.621 0 1.125-.504 1.125-1.125m-14.625 0h14.625"/></svg>
        </div>
        <h2 class="text-xl font-bold text-as-text mb-2">Media (BUM)</h2>
        <p class="text-as-secondary text-sm max-w-md">Subtitles, dubbing, audio description, and localisation metrics. This page is under development.</p>
        <span class="mt-4 text-xs font-semibold uppercase tracking-wider text-as-accent bg-as-accent/10 px-3 py-1 rounded-full">Coming Soon</span>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- PAGE: INNOVATIONS (BUNS)                     -->
    <!-- ============================================ -->
    <div id="page-Innovations" class="bu-page hidden">
      <div class="flex flex-col items-center justify-center py-24 text-center">
        <div class="w-16 h-16 rounded-2xl bg-as-primary/10 flex items-center justify-center mb-5">
          <svg class="w-8 h-8 text-as-primary" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.383a14.406 14.406 0 0 1-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 1 0-7.517 0c.85.493 1.509 1.333 1.509 2.316V18"/></svg>
        </div>
        <h2 class="text-xl font-bold text-as-text mb-2">Innovations (BUNS)</h2>
        <p class="text-as-secondary text-sm max-w-md">AmberNotes and new product initiatives. This page is under development.</p>
        <span class="mt-4 text-xs font-semibold uppercase tracking-wider text-as-accent bg-as-accent/10 px-3 py-1 rounded-full">Coming Soon</span>
      </div>
    </div>

  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 py-8 text-center text-as-muted text-xs font-medium">
    Auto-updated daily via GitHub Actions &middot; Google Ads &middot; HubSpot &middot; Stripe &middot; GA4
  </footer>

<script>
let DATA = null;
let charts = {};
let inboundSummaryView = 'monthly';
let selfServeSummaryView = 'monthly';
let currentBU = 'Transcription';

const CHANNEL_COLORS = {
  'Direct': '#1A7B6B', 'Paid Search': '#005a50', 'Organic Search': '#2E7D32',
  'Referral': '#F5A623', 'Email': '#E69100', 'Subscription': '#7B1FA2',
  'Unknown': '#8899A6', 'Organic Video': '#0061FF', 'Affiliates': '#155F54',
  'Organic Social': '#E65100', 'Cross-network': '#5C6BC0', 'Unassigned': '#CFD9DE',
};

const fmt = {
  currency: (n) => new Intl.NumberFormat('en-EU', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n),
  number: (n) => new Intl.NumberFormat('en-US').format(n),
  pct: (n) => n.toFixed(1) + '%',
  shortDate: (d) => {
    const date = new Date(d + 'T00:00:00');
    return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
  },
  monthLabel: (m) => {
    const [y, mo] = m.split('-');
    return new Date(parseInt(y), parseInt(mo) - 1).toLocaleDateString('en-GB', { month: 'short', year: '2-digit' });
  },
};

// ===== DATA LOADING =====
async function loadData() {
  try {
    const res = await fetch('data.json');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    DATA = await res.json();
    render();
  } catch (err) {
    document.getElementById('lastUpdated').textContent = 'Error loading data: ' + err.message;
  }
}

// ===== DATE FILTERING =====
function getFilteredWeeks() {
  const mode = document.getElementById('dateRange').value;
  const allWeeks = DATA.weekly.ads.map(r => r.week).filter(Boolean);
  if (!allWeeks.length || mode === 'all') return allWeeks;

  const today = new Date();
  const dayOfWeek = today.getUTCDay() || 7;
  const thisMonday = new Date(today);
  thisMonday.setUTCDate(today.getUTCDate() - dayOfWeek + 1);
  const thisMondayStr = thisMonday.toISOString().slice(0, 10);
  const firstOfMonth = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), 1));

  if (mode === 'this-week') return allWeeks.filter(w => w >= thisMondayStr);
  if (mode === 'last-week') { const s = new Date(thisMonday); s.setUTCDate(s.getUTCDate()-7); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < thisMondayStr); }
  if (mode === 'last-2-weeks') { const s = new Date(thisMonday); s.setUTCDate(s.getUTCDate()-14); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < thisMondayStr); }
  if (mode === 'last-4-weeks') { const s = new Date(thisMonday); s.setUTCDate(s.getUTCDate()-28); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < thisMondayStr); }
  if (mode === 'this-month') return allWeeks.filter(w => w >= firstOfMonth.toISOString().slice(0,10));
  if (mode === 'last-month') { const s = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth()-1, 1)); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < firstOfMonth.toISOString().slice(0,10)); }
  if (mode === 'last-2-months') { const s = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth()-2, 1)); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < firstOfMonth.toISOString().slice(0,10)); }
  if (mode === 'last-4-months') { const s = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth()-4, 1)); return allWeeks.filter(w => w >= s.toISOString().slice(0,10) && w < firstOfMonth.toISOString().slice(0,10)); }
  return allWeeks;
}

function filterByWeeks(arr, weeks) {
  const set = new Set(weeks);
  return arr.filter(r => set.has(r.week));
}

// ===== BUSINESS UNIT =====
function getCurrentBU() {
  return currentBU;
}

function switchBU(bu) {
  currentBU = bu;
  // Update tab active states
  document.querySelectorAll('#buTabs .bu-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.bu === bu);
  });
  // Show/hide page containers
  document.querySelectorAll('.bu-page').forEach(page => {
    page.classList.toggle('hidden', page.id !== `page-${bu}`);
  });
  // Re-render if data is loaded
  if (DATA) render();
}

function getBU(product) {
  if (!product) return 'Transcription';
  const media = ['Human-Made Subtitles', 'Machine-Made Subtitles', 'Translated Subtitles', 'Translations', 'Subtitles'];
  const innovations = ['Amber Notes', 'AI Meeting Notes', 'Meeting Notes'];
  if (media.includes(product)) return 'Media';
  if (innovations.includes(product)) return 'Innovations';
  return 'Transcription';
}

// ===== INTERACTIONS =====
function getSegmentKey() {
  const product = document.getElementById('filterProduct').value;
  const planType = document.getElementById('filterPlanType').value;
  const subtype = document.getElementById('filterSubtype').value || 'all';
  return `${product}.${planType}.${subtype}`;
}

function onFilterChange() {
  const product = document.getElementById('filterProduct').value;
  const planTypeEl = document.getElementById('filterPlanType');
  const subtypeEl = document.getElementById('filterSubtype');

  if (product === 'hm' || product === 'inv') {
    planTypeEl.classList.add('hidden');
    planTypeEl.value = 'all';
    subtypeEl.classList.add('hidden');
    subtypeEl.value = 'all';
  } else {
    planTypeEl.classList.remove('hidden');
  }

  const planType = planTypeEl.value;
  if (planType === 'prepaid') {
    subtypeEl.innerHTML = '<option value="all">All Prepaid</option><option value="topup">Top-Up</option><option value="job">Job Creation</option>';
    subtypeEl.classList.remove('hidden');
  } else if (planType === 'sub') {
    subtypeEl.innerHTML = '<option value="all">All Subscriptions</option><option value="update">Update</option><option value="creation">Creation</option>';
    subtypeEl.classList.remove('hidden');
  } else {
    subtypeEl.classList.add('hidden');
    subtypeEl.value = 'all';
  }

  renderSelfServe(getFilteredWeeks());
}

function toggleInboundSummary(view) {
  inboundSummaryView = view;
  document.querySelectorAll('#inboundSummaryToggle .toggle-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.view === view);
  });
  renderInboundSummary(getFilteredWeeks());
}

function toggleSelfServeSummary(view) {
  selfServeSummaryView = view;
  document.querySelectorAll('#selfServeSummaryToggle .toggle-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.view === view);
  });
  renderSelfServeSummary(getFilteredWeeks());
}

// ===== KPI CARD HELPER =====
function kpiCard(label, value, color, sub) {
  return `<div class="kpi-card card !p-4 !pl-5" style="--kpi-color: ${color}">
    <p class="text-[0.6875rem] font-semibold uppercase tracking-wider text-as-muted">${label}</p>
    <p class="text-lg font-bold mt-1" style="color: ${color}">${value}</p>
    ${sub ? `<p class="text-xs font-semibold text-as-secondary mt-0.5">${sub}</p>` : ''}
  </div>`;
}

// ===== MAIN RENDER =====
function render() {
  const weeks = getFilteredWeeks();
  document.getElementById('lastUpdated').textContent =
    `Last updated: ${new Date(DATA.updatedAt).toLocaleString('en-GB')} \u00b7 ${DATA.dateRange.start} to ${DATA.dateRange.end}`;

  // Only render content for Transcription page (other pages are placeholders)
  if (currentBU !== 'Transcription') return;

  populateInboundFilters();
  renderInboundSummary(weeks);
  renderSelfServeSummary(weeks);
  renderSelfServe(weeks);
  renderInbound(weeks);
  renderGoogleAds(weeks);
}

// ===== INBOUND SUMMARY =====
function renderInboundSummary(weeks) {
  const bu = getCurrentBU();
  const head = document.getElementById('inboundSummaryHead');
  const body = document.getElementById('inboundSummaryBody');
  const ads = filterByWeeks(DATA.weekly.ads, weeks);
  const adsMap = Object.fromEntries(ads.map(r => [r.week, r]));

  function getHmCost(weekList) {
    let cost = 0;
    for (const w of weekList) {
      const a = adsMap[w];
      if (!a) continue;
      cost += (a.byBU?.[bu]?.hmCost || 0);
    }
    return cost;
  }

  // Use the same filters as the rest of the inbound section
  function computeFunnel(weekList) {
    const ws = new Set(weekList);
    const deals = getFilteredDeals(ws);
    const closedDeals = getClosedDeals(ws);
    const forms = getFilteredForms(ws);
    const leads = forms.reduce((s, r) => s + r.count, 0);
    const mqls = deals.length;
    const mqlsFL = deals.filter(d => d.formId).length;
    const sqls = deals.filter(d => ['SQL', 'Customer'].includes(d.lifecycleStage)).length;
    const won = deals.filter(d => d.status === 'Won').length;
    const wonRev = deals.filter(d => d.status === 'Won').reduce((s, d) => s + (d.amount || 0), 0);
    const wonClose = closedDeals.length;
    const wonRevClose = closedDeals.reduce((s, d) => s + (d.amount || 0), 0);
    return { leads, mqls, mqlsFL, sqls, won, wonRev, wonClose, wonRevClose };
  }

  function mqlCell(mqls, mqlsFL) {
    return `${fmt.number(mqls)} <span class="text-as-muted">(${fmt.number(mqlsFL)})</span>`;
  }

  // col-gap adds left padding to visually group related columns
  const g = 'pl-5'; // group separator
  const summaryHead = (label) => `
      <th class="pb-2">${label}</th>
      <th class="pb-2 text-center">Spend</th>
      <th class="pb-2 text-center ${g}">Leads</th>
      <th class="pb-2 text-center">MQL<span style="text-transform:none">s</span></th>
      <th class="pb-2 text-center">L&gt;MQL</th>
      <th class="pb-2 text-center ${g}">SQL<span style="text-transform:none">s</span></th>
      <th class="pb-2 text-center">MQL&gt;SQL</th>
      <th class="pb-2 text-center ${g}" title="By close date (by create date in brackets)">Won</th>
      <th class="pb-2 text-center">SQL&gt;Won</th>
      <th class="pb-2 text-center ${g}" title="By close date (by create date in brackets)">Revenue</th>
      <th class="pb-2 text-center ${g}">AOV</th>
  `;
  function summaryRow(label, hmCost, f) {
    const l2m = f.leads > 0 ? (f.mqlsFL / f.leads * 100).toFixed(1) + '%' : '-';
    const m2s = f.mqls > 0 ? (f.sqls / f.mqls * 100).toFixed(1) + '%' : '-';
    const s2w = f.sqls > 0 ? (f.won / f.sqls * 100).toFixed(1) + '%' : '-';
    const aov = f.wonClose > 0 ? fmt.currency(Math.round(f.wonRevClose / f.wonClose)) : '-';
    return `<tr class="border-b border-as-border/40 hover-row">
      <td class="py-2.5 font-semibold text-sm">${label}</td>
      <td class="py-2.5 text-center text-as-secondary">${fmt.currency(hmCost)}</td>
      <td class="py-2.5 text-center text-as-secondary ${g}">${fmt.number(f.leads)}</td>
      <td class="py-2.5 text-center text-as-secondary">${mqlCell(f.mqls, f.mqlsFL)}</td>
      <td class="py-2.5 text-center text-as-muted">${l2m}</td>
      <td class="py-2.5 text-center text-as-secondary ${g}">${fmt.number(f.sqls)}</td>
      <td class="py-2.5 text-center text-as-muted">${m2s}</td>
      <td class="py-2.5 text-center text-as-secondary ${g}">${fmt.number(f.wonClose)} <span class="text-as-muted">(${fmt.number(f.won)})</span></td>
      <td class="py-2.5 text-center text-as-muted">${s2w}</td>
      <td class="py-2.5 text-center font-semibold ${g}">${fmt.currency(f.wonRevClose)} <span class="text-as-muted font-normal">(${fmt.currency(f.wonRev)})</span></td>
      <td class="py-2.5 text-center text-as-secondary ${g}">${aov}</td>
    </tr>`;
  }

  if (inboundSummaryView === 'monthly') {
    const allMonths = [...new Set(weeks.map(w => w.slice(0, 7)))].sort();
    head.innerHTML = summaryHead('Month');
    body.innerHTML = allMonths.map(month => {
      const monthWeeks = weeks.filter(w => w.slice(0, 7) === month);
      return summaryRow(fmt.monthLabel(month), getHmCost(monthWeeks), computeFunnel(monthWeeks));
    }).join('');
  } else {
    head.innerHTML = summaryHead('Week');
    body.innerHTML = weeks.map(w => {
      return summaryRow(fmt.shortDate(w), getHmCost([w]), computeFunnel([w]));
    }).join('');
  }
}

// ===== SELF-SERVE SUMMARY =====
function renderSelfServeSummary(weeks) {
  const bu = getCurrentBU();
  const head = document.getElementById('selfServeSummaryHead');
  const body = document.getElementById('selfServeSummaryBody');

  function getMmCost(weekList, adsMap) {
    let cost = 0;
    for (const w of weekList) {
      const a = adsMap[w];
      if (!a) continue;
      cost += (a.byBU?.Transcription?.mmCost || 0);
    }
    return cost;
  }

  const ads = filterByWeeks(DATA.weekly.ads, weeks);
  const adsMap = Object.fromEntries(ads.map(r => [r.week, r]));

  if (selfServeSummaryView === 'monthly') {
    const allMonths = [...new Set(weeks.map(w => w.slice(0, 7)))].sort();
    head.innerHTML = `
      <th class="pb-2">Month</th>
      <th class="pb-2 text-center">MM Spend</th>
      <th class="pb-2 text-center">Payments</th>
      <th class="pb-2 text-center">Revenue</th>
      <th class="pb-2 text-center">New Subs</th>
      <th class="pb-2 text-center">Active Subs</th>
    `;
    body.innerHTML = allMonths.map(month => {
      const monthWeeks = weeks.filter(w => w.slice(0, 7) === month);
      const mmCost = getMmCost(monthWeeks, adsMap);
      const stripe = filterByWeeks(DATA.weekly.stripe, monthWeeks);
      let payments = 0, revenue = 0, newSubs = 0;
      for (const s of stripe) {
        const seg = s.seg || {};
        payments += (seg['all.all.all'] || {}).count || 0;
        revenue += (seg['all.all.all'] || {}).revenue || 0;
        newSubs += (seg['all.sub.creation'] || {}).count || 0;
      }
      return `<tr class="border-b border-as-border/40 hover-row">
        <td class="py-2.5 font-semibold text-sm">${fmt.monthLabel(month)}</td>
        <td class="py-2.5 text-center text-as-secondary">${fmt.currency(mmCost)}</td>
        <td class="py-2.5 text-center text-as-secondary">${fmt.number(payments)}</td>
        <td class="py-2.5 text-center font-semibold">${fmt.currency(revenue)}</td>
        <td class="py-2.5 text-center text-as-secondary">${fmt.number(newSubs)}</td>
        <td class="py-2.5 text-center text-as-muted">-</td>
      </tr>`;
    }).join('');
  } else {
    head.innerHTML = `
      <th class="pb-2">Week</th>
      <th class="pb-2 text-center">MM Spend</th>
      <th class="pb-2 text-center">Payments</th>
      <th class="pb-2 text-center">Revenue</th>
      <th class="pb-2 text-center">New Subs</th>
    `;
    body.innerHTML = weeks.map(w => {
      const mmCost = getMmCost([w], adsMap);
      const s = filterByWeeks(DATA.weekly.stripe, [w])[0] || {};
      const seg = s.seg || {};
      const payments = (seg['all.all.all'] || {}).count || 0;
      const revenue = (seg['all.all.all'] || {}).revenue || 0;
      const newSubs = (seg['all.sub.creation'] || {}).count || 0;
      return `<tr class="border-b border-as-border/40 hover-row">
        <td class="py-2.5 font-semibold text-sm">${fmt.shortDate(w)}</td>
        <td class="py-2.5 text-center text-as-secondary">${fmt.currency(mmCost)}</td>
        <td class="py-2.5 text-center text-as-secondary">${fmt.number(payments)}</td>
        <td class="py-2.5 text-center font-semibold">${fmt.currency(revenue)}</td>
        <td class="py-2.5 text-center text-as-secondary">${fmt.number(newSubs)}</td>
      </tr>`;
    }).join('');
  }
}

// ===== SELF-SERVE (Stripe) =====
function renderSelfServe(weeks) {
  const stripe = filterByWeeks(DATA.weekly.stripe, weeks);
  const segKey = getSegmentKey();

  let totalPayments = 0, totalRevenue = 0, newSubs = 0;
  const product = document.getElementById('filterProduct').value;
  const planType = document.getElementById('filterPlanType').value;
  for (const row of stripe) {
    const seg = row.seg || {};
    const s = seg[segKey] || { count: 0, revenue: 0 };
    totalPayments += s.count;
    totalRevenue += s.revenue;
    const subCreationKey = `${product}.sub.creation`;
    if (planType === 'all' || planType === 'sub') {
      newSubs += (seg[subCreationKey] || { count: 0 }).count;
    }
  }

  document.getElementById('selfServeKPIs').innerHTML = [
    { label: 'Payments', value: fmt.number(totalPayments), color: '#0F1419' },
    { label: 'Revenue', value: fmt.currency(totalRevenue), color: '#1A7B6B' },
    { label: 'New Subscriptions', value: fmt.number(newSubs), color: '#7B1FA2' },
    { label: 'Active Subscriptions', value: '-', color: '#8899A6' },
  ].map(k => kpiCard(k.label, k.value, k.color)).join('');

  destroyChart('selfServeRevenueChart');
  charts.selfServeRevenueChart = new Chart(document.getElementById('selfServeRevenueChart'), {
    type: 'bar',
    data: {
      labels: stripe.map(r => fmt.shortDate(r.week)),
      datasets: [{
        label: 'Revenue',
        data: stripe.map(r => (r.seg?.[segKey] || { revenue: 0 }).revenue),
        backgroundColor: 'rgba(26,123,107,0.15)',
        borderColor: '#1A7B6B',
        borderWidth: 1.5,
        borderRadius: 4,
      }],
    },
    options: chartOptions('EUR'),
  });

  destroyChart('selfServeChannelChart');
  const channelTotals = {};
  for (const row of stripe) {
    for (const [ch, data] of Object.entries(row.byChannel || {})) {
      channelTotals[ch] = (channelTotals[ch] || 0) + data.revenue;
    }
  }
  const channels = Object.keys(channelTotals).sort((a, b) => channelTotals[b] - channelTotals[a]);
  charts.selfServeChannelChart = new Chart(document.getElementById('selfServeChannelChart'), {
    type: 'doughnut',
    data: {
      labels: channels,
      datasets: [{
        data: channels.map(c => Math.round(channelTotals[c])),
        backgroundColor: channels.map(c => CHANNEL_COLORS[c] || '#8899A6'),
        borderWidth: 0,
      }],
    },
    options: doughnutOptions(),
  });
}

// ===== INBOUND FILTER LOGIC =====
const DACH = ['DE', 'AT', 'CH'];

function getKnownCountries() {
  const bu = getCurrentBU();
  return new Set((DATA.deals || []).filter(d => d.bu === bu).map(d => d.country).filter(Boolean));
}

function matchCountry(dealCountry, filterVal) {
  if (filterVal === 'all') return true;
  if (filterVal === 'DACH') return DACH.includes(dealCountry);
  if (filterVal === 'Other') return !getKnownCountries().has(dealCountry);
  return dealCountry === filterVal;
}

function populateInboundFilters() {
  if (!DATA.deals) return;
  const bu = getCurrentBU();
  const deals = DATA.deals.filter(d => d.bu === bu);

  const products = [...new Set(deals.map(d => d.product).filter(Boolean))].sort()
    .filter(p => p !== 'Other');
  const prodEl = document.getElementById('inbProductFilter');
  prodEl.innerHTML = '<option value="all">All Products</option>' +
    products.map(p => `<option value="${p}">${p}</option>`).join('') +
    '<option value="Other">Other</option>';

  const countryCounts = {};
  for (const d of deals) { if (d.country) countryCounts[d.country] = (countryCounts[d.country] || 0) + 1; }
  const countries = Object.keys(countryCounts).sort((a, b) => countryCounts[b] - countryCounts[a]);
  const topCountries = countries.slice(0, 4);
  const moreCountries = countries.slice(4);
  const countryEl = document.getElementById('inbCountryFilter');
  countryEl.innerHTML = '<option value="all">All Countries</option><option value="DACH">DACH (DE+AT+CH)</option>' +
    topCountries.map(c => `<option value="${c}">${c}</option>`).join('') +
    (moreCountries.length ? '<optgroup label="More">' + moreCountries.map(c => `<option value="${c}">${c}</option>`).join('') + '<option value="Other">Other</option></optgroup>' : '<option value="Other">Other</option>');
}

function onInboundFilterChange() {
  const product = document.getElementById('inbProductFilter').value;
  const styleEl = document.getElementById('inbStyleFilter');
  const optionsEl = document.getElementById('inbOptionsFilter');

  if (product === 'Human-Made Transcription') {
    const styles = [...new Set((DATA.deals || []).map(d => d.transcriptionStyle).filter(Boolean))].sort();
    styleEl.innerHTML = '<option value="all">All Styles</option>' +
      styles.map(s => `<option value="${s}">${s}</option>`).join('');
    styleEl.classList.remove('hidden');
  } else {
    styleEl.classList.add('hidden');
    styleEl.value = 'all';
    optionsEl.classList.add('hidden');
    optionsEl.value = 'all';
  }

  const style = styleEl.value;
  if (product === 'Human-Made Transcription' && (style === 'Verbatim' || style === 'Clean-Verbatim')) {
    const opts = [...new Set((DATA.deals || []).filter(d =>
      d.product === product && d.transcriptionStyle === style && d.additionalOptions
    ).map(d => d.additionalOptions))].sort();
    if (opts.length > 0) {
      optionsEl.innerHTML = '<option value="all">All Options</option>' +
        opts.map(o => `<option value="${o}">${o}</option>`).join('');
      optionsEl.classList.remove('hidden');
    } else {
      optionsEl.classList.add('hidden');
      optionsEl.value = 'all';
    }
  } else {
    optionsEl.classList.add('hidden');
    optionsEl.value = 'all';
  }

  const weeks = getFilteredWeeks();
  renderInboundSummary(weeks);
  renderInbound(weeks);
}

function getFilteredDeals(weekSet) {
  const bu = getCurrentBU();
  const product = document.getElementById('inbProductFilter').value;
  const style = document.getElementById('inbStyleFilter').value;
  const options = document.getElementById('inbOptionsFilter').value;
  const country = document.getElementById('inbCountryFilter').value;

  return (DATA.deals || []).filter(d => {
    if (!weekSet.has(d.week)) return false;
    if (d.bu !== bu) return false;
    if (product !== 'all' && d.product !== product) return false;
    if (style !== 'all' && d.transcriptionStyle !== style) return false;
    if (options !== 'all' && d.additionalOptions !== options) return false;
    if (!matchCountry(d.country, country)) return false;
    return true;
  });
}

function getFilteredForms(weekSet) {
  const bu = getCurrentBU();
  const country = document.getElementById('inbCountryFilter').value;
  return (DATA.ga4Forms || []).filter(f => {
    if (!weekSet.has(f.week)) return false;
    if (f.bu && f.bu !== bu) return false;
    if (!matchCountry(f.country, country)) return false;
    return true;
  });
}

function getClosedDeals(weekSet) {
  const bu = getCurrentBU();
  const product = document.getElementById('inbProductFilter').value;
  const style = document.getElementById('inbStyleFilter').value;
  const options = document.getElementById('inbOptionsFilter').value;
  const country = document.getElementById('inbCountryFilter').value;
  return (DATA.deals || []).filter(d => {
    if (d.status !== 'Won') return false;
    if (!d.closeWeek || !weekSet.has(d.closeWeek)) return false;
    if (d.bu !== bu) return false;
    if (product !== 'all' && d.product !== product) return false;
    if (style !== 'all' && d.transcriptionStyle !== style) return false;
    if (options !== 'all' && d.additionalOptions !== options) return false;
    if (!matchCountry(d.country, country)) return false;
    return true;
  });
}

// ===== INBOUND (HubSpot + GA4 Leads) =====
function renderInbound(weeks) {
  const weekSet = new Set(weeks);
  const deals = getFilteredDeals(weekSet);
  const forms = getFilteredForms(weekSet);

  const leads = forms.reduce((s, r) => s + r.count, 0);
  const mqls = deals.length;
  const mqlsFromLeads = deals.filter(r => r.formId).length;
  const sqls = deals.filter(r => ['SQL', 'Customer'].includes(r.lifecycleStage)).length;
  const sqlsFromLeads = deals.filter(r => r.formId && ['SQL', 'Customer'].includes(r.lifecycleStage)).length;
  const won = deals.filter(r => r.status === 'Won').length;
  const wonFromLeads = deals.filter(r => r.formId && r.status === 'Won').length;
  const wonRev = deals.filter(r => r.status === 'Won').reduce((s, r) => s + (r.amount || 0), 0);
  const closedDeals = getClosedDeals(weekSet);
  const wonClose = closedDeals.length;
  const wonRevClose = closedDeals.reduce((s, r) => s + (r.amount || 0), 0);
  const aov = won > 0 ? fmt.currency(Math.round(wonRev / won)) : '-';

  document.getElementById('inboundKPIs').innerHTML = [
    { label: 'Leads (GA4)', value: fmt.number(leads), color: '#005a50' },
    { label: 'MQL<span style="text-transform:none">s</span>', value: `${fmt.number(mqls)} <span class="text-[0.6875rem] text-as-muted font-normal">(${fmt.number(mqlsFromLeads)} from leads)</span>`, color: '#0F6B5E' },
    { label: 'SQL<span style="text-transform:none">s</span>', value: `${fmt.number(sqls)} <span class="text-[0.6875rem] text-as-muted font-normal">(${fmt.number(sqlsFromLeads)} from leads)</span>`, color: '#1A7B6B' },
    { label: 'Won Deals', value: fmt.number(wonClose), color: '#F5A623', sub: `${fmt.number(won)} by create date` },
    { label: 'Deal Revenue', value: fmt.currency(wonRevClose), color: '#F5A623', sub: `${fmt.currency(wonRev)} by create date` },
    { label: 'Deal AOV', value: aov, color: '#E69100' },
  ].map(k => kpiCard(k.label, k.value, k.color, k.sub)).join('');

  // Funnel
  const max = Math.max(leads, 1);
  const stages = [
    { label: 'Leads', count: leads, color: '#005a50', pct: 100 },
    { label: 'MQL<span style="text-transform:none">s</span>', count: mqls, color: '#0F6B5E', pct: (mqls / max * 100) },
    { label: 'SQL<span style="text-transform:none">s</span>', count: sqls, color: '#1A7B6B', pct: (sqls / max * 100) },
    { label: 'Won', count: won, color: '#F5A623', pct: (won / max * 100) },
  ];
  const l2m = leads > 0 ? (mqls/leads*100).toFixed(1) + '%' : '-';
  const m2s = mqls > 0 ? (sqls/mqls*100).toFixed(1) + '%' : '-';
  const s2w = sqls > 0 ? (won/sqls*100).toFixed(1) + '%' : '-';
  const l2mFL = leads > 0 ? (mqlsFromLeads/leads*100).toFixed(1) + '%' : '-';
  const m2sFL = mqlsFromLeads > 0 ? (sqlsFromLeads/mqlsFromLeads*100).toFixed(1) + '%' : '-';
  const s2wFL = sqlsFromLeads > 0 ? (wonFromLeads/sqlsFromLeads*100).toFixed(1) + '%' : '-';

  document.getElementById('funnelChart').innerHTML = stages.map(s => `
    <div class="flex items-center gap-3">
      <span class="funnel-label">${s.label}</span>
      <div class="funnel-track flex-1">
        <div class="funnel-fill" style="width:${Math.max(s.pct,5)}%;background:${s.color}">
          <span class="text-white text-xs font-bold">${fmt.number(s.count)}</span>
        </div>
      </div>
    </div>
  `).join('') + `
    <table class="mt-3 ml-14" style="border-spacing:0">
      <thead><tr>
        <th></th>
        <th class="text-center pb-1 px-3" style="min-width:90px">Lead &gt; MQL</th>
        <th class="text-center pb-1 px-3" style="min-width:90px">MQL &gt; SQL</th>
        <th class="text-center pb-1 px-3" style="min-width:90px">SQL &gt; Won</th>
      </tr></thead>
      <tbody>
        <tr>
          <td class="pr-2"><span class="conv-pill">All deals</span></td>
          <td class="text-center px-3 text-sm font-semibold text-as-secondary">${l2m}</td>
          <td class="text-center px-3 text-sm font-semibold text-as-secondary">${m2s}</td>
          <td class="text-center px-3 text-sm font-semibold text-as-secondary">${s2w}</td>
        </tr>
        <tr>
          <td class="pr-2"><span class="conv-pill" style="background:#E8ECF0">From lead</span></td>
          <td class="text-center px-3 text-sm font-semibold text-as-secondary">${l2mFL}</td>
          <td class="text-center px-3 text-sm font-semibold text-as-secondary">${m2sFL}</td>
          <td class="text-center px-3 text-sm font-semibold text-as-secondary">${s2wFL}</td>
        </tr>
      </tbody>
    </table>`;

  // Breakdown tables
  renderProductTable(deals, closedDeals, forms);
  renderBreakdownTable(deals, closedDeals, 'ownerTable', d => d.ownerName || 'Unknown');
  renderBreakdownTable(deals, closedDeals, 'geoTable', d => d.country || 'Unknown');
}

let productExpandState = {};

function renderProductTable(deals, closedDeals, forms) {
  function tally(dealList) {
    const t = { mqls: 0, sqls: 0, won: 0, wonRevenue: 0 };
    for (const d of dealList) {
      t.mqls++;
      if (['SQL', 'Customer'].includes(d.lifecycleStage)) t.sqls++;
      if (d.status === 'Won') { t.won++; t.wonRevenue += d.amount || 0; }
    }
    return t;
  }
  function closeTally(dealList) {
    return { won: dealList.length, wonRevenue: dealList.reduce((s, d) => s + (d.amount || 0), 0) };
  }
  function cells(t, ct, leads, size) {
    const cls = size === 'sm' ? 'text-sm' : 'text-xs';
    return `
      <td class="py-1.5 text-center text-as-secondary ${cls}">${fmt.number(leads)}</td>
      <td class="py-1.5 text-center text-as-secondary ${cls}">${fmt.number(t.mqls)}</td>
      <td class="py-1.5 text-center text-as-secondary ${cls}">${fmt.number(t.sqls)}</td>
      <td class="py-1.5 text-center text-as-secondary ${cls}">${fmt.number(ct.won)} <span class="text-as-muted">(${fmt.number(t.won)})</span></td>
      <td class="py-1.5 text-center font-semibold ${cls}">${fmt.currency(ct.wonRevenue)} <span class="text-as-muted font-normal">(${fmt.currency(t.wonRevenue)})</span></td>`;
  }

  // Count leads by product from GA4 forms
  const leadsByProduct = {};
  for (const f of forms) {
    const p = f.product || 'Other';
    leadsByProduct[p] = (leadsByProduct[p] || 0) + f.count;
  }
  const totalLeads = forms.reduce((s, f) => s + f.count, 0);

  // Group deals by product
  const byProduct = {};
  for (const d of deals) {
    const p = d.product || 'Other';
    (byProduct[p] = byProduct[p] || []).push(d);
  }
  const closeByProduct = {};
  for (const d of closedDeals) {
    const p = d.product || 'Other';
    (closeByProduct[p] = closeByProduct[p] || []).push(d);
  }
  // Include products that only have leads or closed deals
  for (const p of Object.keys(leadsByProduct)) {
    if (!byProduct[p]) byProduct[p] = [];
  }
  for (const p of Object.keys(closeByProduct)) {
    if (!byProduct[p]) byProduct[p] = [];
  }
  const products = Object.keys(byProduct).sort((a, b) => {
    const aCount = byProduct[b].length - byProduct[a].length;
    return aCount !== 0 ? aCount : (leadsByProduct[b] || 0) - (leadsByProduct[a] || 0);
  });

  let html = '';
  for (const prod of products) {
    const prodDeals = byProduct[prod];
    const prodClosed = closeByProduct[prod] || [];
    const prodLeads = leadsByProduct[prod] || 0;
    html += `<tr class="border-b border-as-border/40 hover-row">
      <td class="py-2 text-sm font-semibold">${prod}</td>${cells(tally(prodDeals), closeTally(prodClosed), prodLeads, 'sm')}
    </tr>`;

    // Nested breakdown for Human-Made Transcription
    if (prod === 'Human-Made Transcription') {
      const byStyle = {};
      for (const d of prodDeals) {
        const s = d.transcriptionStyle || '(no style)';
        (byStyle[s] = byStyle[s] || []).push(d);
      }
      const closeByStyle = {};
      for (const d of prodClosed) {
        const s = d.transcriptionStyle || '(no style)';
        (closeByStyle[s] = closeByStyle[s] || []).push(d);
      }
      const styles = Object.keys(byStyle).sort((a, b) => byStyle[b].length - byStyle[a].length);
      for (const style of styles) {
        const styleDeals = byStyle[style];
        const styleClosed = closeByStyle[style] || [];
        const styleId = style.replace(/[^a-zA-Z]/g, '');

        // Check if this style has expandable options
        const byOpt = {};
        for (const d of styleDeals) {
          if (d.additionalOptions) {
            (byOpt[d.additionalOptions] = byOpt[d.additionalOptions] || []).push(d);
          }
        }
        const closeByOpt = {};
        for (const d of styleClosed) {
          if (d.additionalOptions) {
            (closeByOpt[d.additionalOptions] = closeByOpt[d.additionalOptions] || []).push(d);
          }
        }
        const opts = Object.keys(byOpt).sort((a, b) => byOpt[b].length - byOpt[a].length);
        const hasOpts = opts.length > 0;
        const expanded = productExpandState[styleId] || false;
        const chevron = hasOpts
          ? `<svg class="inline w-3 h-3 ml-1 transition-transform ${expanded ? 'rotate-90' : ''}" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>`
          : '';
        const clickAttr = hasOpts ? `style="cursor:pointer" onclick="toggleProductStyle('${styleId}')"` : '';

        html += `<tr class="border-b border-as-border/40 hover-row" ${clickAttr}>
          <td class="py-1.5 text-xs text-as-secondary pl-5">${style}${chevron}</td>${cells(tally(styleDeals), closeTally(styleClosed), '-', 'xs')}
        </tr>`;

        for (const opt of opts) {
          html += `<tr class="border-b border-as-border/40 hover-row prod-opt-${styleId}" ${expanded ? '' : 'style="display:none"'}>
            <td class="py-1 text-xs text-as-muted pl-10">${opt}</td>${cells(tally(byOpt[opt]), closeTally(closeByOpt[opt] || []), '-', 'xs')}
          </tr>`;
        }
      }
    }
  }
  const total = tally(deals);
  const closeTotal = closeTally(closedDeals);
  html += `<tr class="border-t-2 border-as-border">
    <td class="py-2 text-sm font-bold">Total</td>
    <td class="py-2 text-center font-bold text-sm">${fmt.number(totalLeads)}</td>
    <td class="py-2 text-center font-bold text-sm">${fmt.number(total.mqls)}</td>
    <td class="py-2 text-center font-bold text-sm">${fmt.number(total.sqls)}</td>
    <td class="py-2 text-center font-bold text-sm">${fmt.number(closeTotal.won)} <span class="font-normal text-as-muted">(${fmt.number(total.won)})</span></td>
    <td class="py-2 text-center font-bold text-sm">${fmt.currency(closeTotal.wonRevenue)} <span class="font-normal text-as-muted">(${fmt.currency(total.wonRevenue)})</span></td>
  </tr>`;
  document.querySelector('#productTable tbody').innerHTML = html;
}

function toggleProductStyle(styleId) {
  productExpandState[styleId] = !productExpandState[styleId];
  const rows = document.querySelectorAll(`.prod-opt-${styleId}`);
  const show = productExpandState[styleId];
  rows.forEach(r => r.style.display = show ? '' : 'none');
  // Rotate chevron
  const parentRow = rows[0]?.previousElementSibling;
  if (parentRow) {
    const svg = parentRow.querySelector('svg');
    if (svg) svg.classList.toggle('rotate-90', show);
  }
}

function renderBreakdownTable(deals, closedDeals, tableId, keyFn) {
  const totals = {};
  for (const d of deals) {
    const key = keyFn(d);
    if (!totals[key]) totals[key] = { mqls: 0, sqls: 0, won: 0, wonRevenue: 0, wonClose: 0, wonRevClose: 0 };
    totals[key].mqls++;
    if (['SQL', 'Customer'].includes(d.lifecycleStage)) totals[key].sqls++;
    if (d.status === 'Won') { totals[key].won++; totals[key].wonRevenue += d.amount || 0; }
  }
  for (const d of closedDeals) {
    const key = keyFn(d);
    if (!totals[key]) totals[key] = { mqls: 0, sqls: 0, won: 0, wonRevenue: 0, wonClose: 0, wonRevClose: 0 };
    totals[key].wonClose++;
    totals[key].wonRevClose += d.amount || 0;
  }
  const keys = Object.keys(totals).sort((a, b) => totals[b].mqls - totals[a].mqls);
  const sum = { mqls: 0, sqls: 0, won: 0, wonRevenue: 0, wonClose: 0, wonRevClose: 0 };
  for (const k of keys) { sum.mqls += totals[k].mqls; sum.sqls += totals[k].sqls; sum.won += totals[k].won; sum.wonRevenue += totals[k].wonRevenue; sum.wonClose += totals[k].wonClose; sum.wonRevClose += totals[k].wonRevClose; }
  document.querySelector(`#${tableId} tbody`).innerHTML = keys.map(k => {
    const d = totals[k];
    return `<tr class="border-b border-as-border/40 hover-row">
      <td class="py-2 font-medium text-sm">${k}</td>
      <td class="py-2 text-center text-as-secondary">${fmt.number(d.mqls)}</td>
      <td class="py-2 text-center text-as-secondary">${fmt.number(d.sqls)}</td>
      <td class="py-2 text-center text-as-secondary">${fmt.number(d.wonClose)} <span class="text-as-muted">(${fmt.number(d.won)})</span></td>
      <td class="py-2 text-center font-semibold">${fmt.currency(d.wonRevClose)} <span class="text-as-muted font-normal">(${fmt.currency(d.wonRevenue)})</span></td>
    </tr>`;
  }).join('');
  document.getElementById(`${tableId}Total`).innerHTML = `<table class="w-full">
    <tr class="border-t-2 border-as-border">
      <td class="py-2 font-bold text-sm">Total</td>
      <td class="py-2 text-center font-bold text-sm">${fmt.number(sum.mqls)}</td>
      <td class="py-2 text-center font-bold text-sm">${fmt.number(sum.sqls)}</td>
      <td class="py-2 text-center font-bold text-sm">${fmt.number(sum.wonClose)} <span class="font-normal text-as-muted">(${fmt.number(sum.won)})</span></td>
      <td class="py-2 text-center font-bold text-sm">${fmt.currency(sum.wonRevClose)} <span class="font-normal text-as-muted">(${fmt.currency(sum.wonRevenue)})</span></td>
    </tr>
  </table>`;
}

// ===== GOOGLE ADS =====
function renderGoogleAds(weeks) {
  const bu = getCurrentBU();
  const ads = filterByWeeks(DATA.weekly.ads, weeks);
  const stripe = filterByWeeks(DATA.weekly.stripe, weeks);

  const totalCost = ads.reduce((s, r) => s + (r.byBU?.[bu]?.totalCost || 0), 0);
  const mmCost = ads.reduce((s, r) => s + (r.byBU?.[bu]?.mmCost || 0), 0);
  const hmCost = ads.reduce((s, r) => s + (r.byBU?.[bu]?.hmCost || 0), 0);
  const brandCost = ads.reduce((s, r) => s + (r.byBU?.[bu]?.brandCost || 0), 0);

  const stripeRev = bu === 'Transcription'
    ? stripe.reduce((s, r) => s + r.totalRevenue, 0) : 0;
  const roas = totalCost > 0 && stripeRev > 0 ? (stripeRev / totalCost).toFixed(1) + 'x' : '-';

  document.getElementById('adsKPIs').innerHTML = [
    { label: 'Total Spend', value: fmt.currency(totalCost), color: '#E03E3E' },
    { label: 'ROAS', value: roas, color: '#1A7B6B' },
    { label: 'Machine-Made', value: fmt.currency(mmCost), color: '#1A7B6B' },
    { label: 'Human-Made', value: fmt.currency(hmCost), color: '#7B1FA2' },
  ].map(k => kpiCard(k.label, k.value, k.color)).join('');

  destroyChart('mmVsHmChart');
  charts.mmVsHmChart = new Chart(document.getElementById('mmVsHmChart'), {
    type: 'bar',
    data: {
      labels: ads.map(r => fmt.shortDate(r.week)),
      datasets: [
        { label: 'Machine-Made', data: ads.map(r => r.byBU?.[bu]?.mmCost || 0), backgroundColor: 'rgba(26,123,107,0.2)', borderColor: '#1A7B6B', borderWidth: 1.5, borderRadius: 3 },
        { label: 'Human-Made', data: ads.map(r => r.byBU?.[bu]?.hmCost || 0), backgroundColor: 'rgba(123,31,162,0.2)', borderColor: '#7B1FA2', borderWidth: 1.5, borderRadius: 3 },
        { label: 'Brand', data: ads.map(r => r.byBU?.[bu]?.brandCost || 0), backgroundColor: 'rgba(245,166,35,0.2)', borderColor: '#F5A623', borderWidth: 1.5, borderRadius: 3 },
      ],
    },
    options: { ...chartOptions('EUR'), scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true, beginAtZero: true, grid: { color: 'rgba(0,0,0,0.04)' } } } },
  });

  const productTotals = {};
  for (const row of ads) {
    for (const [prod, cost] of Object.entries(row.byProduct || {})) {
      if (getBU(prod) !== bu) continue;
      productTotals[prod] = (productTotals[prod] || 0) + cost;
    }
  }
  const products = Object.keys(productTotals).sort((a, b) => productTotals[b] - productTotals[a]);
  const prodColors = ['#1A7B6B', '#F5A623', '#7B1FA2', '#005a50', '#2E7D32', '#E65100', '#0061FF', '#8899A6'];
  destroyChart('adProductChart');
  charts.adProductChart = new Chart(document.getElementById('adProductChart'), {
    type: 'doughnut',
    data: {
      labels: products,
      datasets: [{
        data: products.map(p => Math.round(productTotals[p])),
        backgroundColor: products.map((_, i) => prodColors[i % prodColors.length]),
        borderWidth: 0,
      }],
    },
    options: doughnutOptions(),
  });
}

// ===== CHART HELPERS =====
function chartOptions(prefix) {
  return {
    responsive: true, maintainAspectRatio: false,
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: { position: 'top', labels: { usePointStyle: true, pointStyleWidth: 10, font: { size: 11, family: '"Plus Jakarta Sans"', weight: 500 }, padding: 16 } },
      tooltip: {
        backgroundColor: '#0F1419',
        titleFont: { family: '"Plus Jakarta Sans"', size: 12, weight: 600 },
        bodyFont: { family: '"Plus Jakarta Sans"', size: 11 },
        cornerRadius: 8,
        padding: 10,
        callbacks: {
          label: ctx => {
            const val = typeof ctx.raw === 'number' ? (prefix ? `${prefix} ${ctx.raw.toLocaleString()}` : ctx.raw.toLocaleString()) : ctx.raw;
            return ` ${ctx.dataset.label}: ${val}`;
          },
        },
      },
    },
    scales: {
      x: { grid: { display: false }, ticks: { font: { size: 11, family: '"Plus Jakarta Sans"' } } },
      y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { size: 11, family: '"Plus Jakarta Sans"' } } },
    },
  };
}

function doughnutOptions() {
  return {
    responsive: true, maintainAspectRatio: false,
    cutout: '65%',
    plugins: {
      legend: { position: 'right', labels: { font: { size: 11, family: '"Plus Jakarta Sans"', weight: 500 }, padding: 12, usePointStyle: true, pointStyleWidth: 8 } },
      tooltip: {
        backgroundColor: '#0F1419',
        titleFont: { family: '"Plus Jakarta Sans"', size: 12, weight: 600 },
        bodyFont: { family: '"Plus Jakarta Sans"', size: 11 },
        cornerRadius: 8,
        callbacks: { label: ctx => ` ${ctx.label}: ${fmt.currency(ctx.raw)}` },
      },
    },
  };
}

function destroyChart(id) {
  if (charts[id]) { charts[id].destroy(); delete charts[id]; }
}

// ===== EVENTS =====
document.getElementById('dateRange').addEventListener('change', () => { if (DATA) render(); });

loadData();
</script>
</body>
</html>
